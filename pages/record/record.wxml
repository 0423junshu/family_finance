<!-- pages/record/record.wxml -->
<navigation-bar 
  title="{{mode === 'create' ? 'è®°ä¸€ç¬”' : 'ç¼–è¾‘è®°å½•'}}" 
  show-back="{{true}}" 
  show-hide-amount="{{true}}"
/>

<view class="page-container">
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>
  
  <view wx:else class="content">
    <!-- äº¤æ˜“ç±»å‹åˆ‡æ¢ -->
    <view class="type-tabs">
      <view 
        class="type-tab {{formData.type === 'expense' ? 'active' : ''}}"
        data-type="expense"
        bindtap="onTypeChange"
      >
        <text class="type-icon">ğŸ’¸</text>
        <text>æ”¯å‡º</text>
      </view>
      <view 
        class="type-tab {{formData.type === 'income' ? 'active' : ''}}"
        data-type="income"
        bindtap="onTypeChange"
      >
        <text class="type-icon">ğŸ’°</text>
        <text>æ”¶å…¥</text>
      </view>
      <view 
        class="type-tab {{formData.type === 'transfer' ? 'active' : ''}}"
        data-type="transfer"
        bindtap="onTypeChange"
      >
        <text class="type-icon">ğŸ”„</text>
        <text>è½¬è´¦</text>
      </view>
    </view>

    <!-- è¡¨å•å†…å®¹ -->
    <view class="form-container">
      <!-- é‡‘é¢è¾“å…¥ -->
      <view class="form-section amount-section">
        <view class="amount-input-container">
          <text class="currency-symbol">Â¥</text>
          <input 
            class="amount-input {{errors.amount ? 'error' : ''}}"
            type="digit"
            placeholder="0.00"
            value="{{hideAmount ? '***' : formData.amount}}"
            bindinput="onAmountInput"
            bindfocus="onAmountFocus"
            bindblur="onAmountBlur"
            confirm-type="done"
            cursor-spacing="50"
          />
        </view>
        <view wx:if="{{errors.amount}}" class="error-text">{{errors.amount}}</view>
      </view>

      <!-- åˆ†ç±»é€‰æ‹© -->
      <view class="form-item" bindtap="onCategoryTap">
        <view class="form-label">
          <text class="form-icon">ğŸ“‚</text>
          <text>åˆ†ç±»</text>
        </view>
        <view class="form-value">
          <view wx:if="{{selectedCategory}}" class="selected-category">
            <text class="category-icon">{{selectedCategory.icon}}</text>
            <text class="selected-text">{{selectedCategory.name}}</text>
          </view>
          <text wx:else class="placeholder-text">è¯·é€‰æ‹©åˆ†ç±»</text>
          <text class="arrow-icon">â€º</text>
        </view>
      </view>
      <view wx:if="{{errors.categoryId}}" class="error-text">{{errors.categoryId}}</view>

      <!-- è´¦æˆ·é€‰æ‹© -->
      <view class="form-item" bindtap="onAccountTap">
        <view class="form-label">
          <text class="form-icon">ğŸ’³</text>
          <text wx:if="{{formData.type === 'transfer'}}">è½¬å‡ºè´¦æˆ·</text>
          <text wx:else>è´¦æˆ·</text>
        </view>
        <view class="form-value">
          <view wx:if="{{selectedAccount}}" class="selected-account">
            <text class="account-icon">{{selectedAccount.icon}}</text>
            <text class="selected-text">{{selectedAccount.name}}</text>
          </view>
          <text wx:else class="placeholder-text">è¯·é€‰æ‹©è´¦æˆ·</text>
          <text class="arrow-icon">â€º</text>
        </view>
      </view>
      <view wx:if="{{errors.accountId}}" class="error-text">{{errors.accountId}}</view>

      <!-- è½¬è´¦ç›®æ ‡è´¦æˆ· -->
      <view wx:if="{{formData.type === 'transfer'}}" class="form-item" bindtap="onTargetAccountTap">
        <view class="form-label">
          <text class="form-icon">ğŸ’³</text>
          <text>è½¬å…¥è´¦æˆ·</text>
        </view>
        <view class="form-value">
          <view wx:if="{{selectedTargetAccount}}" class="selected-account">
            <text class="account-icon">{{selectedTargetAccount.icon}}</text>
            <text class="selected-text">{{selectedTargetAccount.name}}</text>
          </view>
          <text wx:else class="placeholder-text">è¯·é€‰æ‹©è´¦æˆ·</text>
          <text class="arrow-icon">â€º</text>
        </view>
      </view>
      <view wx:if="{{errors.targetAccountId}}" class="error-text">{{errors.targetAccountId}}</view>

      <!-- æ—¥æœŸé€‰æ‹© -->
      <view class="form-item">
        <view class="form-label">
          <text class="form-icon">ğŸ“…</text>
          <text>æ—¥æœŸ</text>
        </view>
        <view class="form-value">
          <picker mode="date" value="{{formData.date}}" bindchange="onDateChange">
            <text class="selected-text">{{formData.date}}</text>
          </picker>
        </view>
      </view>

      <!-- å¤‡æ³¨è¾“å…¥ -->
      <view class="form-item">
        <view class="form-label">
          <text class="form-icon">ğŸ“</text>
          <text>å¤‡æ³¨</text>
        </view>
        <view class="form-value">
          <input 
            class="note-input"
            placeholder="æ·»åŠ å¤‡æ³¨"
            value="{{formData.description}}"
            bindinput="onDescriptionInput"
            maxlength="100"
          />
        </view>
      </view>

      <!-- æ ‡ç­¾é€‰æ‹© -->
      <view class="form-item" bindtap="onTagTap">
        <view class="form-label">
          <text class="form-icon">ğŸ·ï¸</text>
          <text>æ ‡ç­¾</text>
        </view>
        <view class="form-value">
          <view wx:if="{{selectedTags.length > 0}}" class="tags-container">
            <text 
              wx:for="{{selectedTags}}" 
              wx:key="_id" 
              class="tag tag-primary"
            >
              {{item.name}}
            </text>
          </view>
          <text wx:else class="placeholder-text">æ·»åŠ æ ‡ç­¾</text>
          <text class="arrow-icon">â€º</text>
        </view>
      </view>

      <!-- å›¾ç‰‡ä¸Šä¼  -->
      <view class="form-item">
        <view class="form-label">
          <text class="form-icon">ğŸ“·</text>
          <text>å›¾ç‰‡</text>
        </view>
        <view class="form-value">
          <view class="images-container">
            <view 
              wx:for="{{formData.images}}" 
              wx:key="*this" 
              class="image-item"
            >
              <image class="uploaded-image" src="{{item}}" mode="aspectFill" />
              <view class="image-delete" data-index="{{index}}" bindtap="onImageDelete">
                <text class="delete-icon">Ã—</text>
              </view>
            </view>
            
            <view wx:if="{{formData.images.length < 3}}" class="add-image-btns">
              <view class="add-btn" bindtap="onImageTap">
                <text class="add-icon">ğŸ“</text>
                <text class="add-text">ç›¸å†Œ</text>
              </view>
              <view class="add-btn" bindtap="onCameraTap">
                <text class="camera-icon">ğŸ“·</text>
                <text class="add-text">æ‹ç…§</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ä½ç½®ä¿¡æ¯ -->
      <view class="form-item" bindtap="onLocationTap">
        <view class="form-label">
          <text class="form-icon">ğŸ“</text>
          <text>ä½ç½®</text>
        </view>
        <view class="form-value">
          <text wx:if="{{formData.location}}" class="selected-text">å·²è·å–ä½ç½®</text>
          <text wx:else class="placeholder-text">è·å–å½“å‰ä½ç½®</text>
          <text class="arrow-icon">â€º</text>
        </view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view class="submit-container">
      <button 
        class="btn btn-primary btn-large {{submitting ? 'btn-disabled' : ''}}"
        bindtap="onSubmit"
        disabled="{{submitting}}"
      >
        <text wx:if="{{submitting}}">ä¿å­˜ä¸­...</text>
        <text wx:elif="{{mode === 'create'}}">ä¿å­˜</text>
        <text wx:else>æ›´æ–°</text>
      </button>
    </view>
  </view>

  <!-- åˆ†ç±»é€‰æ‹©å™¨ -->
  <view wx:if="{{showCategoryPicker}}" class="picker-overlay" bindtap="onPickerClose">
    <view class="picker-container" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©åˆ†ç±»</text>
        <view class="picker-actions">
          <view class="add-category-btn" bindtap="onAddCategoryTap">
            <text class="add-icon">+</text>
            <text>æ–°å¢</text>
          </view>
          <view class="picker-close" bindtap="onPickerClose">
            <text class="close-icon">Ã—</text>
          </view>
        </view>
      </view>
      <view class="picker-content">
        <scroll-view class="categories-scroll" scroll-y="true">
          <view class="categories-grid">
            <view 
              wx:for="{{categories}}" 
              wx:key="_id"
              wx:if="{{item.type === formData.type || formData.type === 'transfer'}}"
              class="category-item {{item._id === formData.categoryId ? 'selected' : ''}}"
              data-id="{{item._id}}"
              bindtap="onCategorySelect"
            >
              <text class="category-icon" style="color: {{item.color}}">{{item.icon}}</text>
              <text class="category-name">{{item.name}}</text>
              <view wx:if="{{item._id === formData.categoryId}}" class="check-mark">
                <text class="check-icon">âœ“</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- æ–°å¢åˆ†ç±»å¯¹è¯æ¡† -->
  <view wx:if="{{showAddCategoryDialog}}" class="dialog-overlay" bindtap="cancelAddCategory">
    <view class="dialog-container" catchtap="">
      <view class="dialog-header">
        <text class="dialog-title">æ–°å¢åˆ†ç±»</text>
        <view class="dialog-close" bindtap="cancelAddCategory">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      <view class="dialog-content">
        <!-- åˆ†ç±»åç§°è¾“å…¥ -->
        <view class="dialog-item">
          <text class="dialog-label">åˆ†ç±»åç§°</text>
          <input 
            class="dialog-input"
            placeholder="è¯·è¾“å…¥åˆ†ç±»åç§°"
            value="{{newCategory.name}}"
            bindinput="onNewCategoryNameInput"
            maxlength="10"
          />
        </view>
        
        <!-- å›¾æ ‡é€‰æ‹© -->
        <view class="dialog-item">
          <text class="dialog-label">é€‰æ‹©å›¾æ ‡</text>
          <view class="icon-grid">
            <view 
              wx:for="{{['ğŸ’°', 'ğŸ½ï¸', 'ğŸš—', 'ğŸ›’', 'ğŸ¬', 'ğŸ¥', 'ğŸ“š', 'ğŸ ', 'ğŸ“±', 'âš¡', 'ğŸ', 'ğŸ’¼', 'ğŸ§§', 'â†©ï¸', 'ğŸ“ˆ', 'ğŸ’', 'ğŸ¯', 'ğŸ¨']}}"
              wx:key="*this"
              class="icon-item {{newCategory.icon === item ? 'selected' : ''}}"
              data-icon="{{item}}"
              bindtap="onCategoryIconSelect"
            >
              <text class="icon-text">{{item}}</text>
            </view>
          </view>
        </view>
        
        <!-- é¢œè‰²é€‰æ‹© -->
        <view class="dialog-item">
          <text class="dialog-label">é€‰æ‹©é¢œè‰²</text>
          <view class="color-grid">
            <view 
              wx:for="{{['#007AFF', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFB6C1', '#87CEEB', '#32CD32', '#FFD700', '#00CED1', '#9370DB', '#FF69B4', '#20B2AA', '#808080']}}"
              wx:key="*this"
              class="color-item {{newCategory.color === item ? 'selected' : ''}}"
              style="background-color: {{item}}"
              data-color="{{item}}"
              bindtap="onCategoryColorSelect"
            >
              <view wx:if="{{newCategory.color === item}}" class="color-check">
                <text class="check-icon">âœ“</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      <view class="dialog-actions">
        <button class="btn btn-secondary" bindtap="cancelAddCategory">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="saveNewCategory">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- è´¦æˆ·é€‰æ‹©å™¨ -->
  <view wx:if="{{showAccountPicker}}" class="picker-overlay" bindtap="onPickerClose">
    <view class="picker-container" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©è´¦æˆ·</text>
        <view class="picker-close" bindtap="onPickerClose">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      <view class="picker-content">
        <view 
          wx:for="{{accounts}}" 
          wx:key="_id"
          class="account-picker-item {{(item._id === formData.accountId && currentPickerType !== 'targetAccount') || (item._id === formData.targetAccountId && currentPickerType === 'targetAccount') ? 'selected' : ''}}"
          data-id="{{item._id}}"
          bindtap="onAccountSelect"
        >
          <view class="account-info">
            <view class="account-main">
              <text class="account-icon">{{item.icon}}</text>
              <text class="account-name">{{item.name}}</text>
            </view>
            <view class="account-balance">
              <text wx:if="{{hideAmount}}">ä½™é¢: ***</text>
              <text wx:else>ä½™é¢: Â¥{{item.balanceDisplay}}</text>
            </view>
          </view>
          <view wx:if="{{(item._id === formData.accountId && currentPickerType !== 'targetAccount') || (item._id === formData.targetAccountId && currentPickerType === 'targetAccount')}}" class="check-mark">
            <text class="check-icon">âœ“</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é€‰æ‹©å™¨ -->
  <view wx:if="{{showTagPicker}}" class="picker-overlay" bindtap="onPickerClose">
    <view class="picker-container" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©æ ‡ç­¾</text>
        <view class="picker-close" bindtap="onPickerClose">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      <view class="picker-content">
        <view class="tags-grid">
          <view 
            wx:for="{{tags}}" 
            wx:key="_id"
            class="tag-item {{formData.tags.includes(item._id) ? 'selected' : ''}}"
            data-id="{{item._id}}"
            bindtap="onTagSelect"
          >
            <text>{{item.name}}</text>
            <view wx:if="{{formData.tags.includes(item._id)}}" class="tag-check">
              <text class="check-icon">âœ“</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>