<!-- pages/history-detail/history-detail.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="历史记录详情" showBack="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
  
  <view wx:else class="content">
    <!-- 月份选择器 -->
    <view class="date-selector" bindtap="showDatePicker">
      <view class="date-display">
        <text class="date-text">{{selectedYear}}年{{selectedMonth}}月</text>
        <text class="date-arrow">▼</text>
      </view>
      
      <!-- 周期信息 -->
      <view class="cycle-info" wx:if="{{cycleSettings.customCycleEnabled}}">
        <text class="cycle-text">自定义周期: {{startDate}} 至 {{endDate}}</text>
      </view>
    </view>
    
    <!-- 月度统计 -->
    <view class="stats-card">
      <view class="stats-item">
        <text class="stats-label">收入</text>
        <text class="stats-value income">{{monthlyStats.incomeDisplay}}</text>
      </view>
      <view class="stats-item">
        <text class="stats-label">支出</text>
        <text class="stats-value expense">{{monthlyStats.expenseDisplay}}</text>
      </view>
      <view class="stats-item">
        <text class="stats-label">结余</text>
        <text class="stats-value {{monthlyStats.balance >= 0 ? 'income' : 'expense'}}">{{monthlyStats.balanceDisplay}}</text>
      </view>
      <view class="stats-item">
        <text class="stats-label">笔数</text>
        <text class="stats-value">{{monthlyStats.transactionCount}}</text>
      </view>
    </view>
    
    <!-- 筛选器 -->
    <view class="filter-bar">
      <view class="filter-item {{activeFilter === 'all' ? 'active' : ''}}" data-filter="all" bindtap="onFilterChange">全部</view>
      <view class="filter-item {{activeFilter === 'expense' ? 'active' : ''}}" data-filter="expense" bindtap="onFilterChange">支出</view>
      <view class="filter-item {{activeFilter === 'income' ? 'active' : ''}}" data-filter="income" bindtap="onFilterChange">收入</view>
      <view class="filter-item {{activeFilter === 'transfer' ? 'active' : ''}}" data-filter="transfer" bindtap="onFilterChange">转账</view>
    </view>
    
    <!-- 交易记录列表 -->
    <view class="transaction-list">
      <block wx:if="{{groupedTransactions.length === 0}}">
        <view class="empty-state">
          <text class="empty-text">暂无记录</text>
        </view>
      </block>
      
      <block wx:for="{{groupedTransactions}}" wx:key="date">
        <view class="date-group">
          <view class="date-header">
            <view class="date-info">
              <text class="date">{{item.dateDisplay}}</text>
              <text class="weekday">{{item.weekday}}</text>
            </view>
            <view class="date-summary">
              <text class="income">收入: {{item.dayIncomeDisplay}}</text>
              <text class="expense">支出: {{item.dayExpenseDisplay}}</text>
            </view>
          </view>
          
          <view class="transactions">
            <view 
              wx:for="{{item.transactions}}" 
              wx:for-item="transaction" 
              wx:key="id"
              class="transaction-item"
              data-transaction="{{transaction}}"
              bindtap="onTransactionTap"
              bindlongpress="onTransactionLongPress"
            >
              <view class="transaction-icon-container">
                <text class="transaction-icon">{{transaction.icon || (transaction.type === 'income' ? '💰' : transaction.type === 'expense' ? '🛒' : '🔄')}}</text>
              </view>
              
              <view class="transaction-content">
                <view class="transaction-main">
                  <text class="transaction-category">{{transaction.category}}</text>
                  <text class="transaction-amount {{transaction.type === 'income' ? 'income' : transaction.type === 'expense' ? 'expense' : 'transfer'}}">
                    {{transaction.type === 'income' ? '+' : transaction.type === 'expense' ? '-' : ''}}{{transaction.amountDisplay}}
                  </text>
                </view>
                
                <view class="transaction-sub">
                  <view class="transaction-details">
                    <text class="transaction-account">{{transaction.account}}</text>
                    <text wx:if="{{transaction.type === 'transfer'}}" class="transaction-transfer-arrow">→</text>
                    <text wx:if="{{transaction.type === 'transfer'}}" class="transaction-target-account">{{transaction.targetAccount}}</text>
                    <text wx:if="{{transaction.description}}" class="transaction-description">{{transaction.description}}</text>
                  </view>
                  <text class="transaction-time">{{transaction.timeDisplay}}</text>
                </view>
                
                <!-- 标签 -->
                <view class="transaction-tags" wx:if="{{transaction.tags && transaction.tags.length > 0}}">
                  <view wx:for="{{transaction.tags}}" wx:for-item="tag" wx:key="*this" class="tag">{{tag}}</view>
                </view>
              </view>
              
              <view class="transaction-actions">
                <view class="action-btn edit" catchtap="onEditTransaction" data-transaction="{{transaction}}">
                  <text class="action-icon">✏️</text>
                </view>
                <view class="action-btn delete" catchtap="onDeleteTransaction" data-transaction="{{transaction}}">
                  <text class="action-icon">🗑️</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>
  
  <!-- 日期选择器弹窗 -->
  <view wx:if="{{showDatePicker}}" class="picker-overlay" catchtap="closeDatePicker">
    <view class="picker-container" catchtap="noop">
      <view class="picker-header">
        <text class="picker-title">选择月份</text>
        <view class="picker-close" catchtap="closeDatePicker">×</view>
      </view>
      
      <view class="picker-content">
        <picker-view class="year-picker" indicator-style="height: 40px;" value="{{[years.indexOf(`${selectedYear}年`)]}}" bindchange="onYearChange">
          <picker-view-column>
            <view wx:for="{{years}}" wx:key="*this" class="picker-item">{{item}}</view>
          </picker-view-column>
        </picker-view>
        
        <picker-view class="month-picker" indicator-style="height: 40px;" value="{{[selectedMonth - 1]}}" bindchange="onMonthChange">
          <picker-view-column>
            <view wx:for="{{months}}" wx:key="*this" class="picker-item">{{item}}</view>
          </picker-view-column>
        </picker-view>
      </view>
      
      <view class="picker-actions">
        <button class="btn btn-cancel" catchtap="closeDatePicker">取消</button>
        <button class="btn btn-confirm" catchtap="confirmDatePicker">确定</button>
      </view>
    </view>
  </view>
</view>