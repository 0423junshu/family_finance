<!-- pages/history-detail/history-detail.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="å†å²è®°å½•è¯¦æƒ…" showBack="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <view wx:else class="content">
    <!-- æœˆä»½é€‰æ‹©å™¨ -->
    <view class="date-selector" bindtap="showDatePicker">
      <view class="date-display">
        <text class="date-text">{{selectedYear}}å¹´{{selectedMonth}}æœˆ</text>
        <text class="date-arrow">â–¼</text>
      </view>
      
      <!-- å‘¨æœŸä¿¡æ¯ -->
      <view class="cycle-info" wx:if="{{cycleSettings.customCycleEnabled}}">
        <text class="cycle-text">è‡ªå®šä¹‰å‘¨æœŸ: {{startDate}} è‡³ {{endDate}}</text>
      </view>
    </view>
    
    <!-- æœˆåº¦ç»Ÿè®¡ -->
    <view class="stats-card">
      <view class="stats-item">
        <text class="stats-label">æ”¶å…¥</text>
        <text class="stats-value income">{{monthlyStats.incomeDisplay}}</text>
      </view>
      <view class="stats-item">
        <text class="stats-label">æ”¯å‡º</text>
        <text class="stats-value expense">{{monthlyStats.expenseDisplay}}</text>
      </view>
      <view class="stats-item">
        <text class="stats-label">ç»“ä½™</text>
        <text class="stats-value {{monthlyStats.balance >= 0 ? 'income' : 'expense'}}">{{monthlyStats.balanceDisplay}}</text>
      </view>
      <view class="stats-item">
        <text class="stats-label">ç¬”æ•°</text>
        <text class="stats-value">{{monthlyStats.transactionCount}}</text>
      </view>
    </view>
    
    <!-- ç­›é€‰å™¨ -->
    <view class="filter-bar">
      <view class="filter-item {{activeFilter === 'all' ? 'active' : ''}}" data-filter="all" bindtap="onFilterChange">å…¨éƒ¨</view>
      <view class="filter-item {{activeFilter === 'expense' ? 'active' : ''}}" data-filter="expense" bindtap="onFilterChange">æ”¯å‡º</view>
      <view class="filter-item {{activeFilter === 'income' ? 'active' : ''}}" data-filter="income" bindtap="onFilterChange">æ”¶å…¥</view>
      <view class="filter-item {{activeFilter === 'transfer' ? 'active' : ''}}" data-filter="transfer" bindtap="onFilterChange">è½¬è´¦</view>
    </view>
    
    <!-- äº¤æ˜“è®°å½•åˆ—è¡¨ -->
    <view class="transaction-list">
      <block wx:if="{{groupedTransactions.length === 0}}">
        <view class="empty-state">
          <text class="empty-text">æš‚æ— è®°å½•</text>
        </view>
      </block>
      
      <block wx:for="{{groupedTransactions}}" wx:key="date">
        <view class="date-group">
          <view class="date-header">
            <view class="date-info">
              <text class="date">{{item.dateDisplay}}</text>
              <text class="weekday">{{item.weekday}}</text>
            </view>
            <view class="date-summary">
              <text class="income">æ”¶å…¥: {{item.dayIncomeDisplay}}</text>
              <text class="expense">æ”¯å‡º: {{item.dayExpenseDisplay}}</text>
            </view>
          </view>
          
          <view class="transactions">
            <view 
              wx:for="{{item.transactions}}" 
              wx:for-item="transaction" 
              wx:key="id"
              class="transaction-item"
              data-transaction="{{transaction}}"
              bindtap="onTransactionTap"
              bindlongpress="onTransactionLongPress"
            >
              <view class="transaction-icon-container">
                <text class="transaction-icon">{{transaction.icon || (transaction.type === 'income' ? 'ğŸ’°' : transaction.type === 'expense' ? 'ğŸ›’' : 'ğŸ”„')}}</text>
              </view>
              
              <view class="transaction-content">
                <view class="transaction-main">
                  <text class="transaction-category">{{transaction.category}}</text>
                  <text class="transaction-amount {{transaction.type === 'income' ? 'income' : transaction.type === 'expense' ? 'expense' : 'transfer'}}">
                    {{transaction.type === 'income' ? '+' : transaction.type === 'expense' ? '-' : ''}}{{transaction.amountDisplay}}
                  </text>
                </view>
                
                <view class="transaction-sub">
                  <view class="transaction-details">
                    <text class="transaction-account">{{transaction.account}}</text>
                    <text wx:if="{{transaction.type === 'transfer'}}" class="transaction-transfer-arrow">â†’</text>
                    <text wx:if="{{transaction.type === 'transfer'}}" class="transaction-target-account">{{transaction.targetAccount}}</text>
                    <text wx:if="{{transaction.description}}" class="transaction-description">{{transaction.description}}</text>
                  </view>
                  <text class="transaction-time">{{transaction.timeDisplay}}</text>
                </view>
                
                <!-- æ ‡ç­¾ -->
                <view class="transaction-tags" wx:if="{{transaction.tags && transaction.tags.length > 0}}">
                  <view wx:for="{{transaction.tags}}" wx:for-item="tag" wx:key="*this" class="tag">{{tag}}</view>
                </view>
              </view>
              
              <view class="transaction-actions">
                <view class="action-btn edit" catchtap="onEditTransaction" data-transaction="{{transaction}}">
                  <text class="action-icon">âœï¸</text>
                </view>
                <view class="action-btn delete" catchtap="onDeleteTransaction" data-transaction="{{transaction}}">
                  <text class="action-icon">ğŸ—‘ï¸</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>
  
  <!-- æ—¥æœŸé€‰æ‹©å™¨å¼¹çª— -->
  <view wx:if="{{showDatePicker}}" class="picker-overlay" catchtap="closeDatePicker">
    <view class="picker-container" catchtap="noop">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©æœˆä»½</text>
        <view class="picker-close" catchtap="closeDatePicker">Ã—</view>
      </view>
      
      <view class="picker-content">
        <picker-view class="year-picker" indicator-style="height: 40px;" value="{{[years.indexOf(`${selectedYear}å¹´`)]}}" bindchange="onYearChange">
          <picker-view-column>
            <view wx:for="{{years}}" wx:key="*this" class="picker-item">{{item}}</view>
          </picker-view-column>
        </picker-view>
        
        <picker-view class="month-picker" indicator-style="height: 40px;" value="{{[selectedMonth - 1]}}" bindchange="onMonthChange">
          <picker-view-column>
            <view wx:for="{{months}}" wx:key="*this" class="picker-item">{{item}}</view>
          </picker-view-column>
        </picker-view>
      </view>
      
      <view class="picker-actions">
        <button class="btn btn-cancel" catchtap="closeDatePicker">å–æ¶ˆ</button>
        <button class="btn btn-confirm" catchtap="confirmDatePicker">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>