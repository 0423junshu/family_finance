<!-- pages/transaction-list/transaction-list.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="äº¤æ˜“è®°å½•" showBack="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- Material Design ç»Ÿè®¡å¡ç‰‡ -->
  <view class="md-stats-container">
    <view class="md-stats-card">
      <view class="md-stats-header">
        <view style="display: flex; align-items: center; justify-content: space-between;">
          <text class="md-stats-title">è´¢åŠ¡æ¦‚è§ˆ</text>
          <eye-toggle visible="{{pageMoneyVisible}}" bind:change="onEyeChange" />
        </view>
        <text class="md-stats-subtitle">{{statsSubtitle || 'æœ¬æœˆæ•°æ®'}}</text>
      </view>
      <view class="md-stats-grid">
        <view class="md-stat-item md-stat-income">
          <view class="md-stat-icon">
            <text class="md-icon">â†—</text>
          </view>
          <view class="md-stat-content">
            <text class="md-stat-label">æ”¶å…¥</text>
            <text class="md-stat-value">
              <block wx:if="{{pageMoneyVisible}}">Â¥{{totalIncome}}</block>
              <block wx:else>***</block>
            </text>
          </view>
        </view>
        <view class="md-stat-item md-stat-expense">
          <view class="md-stat-icon">
            <text class="md-icon">â†™</text>
          </view>
          <view class="md-stat-content">
            <text class="md-stat-label">æ”¯å‡º</text>
            <text class="md-stat-value">
              <block wx:if="{{pageMoneyVisible}}">Â¥{{totalExpense}}</block>
              <block wx:else>***</block>
            </text>
          </view>
        </view>
        <view class="md-stat-item md-stat-balance">
          <view class="md-stat-icon">
            <text class="md-icon">â‰ˆ</text>
          </view>
          <view class="md-stat-content">
            <text class="md-stat-label">ç»“ä½™</text>
            <text class="md-stat-value {{netAmount >= 0 ? 'positive' : 'negative'}}">
              <block wx:if="{{pageMoneyVisible}}">Â¥{{netAmount}}</block>
              <block wx:else>***</block>
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç§»é™¤æ—¶é—´é€‰æ‹©å™¨ï¼Œé‡‡ç”¨æ›´ç®€æ´çš„è®¾è®¡ -->
  


  <!-- Material Design æ“ä½œæ  -->
  <view class="md-action-bar">
    <view class="md-action-chip" bindtap="showFilterPanel" aria-label="ç­›é€‰äº¤æ˜“è®°å½•">
      <text class="md-chip-icon">âš™</text>
      <text class="md-chip-text">ç­›é€‰</text>
    </view>
    <view class="md-action-chip" bindtap="exportData" aria-label="å¯¼å‡ºæ•°æ®">
      <text class="md-chip-icon">â†—</text>
      <text class="md-chip-text">å¯¼å‡º</text>
    </view>
  </view>

  <!-- äº¤æ˜“åˆ—è¡¨ -->
  <view class="content">
    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{filteredTransactions.length === 0}}" class="empty-container">
      <image class="empty-icon" src="/images/empty-transaction.png" />
      <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
      <button class="btn btn-primary" bindtap="resetFilters">é‡ç½®ç­›é€‰</button>
    </view>

    <!-- äº¤æ˜“åˆ—è¡¨ -->
    <view wx:else class="transaction-list">
      <view 
        wx:for="{{filteredTransactions}}" 
        wx:key="id"
        class="transaction-item"
        bindtap="viewTransactionDetail"
        data-id="{{item.id}}"
      >
        <view class="transaction-icon">
          <text class="category-emoji">{{item.categoryIcon}}</text>
        </view>
        <view class="transaction-info">
          <view class="transaction-title">{{item.category}}</view>
          <view class="transaction-meta">
            <text class="transaction-date">{{item.formattedDate}}</text>
            <text wx:if="{{item.account}}" class="transaction-account">{{item.account}}</text>
          </view>
          <view wx:if="{{item.description}}" class="transaction-description">{{item.description}}</view>
        </view>
        <view class="transaction-amount {{item.type === 'income' ? 'income' : 'expense'}}">
          <text class="amount {{item.type === 'income' ? 'income' : 'expense'}}">
            <block wx:if="{{pageMoneyVisible}}">
              {{item.type === 'income' ? '+' : '-'}}{{item.formattedAmount}}
            </block>
            <block wx:else>***</block>
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilterPanel}}" class="filter-overlay" bindtap="hideFilterPanel">
    <view class="filter-panel" catchtap="noop">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <view class="filter-actions">
          <text class="filter-reset" bindtap="resetFilters">é‡ç½®</text>
          <text class="filter-close" bindtap="hideFilterPanel">å®Œæˆ</text>
        </view>
      </view>

      <scroll-view class="filter-content" scroll-y>
        <!-- ç±»å‹ç­›é€‰ -->
        <view class="filter-section">
          <text class="filter-section-title">äº¤æ˜“ç±»å‹</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filters.type === 'all' ? 'active' : ''}}"
              data-type="all"
              bindtap="onTypeFilter"
            >
              <text>å…¨éƒ¨</text>
            </view>
            <view 
              class="filter-option {{filters.type === 'income' ? 'active' : ''}}"
              data-type="income"
              bindtap="onTypeFilter"
            >
              <text>æ”¶å…¥</text>
            </view>
            <view 
              class="filter-option {{filters.type === 'expense' ? 'active' : ''}}"
              data-type="expense"
              bindtap="onTypeFilter"
            >
              <text>æ”¯å‡º</text>
            </view>
          </view>
        </view>

        <!-- æ—¥æœŸèŒƒå›´ç­›é€‰ -->
        <view class="filter-section">
          <text class="filter-section-title">æ—¶é—´èŒƒå›´</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filters.dateRange === 'week' ? 'active' : ''}}"
              data-range="week"
              bindtap="onDateRangeFilter"
            >
              <text>æœ¬å‘¨</text>
            </view>
            <view 
              class="filter-option {{filters.dateRange === 'month' ? 'active' : ''}}"
              data-range="month"
              bindtap="onDateRangeFilter"
            >
              <text>æœ¬æœˆ</text>
            </view>

            <view 
              class="filter-option {{filters.dateRange === 'custom' ? 'active' : ''}}"
              data-range="custom"
              bindtap="onDateRangeFilter"
            >
              <text>è‡ªå®šä¹‰</text>
            </view>
          </view>
        </view>

        <!-- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨ - å§‹ç»ˆæ˜¾ç¤ºå½“å‰æ—¥æœŸèŒƒå›´ -->
        <view class="filter-section">
          <text class="filter-section-title">å½“å‰æ—¥æœŸèŒƒå›´</text>
          <view class="date-range-display" style="padding-right: 16rpx;">
            <text class="date-range-text">{{filters.startDate || 'å¼€å§‹æ—¥æœŸ'}} è‡³ {{filters.endDate || 'ç»“æŸæ—¥æœŸ'}}</text>
          </view>
        </view>

        <!-- è‡ªå®šä¹‰æ—¥æœŸ -->
        <view wx:if="{{filters.dateRange === 'custom'}}" class="filter-section">
          <text class="filter-section-title">è‡ªå®šä¹‰æ—¥æœŸè®¾ç½®</text>
          <view class="date-range-picker" style="padding-right: 16rpx;">
            <view class="date-picker-item" data-type="start" bindtap="onCustomDateTap">
              <text class="date-label">å¼€å§‹æ—¥æœŸ</text>
              <text class="date-value">{{filters.startDate}}</text>
            </view>
            <view class="date-picker-item" data-type="end" bindtap="onCustomDateTap">
              <text class="date-label">ç»“æŸæ—¥æœŸ</text>
              <text class="date-value">{{filters.endDate}}</text>
            </view>
          </view>
        </view>

        <!-- åˆ†ç±»ç­›é€‰ - ä¸‹æ‹‰èœå• -->
        <view class="filter-section">
          <text class="filter-section-title">äº¤æ˜“åˆ†ç±»</text>
          <view class="dropdown-selector" bindtap="showCategoryDropdown" style="padding-right: 16rpx;">
            <text class="dropdown-text">{{filters.category === 'all' ? 'å…¨éƒ¨åˆ†ç±»' : filters.category}}</text>
            <text class="dropdown-arrow">â–¼</text>
          </view>
          <view wx:if="{{showCategoryDropdown}}" class="dropdown-options" style="width: 100%; max-height: 50vh; overflow-y: auto; padding-right: 16rpx;">
            <view 
              class="dropdown-option {{filters.category === 'all' ? 'active' : ''}}"
              data-category="all"
              bindtap="onCategorySelect"
            >
              <text>å…¨éƒ¨åˆ†ç±»</text>
            </view>
            <view 
              wx:for="{{categories}}" 
              wx:key="id"
              class="dropdown-option {{filters.category === item.name ? 'active' : ''}}"
              data-category="{{item.name}}"
              bindtap="onCategorySelect"
            >
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- è´¦æˆ·ç­›é€‰ï¼ˆä¸‹æ‹‰å•é€‰ï¼‰ -->
        <view class="filter-section">
          <text class="filter-section-title">è´¦æˆ·ç­›é€‰</text>
          <view wx:if="{{!accounts || accounts.length === 0}}" class="hint-text">æš‚æ— è´¦æˆ·</view>
          <view wx:elif="{{accounts && accounts.length > 0}}">
            <view class="dropdown-selector" bindtap="showAccountDropdown">
              <text class="dropdown-text">{{selectedAccountLabel || 'å…¨éƒ¨è´¦æˆ·'}}</text>
              <text class="dropdown-arrow">â–¼</text>
            </view>
            <view wx:if="{{showAccountDropdown}}" class="dropdown-options">
              <view 
                class="dropdown-option {{(filters.accounts.length === 0) ? 'active' : ''}}"
                data-id="all"
                bindtap="onAccountSelect"
              >
                <text>å…¨éƒ¨è´¦æˆ·</text>
              </view>
              <view 
                wx:for="{{accounts}}" 
                wx:key="id"
                class="dropdown-option {{(filters.accounts.length > 0 && String(filters.accounts[0]) === String(item.id)) ? 'active' : ''}}"
                data-id="{{item.id}}"
                bindtap="onAccountSelect"
              >
                <text>{{item.name}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- æ ‡ç­¾ç­›é€‰ -->
        <view class="filter-section">
          <text class="filter-section-title">æ ‡ç­¾ç­›é€‰</text>
          <view class="dropdown-selector" bindtap="showTagDropdown" style="padding-right: 16rpx;">
            <text class="dropdown-text">{{filters.tag === 'all' ? 'å…¨éƒ¨æ ‡ç­¾' : filters.tag}}</text>
            <text class="dropdown-arrow">â–¼</text>
          </view>
          <view wx:if="{{showTagDropdown}}" class="dropdown-options" style="width: 100%; max-height: 50vh; overflow-y: auto; padding-right: 16rpx;">
            <view 
              class="dropdown-option {{filters.tag === 'all' ? 'active' : ''}}"
              data-tag="all"
              bindtap="onTagSelect"
            >
              <text>å…¨éƒ¨æ ‡ç­¾</text>
            </view>
            <view 
              wx:for="{{availableTags}}" 
              wx:key="*this"
              class="dropdown-option {{filters.tag === item ? 'active' : ''}}"
              data-tag="{{item}}"
              bindtap="onTagSelect"
            >
              <text>{{item}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©å™¨å¼¹çª— - ä¿®å¤æ˜¾ç¤ºå’Œäº¤äº’é—®é¢˜ -->
  <view wx:if="{{showDatePicker}}" class="date-picker-overlay" bindtap="onDatePickerCancel">
    <view class="date-picker-container" catchtap="noop">
      <view class="date-picker-header">
        <text class="date-picker-title">{{datePickerType === 'start' ? 'é€‰æ‹©å¼€å§‹æ—¥æœŸ' : 'é€‰æ‹©ç»“æŸæ—¥æœŸ'}}</text>
        <text class="date-picker-close" bindtap="onDatePickerCancel">Ã—</text>
      </view>
      <view class="date-picker-content">
        <picker 
          mode="date"
          value="{{datePickerType === 'start' ? filters.startDate : filters.endDate}}"
          bindchange="onDateChange"
          class="date-picker-input"
        >
          <view class="date-picker-display">
            <text class="date-picker-text">{{datePickerType === 'start' ? filters.startDate : filters.endDate}}</text>
            <text class="date-picker-arrow">ğŸ“…</text>
          </view>
        </picker>
        <view class="date-picker-buttons">
          <button class="date-picker-btn cancel" bindtap="onDatePickerCancel">å–æ¶ˆ</button>
          <button class="date-picker-btn confirm" bindtap="onDatePickerCancel">ç¡®å®š</button>
        </view>
      </view>
    </view>
  </view>
</view>