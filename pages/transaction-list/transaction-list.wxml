<!-- pages/transaction-list/transaction-list.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="交易记录" showBack="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- Material Design 统计卡片 -->
  <view class="md-stats-container">
    <view class="md-stats-card">
      <view class="md-stats-header">
        <view style="display: flex; align-items: center; justify-content: space-between;">
          <text class="md-stats-title">财务概览</text>
          <eye-toggle visible="{{pageMoneyVisible}}" bind:change="onEyeChange" />
        </view>
        <text class="md-stats-subtitle">{{statsSubtitle || '本月数据'}}</text>
      </view>
      <view class="md-stats-grid">
        <view class="md-stat-item md-stat-income">
          <view class="md-stat-icon">
            <text class="md-icon">↗</text>
          </view>
          <view class="md-stat-content">
            <text class="md-stat-label">收入</text>
            <text class="md-stat-value">
              <block wx:if="{{pageMoneyVisible}}">¥{{totalIncome}}</block>
              <block wx:else>***</block>
            </text>
          </view>
        </view>
        <view class="md-stat-item md-stat-expense">
          <view class="md-stat-icon">
            <text class="md-icon">↙</text>
          </view>
          <view class="md-stat-content">
            <text class="md-stat-label">支出</text>
            <text class="md-stat-value">
              <block wx:if="{{pageMoneyVisible}}">¥{{totalExpense}}</block>
              <block wx:else>***</block>
            </text>
          </view>
        </view>
        <view class="md-stat-item md-stat-balance">
          <view class="md-stat-icon">
            <text class="md-icon">≈</text>
          </view>
          <view class="md-stat-content">
            <text class="md-stat-label">结余</text>
            <text class="md-stat-value {{netAmount >= 0 ? 'positive' : 'negative'}}">
              <block wx:if="{{pageMoneyVisible}}">¥{{netAmount}}</block>
              <block wx:else>***</block>
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 移除时间选择器，采用更简洁的设计 -->
  


  <!-- Material Design 操作栏 -->
  <view class="md-action-bar">
    <view class="md-action-chip" bindtap="showFilterPanel" aria-label="筛选交易记录">
      <text class="md-chip-icon">⚙</text>
      <text class="md-chip-text">筛选</text>
    </view>
    <view class="md-action-chip" bindtap="exportData" aria-label="导出数据">
      <text class="md-chip-icon">↗</text>
      <text class="md-chip-text">导出</text>
    </view>
  </view>

  <!-- 交易列表 -->
  <view class="content">
    <!-- 加载中状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>

    <!-- 空状态 -->
    <view wx:elif="{{filteredTransactions.length === 0}}" class="empty-container">
      <image class="empty-icon" src="/images/empty-transaction.png" />
      <text class="empty-text">暂无交易记录</text>
      <button class="btn btn-primary" bindtap="resetFilters">重置筛选</button>
    </view>

    <!-- 交易列表 -->
    <view wx:else class="transaction-list">
      <view 
        wx:for="{{filteredTransactions}}" 
        wx:key="id"
        class="transaction-item"
        bindtap="viewTransactionDetail"
        data-id="{{item.id}}"
      >
        <view class="transaction-icon">
          <text class="category-emoji">{{item.categoryIcon}}</text>
        </view>
        <view class="transaction-info">
          <view class="transaction-title">{{item.category}}</view>
          <view class="transaction-meta">
            <text class="transaction-date">{{item.formattedDate}}</text>
            <text wx:if="{{item.account}}" class="transaction-account">{{item.account}}</text>
          </view>
          <view wx:if="{{item.description}}" class="transaction-description">{{item.description}}</view>
        </view>
        <view class="transaction-amount {{item.type === 'income' ? 'income' : 'expense'}}">
          <text class="amount {{item.type === 'income' ? 'income' : 'expense'}}">
            <block wx:if="{{pageMoneyVisible}}">
              {{item.type === 'income' ? '+' : '-'}}{{item.formattedAmount}}
            </block>
            <block wx:else>***</block>
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- 筛选面板 -->
  <view wx:if="{{showFilterPanel}}" class="filter-overlay" bindtap="hideFilterPanel">
    <view class="filter-panel" catchtap="noop">
      <view class="filter-header">
        <text class="filter-title">筛选条件</text>
        <view class="filter-actions">
          <text class="filter-reset" bindtap="resetFilters">重置</text>
          <text class="filter-close" bindtap="hideFilterPanel">完成</text>
        </view>
      </view>

      <scroll-view class="filter-content" scroll-y>
        <!-- 类型筛选 -->
        <view class="filter-section">
          <text class="filter-section-title">交易类型</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filters.type === 'all' ? 'active' : ''}}"
              data-type="all"
              bindtap="onTypeFilter"
            >
              <text>全部</text>
            </view>
            <view 
              class="filter-option {{filters.type === 'income' ? 'active' : ''}}"
              data-type="income"
              bindtap="onTypeFilter"
            >
              <text>收入</text>
            </view>
            <view 
              class="filter-option {{filters.type === 'expense' ? 'active' : ''}}"
              data-type="expense"
              bindtap="onTypeFilter"
            >
              <text>支出</text>
            </view>
          </view>
        </view>

        <!-- 日期范围筛选 -->
        <view class="filter-section">
          <text class="filter-section-title">时间范围</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filters.dateRange === 'week' ? 'active' : ''}}"
              data-range="week"
              bindtap="onDateRangeFilter"
            >
              <text>本周</text>
            </view>
            <view 
              class="filter-option {{filters.dateRange === 'month' ? 'active' : ''}}"
              data-range="month"
              bindtap="onDateRangeFilter"
            >
              <text>本月</text>
            </view>

            <view 
              class="filter-option {{filters.dateRange === 'custom' ? 'active' : ''}}"
              data-range="custom"
              bindtap="onDateRangeFilter"
            >
              <text>自定义</text>
            </view>
          </view>
        </view>

        <!-- 自定义日期选择器 - 始终显示当前日期范围 -->
        <view class="filter-section">
          <text class="filter-section-title">当前日期范围</text>
          <view class="date-range-display" style="padding-right: 16rpx;">
            <text class="date-range-text">{{filters.startDate || '开始日期'}} 至 {{filters.endDate || '结束日期'}}</text>
          </view>
        </view>

        <!-- 自定义日期 -->
        <view wx:if="{{filters.dateRange === 'custom'}}" class="filter-section">
          <text class="filter-section-title">自定义日期设置</text>
          <view class="date-range-picker" style="padding-right: 16rpx;">
            <view class="date-picker-item" data-type="start" bindtap="onCustomDateTap">
              <text class="date-label">开始日期</text>
              <text class="date-value">{{filters.startDate}}</text>
            </view>
            <view class="date-picker-item" data-type="end" bindtap="onCustomDateTap">
              <text class="date-label">结束日期</text>
              <text class="date-value">{{filters.endDate}}</text>
            </view>
          </view>
        </view>

        <!-- 分类筛选 - 下拉菜单 -->
        <view class="filter-section">
          <text class="filter-section-title">交易分类</text>
          <view class="dropdown-selector" bindtap="showCategoryDropdown" style="padding-right: 16rpx;">
            <text class="dropdown-text">{{filters.category === 'all' ? '全部分类' : filters.category}}</text>
            <text class="dropdown-arrow">▼</text>
          </view>
          <view wx:if="{{showCategoryDropdown}}" class="dropdown-options" style="width: 100%; max-height: 50vh; overflow-y: auto; padding-right: 16rpx;">
            <view 
              class="dropdown-option {{filters.category === 'all' ? 'active' : ''}}"
              data-category="all"
              bindtap="onCategorySelect"
            >
              <text>全部分类</text>
            </view>
            <view 
              wx:for="{{categories}}" 
              wx:key="id"
              class="dropdown-option {{filters.category === item.name ? 'active' : ''}}"
              data-category="{{item.name}}"
              bindtap="onCategorySelect"
            >
              <text>{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- 账户筛选（下拉单选） -->
        <view class="filter-section">
          <text class="filter-section-title">账户筛选</text>
          <view wx:if="{{!accounts || accounts.length === 0}}" class="hint-text">暂无账户</view>
          <view wx:elif="{{accounts && accounts.length > 0}}">
            <view class="dropdown-selector" bindtap="showAccountDropdown">
              <text class="dropdown-text">{{selectedAccountLabel || '全部账户'}}</text>
              <text class="dropdown-arrow">▼</text>
            </view>
            <view wx:if="{{showAccountDropdown}}" class="dropdown-options">
              <view 
                class="dropdown-option {{(filters.accounts.length === 0) ? 'active' : ''}}"
                data-id="all"
                bindtap="onAccountSelect"
              >
                <text>全部账户</text>
              </view>
              <view 
                wx:for="{{accounts}}" 
                wx:key="id"
                class="dropdown-option {{(filters.accounts.length > 0 && String(filters.accounts[0]) === String(item.id)) ? 'active' : ''}}"
                data-id="{{item.id}}"
                bindtap="onAccountSelect"
              >
                <text>{{item.name}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 标签筛选 -->
        <view class="filter-section">
          <text class="filter-section-title">标签筛选</text>
          <view class="dropdown-selector" bindtap="showTagDropdown" style="padding-right: 16rpx;">
            <text class="dropdown-text">{{filters.tag === 'all' ? '全部标签' : filters.tag}}</text>
            <text class="dropdown-arrow">▼</text>
          </view>
          <view wx:if="{{showTagDropdown}}" class="dropdown-options" style="width: 100%; max-height: 50vh; overflow-y: auto; padding-right: 16rpx;">
            <view 
              class="dropdown-option {{filters.tag === 'all' ? 'active' : ''}}"
              data-tag="all"
              bindtap="onTagSelect"
            >
              <text>全部标签</text>
            </view>
            <view 
              wx:for="{{availableTags}}" 
              wx:key="*this"
              class="dropdown-option {{filters.tag === item ? 'active' : ''}}"
              data-tag="{{item}}"
              bindtap="onTagSelect"
            >
              <text>{{item}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 日期选择器弹窗 - 修复显示和交互问题 -->
  <view wx:if="{{showDatePicker}}" class="date-picker-overlay" bindtap="onDatePickerCancel">
    <view class="date-picker-container" catchtap="noop">
      <view class="date-picker-header">
        <text class="date-picker-title">{{datePickerType === 'start' ? '选择开始日期' : '选择结束日期'}}</text>
        <text class="date-picker-close" bindtap="onDatePickerCancel">×</text>
      </view>
      <view class="date-picker-content">
        <picker 
          mode="date"
          value="{{datePickerType === 'start' ? filters.startDate : filters.endDate}}"
          bindchange="onDateChange"
          class="date-picker-input"
        >
          <view class="date-picker-display">
            <text class="date-picker-text">{{datePickerType === 'start' ? filters.startDate : filters.endDate}}</text>
            <text class="date-picker-arrow">📅</text>
          </view>
        </picker>
        <view class="date-picker-buttons">
          <button class="date-picker-btn cancel" bindtap="onDatePickerCancel">取消</button>
          <button class="date-picker-btn confirm" bindtap="onDatePickerCancel">确定</button>
        </view>
      </view>
    </view>
  </view>
</view>