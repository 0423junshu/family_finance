<!-- pages/reports/reports.wxml -->
<navigation-bar title="è´¢åŠ¡æŠ¥è¡¨" showBack="{{true}}" />

<view class="page-container">
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <view wx:else class="content">
    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <view class="time-selector">
      <view class="time-tabs">
        <view 
          class="time-tab {{dateRange === 'week' ? 'active' : ''}}"
          data-range="week"
          bindtap="onDateRangeChange"
        >
          æœ¬å‘¨
        </view>
        <view 
          class="time-tab {{dateRange === 'month' ? 'active' : ''}}"
          data-range="month"
          bindtap="onDateRangeChange"
        >
          æœ¬æœˆ
        </view>
        <view 
          class="time-tab {{dateRange === 'quarter' ? 'active' : ''}}"
          data-range="quarter"
          bindtap="onDateRangeChange"
        >
          æœ¬å­£
        </view>
        <view 
          class="time-tab {{dateRange === 'year' ? 'active' : ''}}"
          data-range="year"
          bindtap="onDateRangeChange"
        >
          æœ¬å¹´
        </view>
        <view 
          class="time-tab {{dateRange === 'custom' ? 'active' : ''}}"
          bindtap="showCustomDatePicker"
        >
          è‡ªå®šä¹‰
        </view>
      </view>
      
      <!-- å¹´æœˆé€‰æ‹© -->
      <view wx:if="{{dateRange === 'month' || dateRange === 'quarter' || dateRange === 'year'}}" class="date-selector">
        <view class="date-item" bindtap="showYearPicker">
          <text>{{currentYear}}å¹´</text>
          <text class="arrow">â–¼</text>
        </view>
        <view wx:if="{{dateRange === 'month'}}" class="date-item" bindtap="showMonthPicker">
          <text>{{currentMonth + 1}}æœˆ</text>
          <text class="arrow">â–¼</text>
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾é¡µ -->
    <view class="tabs">
      <view 
        class="tab {{currentTab === 0 ? 'active' : ''}}"
        data-index="0"
        bindtap="onTabChange"
      >
        æ”¶æ”¯æ¦‚è§ˆ
      </view>
      <view 
        class="tab {{currentTab === 1 ? 'active' : ''}}"
        data-index="1"
        bindtap="onTabChange"
      >
        åˆ†ç±»ç»Ÿè®¡
      </view>
      <view 
        class="tab {{currentTab === 2 ? 'active' : ''}}"
        data-index="2"
        bindtap="onTabChange"
      >
        è¶‹åŠ¿å›¾
      </view>
      <view 
        class="tab {{currentTab === 3 ? 'active' : ''}}"
        data-index="3"
        bindtap="onTabChange"
      >
        èµ„äº§åˆ†æ
      </view>
      <view 
        class="tab {{currentTab === 4 ? 'active' : ''}}"
        data-index="4"
        bindtap="onTabChange"
      >
        æ ‡ç­¾ç»Ÿè®¡
      </view>
    </view>

    <!-- æ”¶æ”¯æ¦‚è§ˆ -->
    <view wx:if="{{currentTab === 0}}" class="overview-content">
      <view class="summary-card">
        <view class="summary-item income">
          <text class="label">æ€»æ”¶å…¥</text>
          <text class="amount">+{{summary.totalIncomeDisplay}}</text>
        </view>
        <view class="summary-item expense">
          <text class="label">æ€»æ”¯å‡º</text>
          <text class="amount">-{{summary.totalExpenseDisplay}}</text>
        </view>
        <view class="summary-item balance">
          <text class="label">ç»“ä½™</text>
          <text class="amount {{summary.balance >= 0 ? 'positive' : 'negative'}}">{{summary.balanceDisplay}}</text>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»ç»Ÿè®¡ -->
    <view wx:if="{{currentTab === 1}}" class="category-content">
      <view class="category-section">
        <view class="section-title">æ”¯å‡ºåˆ†ç±»</view>
        <view wx:if="{{categoryStats.expense.length === 0}}" class="empty-state">
          <text>æš‚æ— æ”¯å‡ºè®°å½•</text>
        </view>
        <view wx:else class="category-list">
          <view 
            wx:for="{{categoryStats.expense}}" 
            wx:key="name"
            class="category-item"
            data-category="{{item.name}}"
            data-type="expense"
            bindtap="viewCategoryDetail"
          >
            <view class="category-info">
              <text class="category-name">{{item.name}}</text>
              <text class="category-amount">{{item.amountDisplay}}</text>
            </view>
            <view class="category-progress">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.progressWidth}}"></view>
              </view>
              <text class="percentage">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
      </view>

      <view class="category-section">
        <view class="section-title">æ”¶å…¥åˆ†ç±»</view>
        <view wx:if="{{categoryStats.income.length === 0}}" class="empty-state">
          <text>æš‚æ— æ”¶å…¥è®°å½•</text>
        </view>
        <view wx:else class="category-list">
          <view 
            wx:for="{{categoryStats.income}}" 
            wx:key="name"
            class="category-item"
            data-category="{{item.name}}"
            data-type="income"
            bindtap="viewCategoryDetail"
          >
            <view class="category-info">
              <text class="category-name">{{item.name}}</text>
              <text class="category-amount">{{item.amountDisplay}}</text>
            </view>
            <view class="category-progress">
              <view class="progress-bar">
                <view class="progress-fill income" style="width: {{item.progressWidth}}"></view>
              </view>
              <text class="percentage">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¶‹åŠ¿å›¾ -->
    <view wx:if="{{currentTab === 2}}" class="trend-content">
      <view class="trend-chart">
        <view wx:if="{{trendData.length === 0}}" class="empty-state">
          <text>æš‚æ— æ•°æ®</text>
        </view>
        <view wx:else class="chart-container">
          <view 
            wx:for="{{trendData}}" 
            wx:key="date"
            class="chart-item"
          >
            <view class="chart-bar">
              <view class="bar income" style="height: {{item.income / 1000}}px"></view>
              <view class="bar expense" style="height: {{item.expense / 1000}}px"></view>
            </view>
            <text class="chart-label">{{item.dateDisplay}}</text>
          </view>
        </view>
      </view>
      
      <view class="trend-legend">
        <view class="legend-item">
          <view class="legend-color income"></view>
          <text>æ”¶å…¥</text>
        </view>
        <view class="legend-item">
          <view class="legend-color expense"></view>
          <text>æ”¯å‡º</text>
        </view>
      </view>
    </view>

    <!-- èµ„äº§åˆ†æ -->
    <view wx:if="{{currentTab === 3}}" class="asset-content">
      <view class="asset-summary">
        <text class="asset-title">æ€»èµ„äº§</text>
        <text class="asset-amount">{{assetData.totalAssetsDisplay}}</text>
      </view>
      
      <view class="asset-distribution">
        <view class="distribution-title">èµ„äº§åˆ†å¸ƒ</view>
        <view 
          wx:for="{{assetData.assetsDistribution}}" 
          wx:key="name"
          class="distribution-item"
        >
          <view class="distribution-info">
            <view class="distribution-color" style="background-color: {{item.color}}"></view>
            <text class="distribution-name">{{item.name}}</text>
          </view>
          <view class="distribution-amount">
            <text class="amount">{{formatAmount(item.amount)}}</text>
            <text class="percentage">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
      
      <view class="asset-accounts">
        <view class="accounts-title">ç°é‡‘è´¦æˆ·</view>
        <view 
          wx:for="{{assetData.accounts}}" 
          wx:key="_id"
          class="account-item"
          data-id="{{item._id}}"
          bindtap="viewAccountDetail"
        >
          <text class="account-name">{{item.name}}</text>
          <text class="account-balance">{{item.balanceDisplay}}</text>
        </view>
      </view>
      
      <view class="asset-investments">
        <view class="investments-title">æŠ•èµ„ç†è´¢</view>
        <view 
          wx:for="{{assetData.investments}}" 
          wx:key="_id"
          class="investment-item"
          data-id="{{item._id}}"
          bindtap="viewInvestmentDetail"
        >
          <view class="investment-info">
            <text class="investment-name">{{item.name}}</text>
            <text class="investment-type">{{item.type}}</text>
          </view>
          <view class="investment-amount">
            <text class="amount">{{item.amountDisplay}}</text>
            <text class="profit {{item.profit >= 0 ? 'positive' : 'negative'}}">{{item.profitDisplay}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾ç»Ÿè®¡ -->
    <view wx:if="{{currentTab === 4}}" class="tag-content">
      <view class="tag-section">
        <view class="section-title">æ”¯å‡ºæ ‡ç­¾</view>
        <view wx:if="{{tagStats.expense.length === 0}}" class="empty-state">
          <text>æš‚æ— æ”¯å‡ºè®°å½•</text>
        </view>
        <view wx:else class="tag-list">
          <view 
            wx:for="{{tagStats.expense}}" 
            wx:key="name"
            class="tag-item"
            data-tag="{{item.name}}"
            data-type="expense"
            bindtap="viewTagDetail"
          >
            <view class="tag-info">
              <text class="tag-name">{{item.name}}</text>
              <text class="tag-amount">{{item.amountDisplay}}</text>
            </view>
            <view class="tag-progress">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.progressWidth}}"></view>
              </view>
              <text class="percentage">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
      </view>

      <view class="tag-section">
        <view class="section-title">æ”¶å…¥æ ‡ç­¾</view>
        <view wx:if="{{tagStats.income.length === 0}}" class="empty-state">
          <text>æš‚æ— æ”¶å…¥è®°å½•</text>
        </view>
        <view wx:else class="tag-list">
          <view 
            wx:for="{{tagStats.income}}" 
            wx:key="name"
            class="tag-item"
            data-tag="{{item.name}}"
            data-type="income"
            bindtap="viewTagDetail"
          >
            <view class="tag-info">
              <text class="tag-name">{{item.name}}</text>
              <text class="tag-amount">{{item.amountDisplay}}</text>
            </view>
            <view class="tag-progress">
              <view class="progress-bar">
                <view class="progress-fill income" style="width: {{item.progressWidth}}"></view>
              </view>
              <text class="percentage">{{item.percentage}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¹´ä»½é€‰æ‹©å™¨ -->
  <view wx:if="{{showYearPicker}}" class="picker-overlay" bindtap="cancelPicker">
    <view class="picker-container" catchtap="">
      <picker-view 
        class="picker-view"
        indicator-style="height: 50px;"
        value="{{[currentYear - 2020]}}"
        bindchange="onYearChange"
      >
        <picker-view-column>
          <view wx:for="{{[2020, 2021, 2022, 2023, 2024, 2025, 2026, 2027, 2028, 2029, 2030]}}" wx:key="*this">{{item}}å¹´</view>
        </picker-view-column>
      </picker-view>
    </view>
  </view>

  <!-- æœˆä»½é€‰æ‹©å™¨ -->
  <view wx:if="{{showMonthPicker}}" class="picker-overlay" bindtap="cancelPicker">
    <view class="picker-container" catchtap="">
      <picker-view 
        class="picker-view"
        indicator-style="height: 50px;"
        value="{{[currentMonth]}}"
        bindchange="onMonthChange"
      >
        <picker-view-column>
          <view wx:for="{{[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]}}" wx:key="*this">{{item}}æœˆ</view>
        </picker-view-column>
      </picker-view>
    </view>
  </view>

  <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ -->
  <view wx:if="{{showDateRangePicker}}" class="picker-overlay" bindtap="cancelPicker">
    <view class="date-range-picker" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©æ—¥æœŸèŒƒå›´</text>
        <view class="picker-close" bindtap="cancelPicker">Ã—</view>
      </view>
      <view class="date-inputs">
        <view class="date-input-group">
          <text class="input-label">å¼€å§‹æ—¥æœŸ</text>
          <picker mode="date" value="{{customStartDate}}" bindchange="onStartDateChange">
            <view class="date-input">{{customStartDate}}</view>
          </picker>
        </view>
        <view class="date-input-group">
          <text class="input-label">ç»“æŸæ—¥æœŸ</text>
          <picker mode="date" value="{{customEndDate}}" bindchange="onEndDateChange">
            <view class="date-input">{{customEndDate}}</view>
          </picker>
        </view>
      </view>
      <view class="picker-actions">
        <button class="btn btn-outline" bindtap="cancelPicker">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="confirmCustomDateRange">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>
      <view wx:if="{{assetData.assetsDistribution.length === 0}}" class="empty-tip">
        æš‚æ— èµ„äº§æ•°æ®
      </view>
      <view wx:else class="category-list">
        <view 
          wx:for="{{assetData.assetsDistribution}}" 
          wx:key="name"
          class="category-item"
        >
          <view class="category-info">
            <text class="category-name">{{item.name}}</text>
            <text class="category-amount">Â¥{{formatAmount(item.amount)}}</text>
          </view>
          <view class="category-progress-bg">
            <view class="category-progress" style="width: {{item.percentage}}%; background-color: {{item.color}};"></view>
          </view>
          <text class="category-percentage">{{item.percentage}}%</text>
        </view>
      </view>
    </view>
    
    <!-- è´¦æˆ·åˆ—è¡¨ -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">è´¦æˆ·èµ„äº§</text>
      </view>
      <view wx:if="{{assetData.accounts.length === 0}}" class="empty-tip">
        æš‚æ— è´¦æˆ·æ•°æ®
      </view>
      <view wx:else class="asset-list">
        <view 
          wx:for="{{assetData.accounts}}" 
          wx:key="id"
          class="asset-item"
          bindtap="viewAccountDetail"
          data-id="{{item.id}}"
        >
          <view class="asset-icon">{{item.icon || 'ğŸ’°'}}</view>
          <view class="asset-info">
            <text class="asset-name">{{item.name}}</text>
            <text class="asset-type">
              <block wx:if="{{item.type === 'cash'}}">ç°é‡‘</block>
              <block wx:elif="{{item.type === 'bank'}}">é“¶è¡Œå¡</block>
              <block wx:else>ç”µå­é’±åŒ…</block>
            </text>
          </view>
          <text class="asset-amount">Â¥{{item.balanceDisplay}}</text>
        </view>
      </view>
    </view>
    
    <!-- æŠ•èµ„åˆ—è¡¨ -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">æŠ•èµ„ç†è´¢</text>
      </view>
      <view wx:if="{{assetData.investments.length === 0}}" class="empty-tip">
        æš‚æ— æŠ•èµ„æ•°æ®
      </view>
      <view wx:else class="asset-list">
        <view 
          wx:for="{{assetData.investments}}" 
          wx:key="id"
          class="asset-item"
          bindtap="viewInvestmentDetail"
          data-id="{{item.id}}"
        >
          <view class="asset-icon">{{item.icon || 'ğŸ“ˆ'}}</view>
          <view class="asset-info">
            <text class="asset-name">{{item.name}}</text>
            <text class="asset-profit {{item.profit >= 0 ? 'positive' : 'negative'}}">
              <block wx:if="{{item.profit >= 0}}">+</block>{{item.profitDisplay}}
            </text>
          </view>
          <text class="asset-amount">Â¥{{item.amountDisplay}}</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ ‡ç­¾åˆ†æ -->
  <view wx:elif="{{currentTab === 4}}" class="tab-content">
    <!-- æ”¯å‡ºæ ‡ç­¾ç»Ÿè®¡ -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">æ”¯å‡ºæ ‡ç­¾ç»Ÿè®¡</text>
      </view>
      <view wx:if="{{tagStats.expense.length === 0}}" class="empty-tip">
        æš‚æ— æ”¯å‡ºæ ‡ç­¾æ•°æ®
      </view>
      <view wx:else class="category-detail-list">
        <view 
          wx:for="{{tagStats.expense}}" 
          wx:key="name"
          class="category-detail-item"
        >
          <view class="category-detail-header">
            <text class="category-name">{{item.name}}</text>
            <text class="category-amount">Â¥{{item.amountDisplay}}</text>
          </view>
          <view class="category-progress-bg">
            <view class="category-progress" style="width: {{item.progressWidth}}; background-color: #ff3b30;"></view>
          </view>
          <view class="category-detail-footer">
            <text class="category-percentage">{{item.percentage}}%</text>
            <view class="category-detail-btn" bindtap="viewTagDetail" data-tag="{{item.name}}" data-type="expense">
              æŸ¥çœ‹æ˜ç»†
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ”¶å…¥æ ‡ç­¾ç»Ÿè®¡ -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">æ”¶å…¥æ ‡ç­¾ç»Ÿè®¡</text>
      </view>
      <view wx:if="{{tagStats.income.length === 0}}" class="empty-tip">
        æš‚æ— æ”¶å…¥æ ‡ç­¾æ•°æ®
      </view>
      <view wx:else class="category-detail-list">
        <view 
          wx:for="{{tagStats.income}}" 
          wx:key="name"
          class="category-detail-item"
        >
          <view class="category-detail-header">
            <text class="category-name">{{item.name}}</text>
            <text class="category-amount">Â¥{{item.amountDisplay}}</text>
          </view>
          <view class="category-progress-bg">
            <view class="category-progress" style="width: {{item.progressWidth}}; background-color: #34c759;"></view>
          </view>
          <view class="category-detail-footer">
            <text class="category-percentage">{{item.percentage}}%</text>
            <view class="category-detail-btn" bindtap="viewTagDetail" data-tag="{{item.name}}" data-type="income">
              æŸ¥çœ‹æ˜ç»†
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¹´ä»½é€‰æ‹©å™¨ -->
  <picker 
    wx:if="{{showYearPicker}}"
    mode="selector"
    range="{{[2020, 2021, 2022, 2023, 2024, 2025]}}"
    value="{{currentYear - 2020}}"
    bindchange="onYearChange"
    bindcancel="cancelPicker"
  >
  </picker>
  
  <!-- æœˆä»½é€‰æ‹©å™¨ -->
  <picker 
    wx:if="{{showMonthPicker}}"
    mode="selector"
    range="{{['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ']}}"
    value="{{currentMonth}}"
    bindchange="onMonthChange"
    bindcancel="cancelPicker"
  >
  </picker>
  
  <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ -->
  <view wx:if="{{showDateRangePicker}}" class="date-range-picker">
    <view class="date-range-picker-header">
      <text class="date-range-picker-title">é€‰æ‹©æ—¥æœŸèŒƒå›´</text>
      <view class="date-range-picker-close" bindtap="cancelPicker">Ã—</view>
    </view>
    <view class="date-range-picker-content">
      <view class="date-range-picker-item">
        <text class="date-range-picker-label">å¼€å§‹æ—¥æœŸ</text>
        <picker 
          mode="date" 
          value="{{customStartDate}}" 
          bindchange="onStartDateChange"
        >
          <view class="date-range-picker-value">{{customStartDate || 'è¯·é€‰æ‹©'}}</view>
        </picker>
      </view>
      <view class="date-range-picker-item">
        <text class="date-range-picker-label">ç»“æŸæ—¥æœŸ</text>
        <picker 
          mode="date" 
          value="{{customEndDate}}" 
          bindchange="onEndDateChange"
        >
          <view class="date-range-picker-value">{{customEndDate || 'è¯·é€‰æ‹©'}}</view>
        </picker>
      </view>
    </view>
    <view class="date-range-picker-footer">
      <button class="date-range-picker-btn cancel" bindtap="cancelPicker">å–æ¶ˆ</button>
      <button class="date-range-picker-btn confirm" bindtap="confirmCustomDateRange">ç¡®å®š</button>
    </view>
  </view>
</view>