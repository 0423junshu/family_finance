<!-- pages/reports/reports-simple.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="å®¶åº­è´¢åŠ¡ç®¡ç†" show-back="{{false}}" class="transparent-navbar" />
</view>

<view class="page-container" bindtap="onTapPage">
  <!-- é¡¶éƒ¨æ—¥æœŸé€‰æ‹©å™¨ï¼ˆæ”¹è¿›ï¼šæ˜ç¡®æ˜¾ç¤º æŒ‰æœˆ/æŒ‰å¹´/è‡ªå®šä¹‰ ä¸‰ç§æ¨¡å¼ï¼‰ -->
  <view cc>
    <view class="date-range-tabs">
      <view class="tab {{dateRange === 'month' ? 'active' : ''}}" bindtap="onDateRangeChange" data-range="month">æŒ‰æœˆ</view>
      <view class="tab {{dateRange === 'year' ? 'active' : ''}}" bindtap="onDateRangeChange" data-range="year">æŒ‰å¹´</view>
      <view class="tab {{dateRange === 'custom' ? 'active' : ''}}" bindtap="onDateRangeChange" data-range="custom">è‡ªå®šä¹‰</view>
    </view>

    <view class="date-display">
      <view wx:if="{{dateRange === 'month'}}" class="date-text" bindtap="showMonthPicker">
        {{currentYear}}å¹´{{currentMonth + 1}}æœˆ
        <text class="date-arrow">â–¼</text>
      </view>

      <view wx:elif="{{dateRange === 'year'}}" class="date-text" bindtap="showYearPicker">
        {{currentYear}}å¹´
        <text class="date-arrow">â–¼</text>
      </view>

      <view wx:elif="{{dateRange === 'custom'}}" class="date-text">
        {{customStartDate}} è‡³ {{customEndDate}}
      </view>
    </view>
  </view>

  <!-- é¡¶éƒ¨é€‰é¡¹å¡ -->
  <view class="tab-header">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="onTabChange" data-index="0">æ”¶æ”¯æ¦‚è§ˆ</view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="onTabChange" data-index="1">åˆ†ç±»ç»Ÿè®¡</view>
    <view wx:if="{{dateRange !== 'month'}}" class="tab-item {{currentTab === 2 ? 'active' : ''}}" bindtap="onTabChange" data-index="2">è¶‹åŠ¿å›¾</view>
    <view wx:if="{{dateRange !== 'month'}}" class="tab-item {{currentTab === 3 ? 'active' : ''}}" bindtap="onTabChange" data-index="3">èµ„äº§åˆ†æ</view>
    <view class="tab-item {{currentTab === 4 ? 'active' : ''}}" bindtap="onTabChange" data-index="4">æ ‡ç­¾åˆ†æ</view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æ”¶æ”¯æ¦‚è§ˆ -->
  <view wx:elif="{{currentTab === 0}}" class="tab-content">
    <view class="summary-card">
      <view class="summary-header">
        <text class="summary-title">æ”¶æ”¯æ¦‚è§ˆ</text>
        <view class="summary-tools" catchtap="toggleOptions">
          <text class="icon-more">â‹®</text>
          <view class="options-menu {{showOptions ? 'show' : ''}}">
            <view class="option-item" catchtap="exportReport">å¯¼å‡ºæŠ¥è¡¨</view>
            <view class="option-item" catchtap="setCycle">å‘¨æœŸè®¾ç½®</view>
          </view>
        </view>
      </view>
      
      <view class="summary-content">
        <view class="summary-item">
          <text class="summary-label">æ”¶å…¥</text>
          <text class="summary-value income">Â¥{{summary.totalIncome / 100}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æ”¯å‡º</text>
          <text class="summary-value expense">Â¥{{summary.totalExpense / 100}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">ç»“ä½™</text>
          <text class="summary-value {{summary.balance >= 0 ? 'income' : 'expense'}}">Â¥{{summary.balance / 100}}</text>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»TOP5 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">æ”¯å‡ºåˆ†ç±»TOP5</text>
        <text class="section-more" bindtap="onTabChange" data-index="1">æŸ¥çœ‹å…¨éƒ¨</text>
      </view>
      
      <view class="category-list">
        <block wx:for="{{categoryStats.expense}}" wx:key="id" wx:for-index="expenseIdx" wx:if="{{expenseIdx < 5}}">
          <view class="category-item" bindtap="viewCategoryDetail" data-category="{{item.id}}" data-type="expense" data-name="{{item.name}}">
            <view class="category-icon" style="background-color: {{item.color}}">{{item.icon}}</view>
            <view class="category-info">
              <view class="category-name">{{item.name}}</view>
              <view class="category-progress">
                <view class="progress-bar" style="width: {{item.percentage}}%"></view>
              </view>
              <view class="category-detail">
                <text class="category-percentage">{{item.percentage}}%</text>
              </view>
            </view>
            <view class="category-amount expense">Â¥{{item.amount / 100}}</view>
          </view>
        </block>
        <view wx:if="{{categoryStats.expense.length === 0}}" class="empty-tip">æš‚æ— æ”¯å‡ºæ•°æ®</view>
      </view>
    </view>

    <!-- æ”¶å…¥åˆ†ç±»TOP5 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">æ”¶å…¥åˆ†ç±»TOP5</text>
        <text class="section-more" bindtap="onTabChange" data-index="1">æŸ¥çœ‹å…¨éƒ¨</text>
      </view>
      
      <view class="category-list">
        <block wx:for="{{categoryStats.income}}" wx:key="id" wx:for-index="incomeIdx" wx:if="{{incomeIdx < 5}}">
          <view class="category-item" bindtap="viewCategoryDetail" data-category="{{item.id}}" data-type="income" data-name="{{item.name}}">
            <view class="category-icon" style="background-color: {{item.color}}">{{item.icon}}</view>
            <view class="category-info">
              <view class="category-name">{{item.name}}</view>
              <view class="category-progress">
                <view class="progress-bar income-bar" style="width: {{item.percentage}}%"></view>
              </view>
              <view class="category-detail">
                <text class="category-percentage">{{item.percentage}}%</text>
              </view>
            </view>
            <view class="category-amount income">Â¥{{item.amount / 100}}</view>
          </view>
        </block>
        <view wx:if="{{categoryStats.income.length === 0}}" class="empty-tip">æš‚æ— æ”¶å…¥æ•°æ®</view>
      </view>
    </view>

    <!-- èµ„äº§æ¦‚è§ˆ -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">èµ„äº§æ¦‚è§ˆ</text>
        <text class="section-more" catchtap="goToAssetsPage">æŸ¥çœ‹è¯¦æƒ…</text>
      </view>
      
      <view class="asset-overview">
        <view class="asset-total">
          <text class="asset-label">æ€»èµ„äº§</text>
          <text class="asset-value">Â¥{{assetData.totalAssets / 100}}</text>
        </view>
        <view class="asset-distribution">
          <block wx:for="{{assetData.assetsDistribution}}" wx:key="name">
            <view class="asset-type">
              <view class="asset-type-dot" style="background-color: {{item.color}}"></view>
              <text class="asset-type-name">{{item.name}}</text>
              <text class="asset-type-value">Â¥{{item.amount / 100}}</text>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†ç±»ç»Ÿè®¡ -->
  <view wx:elif="{{currentTab === 1}}" class="tab-content">
    <view class="category-type-switch">
      <view class="switch-item {{categoryType === 'expense' ? 'active' : ''}}" bindtap="onCategoryTypeChange" data-type="expense">æ”¯å‡º</view>
      <view class="switch-item {{categoryType === 'income' ? 'active' : ''}}" bindtap="onCategoryTypeChange" data-type="income">æ”¶å…¥</view>
    </view>
    
    <view class="category-stats">
      <block wx:for="{{categoryStats[categoryType]}}" wx:key="id" wx:for-index="categoryIdx">
        <view class="category-item" bindtap="viewCategoryDetail" data-category="{{item.id}}" data-type="{{categoryType}}">
          <view class="category-icon" style="background-color: {{item.color}}">{{item.icon}}</view>
          <view class="category-info">
            <view class="category-name">{{item.name}}</view>
            <view class="category-progress">
              <view class="progress-bar {{categoryType === 'income' ? 'income-bar' : ''}}" style="width: {{item.percentage}}%"></view>
            </view>
            <view class="category-detail">
              <text class="category-percentage">{{item.percentage}}%</text>
              <text class="category-count">{{item.count}}ç¬”</text>
            </view>
          </view>
          <view class="category-amount {{categoryType}}">Â¥{{item.amount / 100}}</view>
        </view>
      </block>
      <view wx:if="{{categoryStats[categoryType].length === 0}}" class="empty-tip">æš‚æ— {{categoryType === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}}æ•°æ®</view>
    </view>
  </view>

  <!-- è¶‹åŠ¿å›¾ -->
  <view class="tab-content" wx:elif="{{currentTab === 2 && dateRange !== 'month'}}">
    <view wx:if="{{!showYearPicker && !showMonthPicker && !showDateRangePicker}}" class="chart-container">
      <canvas type="2d" id="trendCanvas" class="trend-canvas"></canvas>
    </view>
    
    <view class="trend-data">
      <view class="trend-header">
        <text class="trend-title">è¶‹åŠ¿æ•°æ®æ˜ç»†</text>
      </view>
      
      <view class="trend-table">
        <view class="trend-table-header">
          <view class="trend-table-cell">æ—¥æœŸ</view>
          <view class="trend-table-cell">æ”¶å…¥</view>
          <view class="trend-table-cell">æ”¯å‡º</view>
          <view class="trend-table-cell">ç»“ä½™</view>
          <view class="trend-table-cell">èµ„äº§</view>
        </view>
        
        <block wx:for="{{trendData}}" wx:key="date">
          <view class="trend-table-row">
            <view class="trend-table-cell">{{item.dateDisplay}}</view>
            <view class="trend-table-cell income">Â¥{{item.income / 100}}</view>
            <view class="trend-table-cell expense">Â¥{{item.expense / 100}}</view>
            <view class="trend-table-cell {{(item.income - item.expense) >= 0 ? 'income' : 'expense'}}">
              Â¥{{(item.income - item.expense) / 100}}
            </view>
            <view class="trend-table-cell asset">Â¥{{(item.totalAssets || 0) / 100}}</view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- èµ„äº§åˆ†æ -->
  <view wx:elif="{{currentTab === 3 && dateRange !== 'month'}}" class="tab-content">
    <view wx:if="{{!showYearPicker && !showMonthPicker && !showDateRangePicker}}" class="asset-chart">
      <canvas type="2d" id="assetPie" class="asset-canvas"></canvas>
    </view>
    
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">è´¦æˆ·èµ„äº§</text>
      </view>
      
      <view class="account-list">
        <block wx:for="{{assetData.accounts}}" wx:key="id">
          <view class="account-item" bindtap="viewAccountDetail" data-id="{{item.id}}">
            <view class="account-icon">{{item.icon}}</view>
            <view class="account-info">
              <view class="account-name">{{item.name}}</view>
              <view class="account-type">{{item.typeName}}</view>
            </view>
            <view class="account-balance">Â¥{{item.balance / 100}}</view>
          </view>
        </block>
        <view wx:if="{{assetData.accounts.length === 0}}" class="empty-tip">æš‚æ— è´¦æˆ·æ•°æ®</view>
      </view>
    </view>
    
    <view class="section-card" wx:if="{{assetData.investments && assetData.investments.length > 0}}">
      <view class="section-header">
        <text class="section-title">æŠ•èµ„èµ„äº§</text>
      </view>
      
      <view class="investment-list">
        <block wx:for="{{assetData.investments}}" wx:key="id">
          <view class="investment-item" bindtap="viewInvestmentDetail" data-id="{{item.id}}">
            <view class="investment-icon">{{item.icon}}</view>
            <view class="investment-info">
              <view class="investment-name">{{item.name}}</view>
              <view class="investment-type">{{item.typeName}}</view>
            </view>
            <view class="investment-data">
              <view class="investment-value">Â¥{{item.currentValue / 100}}</view>
              <view class="investment-profit {{item.profit >= 0 ? 'income' : 'expense'}}">
                {{item.profit >= 0 ? '+' : ''}}{{item.profitRate}}
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>
    
    <!-- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">æ•°æ®ä¸€è‡´æ€§</text>
        <text class="section-more" bindtap="checkDataConsistency">æ£€æŸ¥</text>
      </view>
      
      <view class="consistency-content">
        <view wx:if="{{checkingConsistency}}" class="checking-tip">æ£€æŸ¥ä¸­...</view>
        <view wx:elif="{{!consistencyResult}}" class="consistency-tip">ç‚¹å‡»"æ£€æŸ¥"æŒ‰é’®è¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥</view>
        <view wx:elif="{{!consistencyResult.needFix}}" class="consistency-success">
          <text class="icon-success">âœ“</text>
          <text>æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡</text>
        </view>
        <view wx:else class="consistency-error">
          <text class="icon-error">!</text>
          <text>å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜</text>
          <view class="consistency-detail">{{consistencyResult.detailedMessage}}</view>
          <button class="fix-button" bindtap="fixDataConsistency">ä¿®å¤é—®é¢˜</button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾åˆ†æ -->
  <view class="tab-content" wx:elif="{{currentTab === 4}}">
    <view class="category-type-switch">
      <view class="switch-item {{categoryType === 'expense' ? 'active' : ''}}" bindtap="onCategoryTypeChange" data-type="expense">æ”¯å‡º</view>
      <view class="switch-item {{categoryType === 'income' ? 'active' : ''}}" bindtap="onCategoryTypeChange" data-type="income">æ”¶å…¥</view>
    </view>
    
    <view class="tag-stats">
      <block wx:for="{{tagStats[categoryType]}}" wx:key="name">
        <view class="tag-item" bindtap="viewTagDetail" data-tag="{{item.name}}" data-type="{{categoryType}}">
          <view class="tag-name">#{{item.name}}</view>
          <view class="tag-info">
            <view class="tag-count">{{item.count}}ç¬”</view>
            <view class="tag-amount {{categoryType}}">Â¥{{item.amount / 100}}</view>
          </view>
        </view>
      </block>
      <view wx:if="{{tagStats[categoryType].length === 0}}" class="empty-tip">æš‚æ— æ ‡ç­¾æ•°æ®</view>
    </view>
  </view>

  <!-- å·¥å…·èœå• -->
  <view class="tools-menu {{showToolsMenu ? 'show' : ''}}">
    <view class="tools-item" bindtap="exportReport">
      <text class="tools-icon">ğŸ“Š</text>
      <text class="tools-text">å¯¼å‡ºæŠ¥è¡¨</text>
    </view>
    <view class="tools-item" bindtap="setCycle">
      <text class="tools-icon">ğŸ”„</text>
      <text class="tools-text">å‘¨æœŸè®¾ç½®</text>
    </view>
    <view class="tools-item" bindtap="checkDataConsistency">
      <text class="tools-icon">ğŸ”</text>
      <text class="tools-text">æ•°æ®æ£€æŸ¥</text>
    </view>
  </view>

  <!-- æµ®åŠ¨å·¥å…·æŒ‰é’® -->
  <view class="float-button" catchtap="showToolsMenu">
    <text class="float-icon">âš™ï¸</text>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©å™¨å¼¹çª— -->
  <view class="picker-modal" wx:if="{{showYearPicker || showMonthPicker || showDateRangePicker}}">
    <view class="picker-content">
      <view class="picker-header">
        <text class="picker-title">
          {{showYearPicker ? 'é€‰æ‹©å¹´ä»½' : (showMonthPicker ? 'é€‰æ‹©æœˆä»½' : 'é€‰æ‹©æ—¥æœŸèŒƒå›´')}}
        </text>
        <text class="picker-close" bindtap="cancelPicker">Ã—</text>
      </view>
      
      <view class="picker-body">
        <view wx:if="{{showYearPicker}}" class="picker-container">
          <picker-view indicator-style="height: 50px;" style="width: 100%; height: 250px;" value="{{[yearIndex]}}" bindchange="onYearChange">
            <picker-view-column>
              <view wx:for="{{yearList}}" wx:key="*this" style="line-height: 50px; text-align: center;">{{item}}</view>
            </picker-view-column>
          </picker-view>
          <button class="confirm-button" bindtap="confirmYearPicker">ç¡®å®š</button>
        </view>
        
        <view wx:if="{{showMonthPicker}}" class="picker-container">
          <picker-view indicator-style="height: 50px;" style="width: 100%; height: 250px;" value="{{[monthIndex]}}" bindchange="onMonthChange">
            <picker-view-column>
              <view wx:for="{{monthList}}" wx:key="*this" style="line-height: 50px; text-align: center;">{{item}}</view>
            </picker-view-column>
          </picker-view>
          <button class="confirm-button" bindtap="confirmMonthPicker">ç¡®å®š</button>
        </view>
        
        <view wx:if="{{showDateRangePicker}}" class="date-range-picker">
          <view class="date-picker-item">
            <text class="date-picker-label">å¼€å§‹å¹´æœˆ</text>
            <picker-view 
              indicator-style="height: 50px;" 
              style="width: 100%; height: 150px;" 
              value="{{[customStartYearIndex, customStartMonthIndex]}}" 
              bindchange="onCustomStartChange"
            >
              <picker-view-column>
                <view wx:for="{{yearList}}" wx:key="*this" style="line-height: 50px; text-align: center;">{{item}}</view>
              </picker-view-column>
              <picker-view-column>
                <view wx:for="{{monthList}}" wx:key="*this" style="line-height: 50px; text-align: center;">{{item}}</view>
              </picker-view-column>
            </picker-view>
          </view>
          
          <view class="date-picker-item">
            <text class="date-picker-label">ç»“æŸå¹´æœˆ</text>
            <picker-view 
              indicator-style="height: 50px;" 
              style="width: 100%; height: 150px;" 
              value="{{[customEndYearIndex, customEndMonthIndex]}}" 
              bindchange="onCustomEndChange"
            >
              <picker-view-column>
                <view wx:for="{{yearList}}" wx:key="*this" style="line-height: 50px; text-align: center;">{{item}}</view>
              </picker-view-column>
              <picker-view-column>
                <view wx:for="{{monthList}}" wx:key="*this" style="line-height: 50px; text-align: center;">{{item}}</view>
              </picker-view-column>
            </picker-view>
          </view>
          
          <view class="custom-date-display">
            <text class="custom-date-text">{{customStartYear}}å¹´{{customStartMonth}}æœˆ è‡³ {{customEndYear}}å¹´{{customEndMonth}}æœˆ</text>
          </view>
          
          <button class="confirm-button" bindtap="confirmCustomDateRange">ç¡®å®š</button>
        </view>
      </view>
    </view>
  </view>
</view>