<!-- pages/data-export/data-export.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="æ•°æ®å¯¼å‡º" show-back="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- å¯¼å‡ºç±»å‹é€‰æ‹© -->
  <view class="section">
    <view class="section-header">
      <view class="section-title">é€‰æ‹©å¯¼å‡ºç±»å‹</view>
      <view class="section-desc">é€‰æ‹©è¦å¯¼å‡ºçš„æ•°æ®ç±»å‹</view>
    </view>
    
    <view class="type-grid">
      <view 
        wx:for="{{exportTypes}}" 
        wx:key="id"
        class="type-item {{selectedType === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="onTypeSelect"
      >
        <view class="type-icon">{{item.icon}}</view>
        <view class="type-info">
          <view class="type-name">{{item.name}}</view>
          <view class="type-desc">{{item.description}}</view>
        </view>
        <view wx:if="{{selectedType === item.id}}" class="type-check">
          <view class="check-icon">âœ“</view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹© -->
  <view class="section">
    <view class="section-header">
      <view class="section-title">é€‰æ‹©å¯¼å‡ºæ ¼å¼</view>
    </view>
    
    <view class="format-list">
      <view 
        wx:for="{{formats}}" 
        wx:key="id"
        class="format-item {{selectedFormat === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="onFormatSelect"
      >
        <view class="format-info">
          <view class="format-name">{{item.name}}</view>
          <view class="format-desc">{{item.description}}</view>
        </view>
        <view wx:if="{{selectedFormat === item.id}}" class="format-check">
          <view class="check-icon">âœ“</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
  <view wx:if="{{selectedType === 'transactions' || selectedType === 'report'}}" class="section">
    <view class="section-header">
      <view class="section-title">é€‰æ‹©æ—¶é—´èŒƒå›´</view>
    </view>
    
    <!-- å¿«é€Ÿé€‰æ‹© -->
    <view class="date-presets">
      <view 
        wx:for="{{dateRange.presets}}" 
        wx:key="id"
        class="preset-item"
        data-preset="{{item}}"
        bindtap="onDatePresetSelect"
      >
        {{item.name}}
      </view>
    </view>
    
    <!-- è‡ªå®šä¹‰æ—¥æœŸ -->
    <view class="date-custom">
      <view class="date-item">
        <view class="date-label">å¼€å§‹æ—¥æœŸ</view>
        <picker mode="date" value="{{dateRange.startDate}}" bindchange="onStartDateChange">
          <view class="date-value">{{dateRange.startDate || 'è¯·é€‰æ‹©'}}</view>
        </picker>
      </view>
      
      <view class="date-separator">è‡³</view>
      
      <view class="date-item">
        <view class="date-label">ç»“æŸæ—¥æœŸ</view>
        <picker mode="date" value="{{dateRange.endDate}}" bindchange="onEndDateChange">
          <view class="date-value">{{dateRange.endDate || 'è¯·é€‰æ‹©'}}</view>
        </picker>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ¡ä»¶ -->
  <view wx:if="{{selectedType === 'transactions'}}" class="section">
    <view class="section-header" bindtap="toggleFilters">
      <view class="section-title">ç­›é€‰æ¡ä»¶</view>
      <view class="section-toggle {{showFilters ? 'active' : ''}}">
        <view class="toggle-icon">{{showFilters ? 'â–¼' : 'â–¶'}}</view>
      </view>
    </view>
    
    <view wx:if="{{showFilters}}" class="filters-content">
      <!-- åˆ†ç±»ç­›é€‰ -->
      <view class="filter-group">
        <view class="filter-title">é€‰æ‹©åˆ†ç±»</view>
        <view class="filter-options">
          <view 
            wx:for="{{availableCategories}}" 
            wx:key="id"
            class="filter-option {{filters.categories.indexOf(item.id) > -1 ? 'selected' : ''}}"
            data-id="{{item.id}}"
            bindtap="onCategoryChange"
          >
            <view class="option-icon">{{item.icon}}</view>
            <view class="option-name">{{item.name}}</view>
          </view>
        </view>
      </view>
      
      <!-- è´¦æˆ·ç­›é€‰ -->
      <view class="filter-group">
        <view class="filter-title">é€‰æ‹©è´¦æˆ·</view>
        <view class="filter-options">
          <view 
            wx:for="{{availableAccounts}}" 
            wx:key="id"
            class="filter-option {{filters.accounts.indexOf(item.id) > -1 ? 'selected' : ''}}"
            data-id="{{item.id}}"
            bindtap="onAccountChange"
          >
            <view class="option-icon">ğŸ’³</view>
            <view class="option-name">{{item.name}}</view>
          </view>
        </view>
      </view>
      
      <!-- æ¸…é™¤ç­›é€‰ -->
      <view class="filter-actions">
        <button class="clear-btn" bindtap="clearFilters">æ¸…é™¤ç­›é€‰</button>
      </view>
    </view>
  </view>

  <!-- èµ„äº§å¯¼å‡ºé€‰é¡¹ -->
  <view wx:if="{{selectedType === 'assets'}}" class="section">
    <view class="section-header">
      <view class="section-title">å¯¼å‡ºé€‰é¡¹</view>
    </view>
    
    <view class="asset-options">
      <view class="option-item">
        <view class="option-info">
          <view class="option-title">åŒ…å«äº¤æ˜“å†å²</view>
          <view class="option-desc">å¯¼å‡ºæ¯ä¸ªè´¦æˆ·çš„äº¤æ˜“æ˜ç»†</view>
        </view>
        <switch checked="{{filters.includeHistory}}" bindchange="onIncludeHistoryChange" />
      </view>
    </view>
  </view>

  <!-- å¯¼å‡ºæŒ‰é’® -->
  <view class="export-section">
    <button 
      class="export-btn {{loading ? 'loading' : ''}}" 
      bindtap="startExport"
      disabled="{{loading}}"
    >
      <view wx:if="{{loading}}" class="loading-icon"></view>
      {{loading ? 'å¯¼å‡ºä¸­...' : 'å¼€å§‹å¯¼å‡º'}}
    </button>
  </view>

  <!-- å¯¼å‡ºå†å² -->
  <view class="section">
    <view class="section-header" bindtap="toggleHistory">
      <view class="section-title">å¯¼å‡ºå†å²</view>
      <view class="section-toggle {{showHistory ? 'active' : ''}}">
        <view class="toggle-icon">{{showHistory ? 'â–¼' : 'â–¶'}}</view>
      </view>
    </view>
    
    <view wx:if="{{showHistory}}" class="history-content">
      <view wx:if="{{exportHistory.length === 0}}" class="history-empty">
        <view class="empty-icon">ğŸ“„</view>
        <view class="empty-text">æš‚æ— å¯¼å‡ºè®°å½•</view>
      </view>
      
      <view wx:else class="history-list">
        <view 
          wx:for="{{exportHistory}}" 
          wx:key="id"
          class="history-item"
        >
          <view class="history-info">
            <view class="history-title">
              {{getExportTypeText(item.type)}} - {{getFormatText(item.format)}}
            </view>
            <view class="history-details">
              <view class="history-detail">æ–‡ä»¶ï¼š{{item.fileName}}</view>
              <view wx:if="{{item.startDate && item.endDate}}" class="history-detail">
                æ—¶é—´ï¼š{{item.startDate}} è‡³ {{item.endDate}}
              </view>
              <view class="history-detail">
                å¯¼å‡ºæ—¶é—´ï¼š{{item.exportTime}}
              </view>
              <view wx:if="{{item.recordCount}}" class="history-detail">
                è®°å½•æ•°ï¼š{{item.recordCount}}æ¡
              </view>
            </view>
          </view>
          
          <view class="history-actions">
            <button 
              class="action-btn re-export" 
              data-record="{{item}}"
              bindtap="reExport"
            >
              é‡æ–°å¯¼å‡º
            </button>
            <button 
              class="action-btn delete" 
              data-id="{{item.id}}"
              bindtap="deleteExportRecord"
            >
              åˆ é™¤
            </button>
          </view>
        </view>
      </view>
      
      <view wx:if="{{exportHistory.length > 0}}" class="history-footer">
        <button class="clear-all-btn" bindtap="clearAllHistory">
          æ¸…é™¤æ‰€æœ‰è®°å½•
        </button>
      </view>
    </view>
  </view>
</view>