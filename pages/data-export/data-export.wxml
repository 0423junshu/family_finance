<!-- pages/data-export/data-export.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="数据导出" show-back="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- 导出类型选择 -->
  <view class="section">
    <view class="section-header">
      <view class="section-title">选择导出类型</view>
      <view class="section-desc">选择要导出的数据类型</view>
    </view>
    
    <view class="type-grid">
      <view 
        wx:for="{{exportTypes}}" 
        wx:key="id"
        class="type-item {{selectedType === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="onTypeSelect"
      >
        <view class="type-icon">{{item.icon}}</view>
        <view class="type-info">
          <view class="type-name">{{item.name}}</view>
          <view class="type-desc">{{item.description}}</view>
        </view>
        <view wx:if="{{selectedType === item.id}}" class="type-check">
          <view class="check-icon">✓</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 导出格式选择 -->
  <view class="section">
    <view class="section-header">
      <view class="section-title">选择导出格式</view>
    </view>
    
    <view class="format-list">
      <view 
        wx:for="{{formats}}" 
        wx:key="id"
        class="format-item {{selectedFormat === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="onFormatSelect"
      >
        <view class="format-info">
          <view class="format-name">{{item.name}}</view>
          <view class="format-desc">{{item.description}}</view>
        </view>
        <view wx:if="{{selectedFormat === item.id}}" class="format-check">
          <view class="check-icon">✓</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 时间范围选择 -->
  <view wx:if="{{selectedType === 'transactions' || selectedType === 'report'}}" class="section">
    <view class="section-header">
      <view class="section-title">选择时间范围</view>
    </view>
    
    <!-- 快速选择 -->
    <view class="date-presets">
      <view 
        wx:for="{{dateRange.presets}}" 
        wx:key="id"
        class="preset-item"
        data-preset="{{item}}"
        bindtap="onDatePresetSelect"
      >
        {{item.name}}
      </view>
    </view>
    
    <!-- 自定义日期 -->
    <view class="date-custom">
      <view class="date-item">
        <view class="date-label">开始日期</view>
        <picker mode="date" value="{{dateRange.startDate}}" bindchange="onStartDateChange">
          <view class="date-value">{{dateRange.startDate || '请选择'}}</view>
        </picker>
      </view>
      
      <view class="date-separator">至</view>
      
      <view class="date-item">
        <view class="date-label">结束日期</view>
        <picker mode="date" value="{{dateRange.endDate}}" bindchange="onEndDateChange">
          <view class="date-value">{{dateRange.endDate || '请选择'}}</view>
        </picker>
      </view>
    </view>
  </view>

  <!-- 筛选条件 -->
  <view wx:if="{{selectedType === 'transactions'}}" class="section">
    <view class="section-header" bindtap="toggleFilters">
      <view class="section-title">筛选条件</view>
      <view class="section-toggle {{showFilters ? 'active' : ''}}">
        <view class="toggle-icon">{{showFilters ? '▼' : '▶'}}</view>
      </view>
    </view>
    
    <view wx:if="{{showFilters}}" class="filters-content">
      <!-- 分类筛选 -->
      <view class="filter-group">
        <view class="filter-title">选择分类</view>
        <view class="filter-options">
          <view 
            wx:for="{{availableCategories}}" 
            wx:key="id"
            class="filter-option {{filters.categories.indexOf(item.id) > -1 ? 'selected' : ''}}"
            data-id="{{item.id}}"
            bindtap="onCategoryChange"
          >
            <view class="option-icon">{{item.icon}}</view>
            <view class="option-name">{{item.name}}</view>
          </view>
        </view>
      </view>
      
      <!-- 账户筛选 -->
      <view class="filter-group">
        <view class="filter-title">选择账户</view>
        <view class="filter-options">
          <view 
            wx:for="{{availableAccounts}}" 
            wx:key="id"
            class="filter-option {{filters.accounts.indexOf(item.id) > -1 ? 'selected' : ''}}"
            data-id="{{item.id}}"
            bindtap="onAccountChange"
          >
            <view class="option-icon">💳</view>
            <view class="option-name">{{item.name}}</view>
          </view>
        </view>
      </view>
      
      <!-- 清除筛选 -->
      <view class="filter-actions">
        <button class="clear-btn" bindtap="clearFilters">清除筛选</button>
      </view>
    </view>
  </view>

  <!-- 资产导出选项 -->
  <view wx:if="{{selectedType === 'assets'}}" class="section">
    <view class="section-header">
      <view class="section-title">导出选项</view>
    </view>
    
    <view class="asset-options">
      <view class="option-item">
        <view class="option-info">
          <view class="option-title">包含交易历史</view>
          <view class="option-desc">导出每个账户的交易明细</view>
        </view>
        <switch checked="{{filters.includeHistory}}" bindchange="onIncludeHistoryChange" />
      </view>
    </view>
  </view>

  <!-- 导出按钮 -->
  <view class="export-section">
    <button 
      class="export-btn {{loading ? 'loading' : ''}}" 
      bindtap="startExport"
      disabled="{{loading}}"
    >
      <view wx:if="{{loading}}" class="loading-icon"></view>
      {{loading ? '导出中...' : '开始导出'}}
    </button>
  </view>

  <!-- 导出历史 -->
  <view class="section">
    <view class="section-header" bindtap="toggleHistory">
      <view class="section-title">导出历史</view>
      <view class="section-toggle {{showHistory ? 'active' : ''}}">
        <view class="toggle-icon">{{showHistory ? '▼' : '▶'}}</view>
      </view>
    </view>
    
    <view wx:if="{{showHistory}}" class="history-content">
      <view wx:if="{{exportHistory.length === 0}}" class="history-empty">
        <view class="empty-icon">📄</view>
        <view class="empty-text">暂无导出记录</view>
      </view>
      
      <view wx:else class="history-list">
        <view 
          wx:for="{{exportHistory}}" 
          wx:key="id"
          class="history-item"
        >
          <view class="history-info">
            <view class="history-title">
              {{getExportTypeText(item.type)}} - {{getFormatText(item.format)}}
            </view>
            <view class="history-details">
              <view class="history-detail">文件：{{item.fileName}}</view>
              <view wx:if="{{item.startDate && item.endDate}}" class="history-detail">
                时间：{{item.startDate}} 至 {{item.endDate}}
              </view>
              <view class="history-detail">
                导出时间：{{item.exportTime}}
              </view>
              <view wx:if="{{item.recordCount}}" class="history-detail">
                记录数：{{item.recordCount}}条
              </view>
            </view>
          </view>
          
          <view class="history-actions">
            <button 
              class="action-btn re-export" 
              data-record="{{item}}"
              bindtap="reExport"
            >
              重新导出
            </button>
            <button 
              class="action-btn delete" 
              data-id="{{item.id}}"
              bindtap="deleteExportRecord"
            >
              删除
            </button>
          </view>
        </view>
      </view>
      
      <view wx:if="{{exportHistory.length > 0}}" class="history-footer">
        <button class="clear-all-btn" bindtap="clearAllHistory">
          清除所有记录
        </button>
      </view>
    </view>
  </view>
</view>