<!-- pages/budget-manage/budget-manage.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="é¢„ç®—ç®¡ç†" showBack="{{true}}" class="transparent-navbar"></navigation-bar>
</view>

<view class="container">
  <!-- æœˆä»½é€‰æ‹©å™¨ï¼ˆå†å²é¢„ç®—ä¿®æ”¹åŠŸèƒ½ï¼‰ -->
  <view class="month-selector-header">
    <view class="month-display" bindtap="showMonthPicker">
      <text class="month-text">{{currentMonthText}}</text>
      <text class="date-status">{{dateStatus}}</text>
      <text class="month-arrow">ğŸ“…</text>
    </view>
  </view>
  
  <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === 0 ? 'active' : ''}}"
      bindtap="onTabChange"
      data-tab="0"
    >
      <text>æ”¯å‡ºé¢„ç®—</text>
    </view>
    <view 
      class="tab-item {{currentTab === 1 ? 'active' : ''}}"
      bindtap="onTabChange"
      data-tab="1"
    >
      <text>æ”¶å…¥é¢„æœŸ</text>
    </view>
  </view>
  
  <!-- æ”¯å‡ºé¢„ç®—é¡µé¢ -->
  <view wx:if="{{currentTab === 0}}" class="tab-content">
    <!-- é¢„ç®—æ¦‚è§ˆ -->
    <view class="budget-overview">
      <view class="overview-header">
        <text class="month-title">æ”¯å‡ºé¢„ç®—</text>
      </view>
      
      <view class="overview-stats">
        <view class="stat-item">
          <view class="stat-label">æ€»é¢„ç®—</view>
          <view class="stat-value">Â¥{{expenseStats.totalBudget}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å·²èŠ±è´¹</view>
          <view class="stat-value expense">Â¥{{expenseStats.totalSpent}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å‰©ä½™</view>
          <view class="stat-value {{expenseStats.remainingBudget >= 0 ? 'income' : 'expense'}}">
            Â¥{{expenseStats.remainingBudget}}
          </view>
        </view>
      </view>
      
      <!-- æ€»ä½“è¿›åº¦æ¡ -->
      <view wx:if="{{expenseStats.totalBudget > 0}}" class="total-progress">
        <view class="progress-info">
          <text>æ€»ä½“è¿›åº¦</text>
          <text>{{expenseStats.progressPercent}}%</text>
        </view>
        <view class="progress-bar">
          <view 
            class="progress-fill {{expenseStats.progressWidth > 100 ? 'over-budget' : ''}}"
            style="width: {{expenseStats.progressWidth}}%"
          ></view>
        </view>
      </view>
    </view>
    
    <!-- é¢„ç®—åˆ—è¡¨ -->
    <view class="budget-list">
      <view class="section-header">
        <text class="section-title">åˆ†ç±»é¢„ç®—</text>
        <view class="add-budget-btn" bindtap="showAddDialog">
          <text class="iconfont icon-add"></text>
          <text>æ·»åŠ </text>
        </view>
      </view>
      
      <!-- åŠ è½½ä¸­çŠ¶æ€ -->
      <view wx:if="{{loading}}" class="loading-state">
        <view class="loading-spinner"></view>
        <text>åŠ è½½ä¸­...</text>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{expenseBudgets.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ“Š</view>
        <text>è¿˜æ²¡æœ‰è®¾ç½®é¢„ç®—</text>
        <button class="add-first-btn" bindtap="showAddDialog">æ·»åŠ ç¬¬ä¸€ä¸ªé¢„ç®—</button>
      </view>
      
      <!-- é¢„ç®—é¡¹åˆ—è¡¨ -->
      <view wx:else class="budget-items">
        <view 
          wx:for="{{expenseBudgets}}" 
          wx:key="id"
          class="budget-item {{item.isOverBudget ? 'over-budget-item' : ''}}"
          bindtap="showEditDialog"
          data-item="{{item}}"
          data-id="{{item.id || item._id}}"
        >
          <view class="budget-header">
            <view class="category-info">
              <text class="category-name">{{item.categoryName}}</text>
              <text class="budget-amount">é¢„ç®—: Â¥{{item.formattedAmount}}</text>
            </view>
            <view class="budget-actions">
              <view 
                class="action-btn edit"
                catchtap="showEditDialog"
                data-item="{{item}}"
                data-id="{{item.id || item._id}}"
              >
                ç¼–è¾‘
              </view>
              <view 
                class="action-btn delete"
                catchtap="onDelete"
                data-item="{{item}}"
                data-id="{{item.id || item._id}}"
              >
                åˆ é™¤
              </view>
            </view>
          </view>
          
          <view class="budget-progress">
            <view class="progress-bar-container">
              <view class="progress-bar">
                <view 
                  class="progress-fill {{item.isOverBudget ? 'over-budget' : ''}}"
                  style="width: {{item.progress}}%"
                ></view>
              </view>
            </view>
            
            <view class="progress-details">
              <view class="progress-info">
                <text class="spent-amount {{item.isOverBudget ? 'over-budget' : ''}}">
                  å·²èŠ±è´¹: Â¥{{item.formattedSpent}}
                </text>
                <text class="progress-percent">{{item.progressPercent}}%</text>
              </view>
              
              <view class="remaining-info">
                <text class="remaining-amount {{item.remaining >= 0 ? 'positive' : 'negative'}}">
                  {{item.remaining >= 0 ? 'å‰©ä½™: ' : 'è¶…æ”¯: '}}Â¥{{item.formattedRemaining}}
                </text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ”¶å…¥é¢„æœŸé¡µé¢ -->
  <view wx:if="{{currentTab === 1}}" class="tab-content">
    <!-- æ”¶å…¥æ¦‚è§ˆ -->
    <view class="budget-overview income-overview">
      <view class="overview-header">
        <text class="month-title">æ”¶å…¥é¢„æœŸ</text>
      </view>
      
      <view class="overview-stats">
        <view class="stat-item">
          <view class="stat-label">æ€»é¢„æœŸ</view>
          <view class="stat-value income">Â¥{{incomeStats.totalExpected}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å·²æ”¶å…¥</view>
          <view class="stat-value income">Â¥{{incomeStats.totalReceived}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">å¾…æ”¶å…¥</view>
          <view class="stat-value {{incomeStats.remainingExpected >= 0 ? 'expense' : 'income'}}">
            Â¥{{incomeStats.remainingExpected}}
          </view>
        </view>
      </view>
      
      <!-- æ€»ä½“è¿›åº¦æ¡ -->
      <view wx:if="{{incomeStats.totalExpected > 0}}" class="total-progress">
        <view class="progress-info">
          <text>å®Œæˆè¿›åº¦</text>
          <text>{{incomeStats.progressPercent}}%</text>
        </view>
        <view class="progress-bar">
          <view 
            class="progress-fill income-progress"
            style="width: {{incomeStats.progressWidth}}%"
          ></view>
        </view>
      </view>
    </view>
    
    <!-- æ”¶å…¥é¢„æœŸåˆ—è¡¨ -->
    <view class="budget-list">
      <view class="section-header">
        <text class="section-title">åˆ†ç±»é¢„æœŸ</text>
        <view class="add-budget-btn" bindtap="showAddDialog">
          <text class="iconfont icon-add"></text>
          <text>æ·»åŠ </text>
        </view>
      </view>
      
      <!-- åŠ è½½ä¸­çŠ¶æ€ -->
      <view wx:if="{{loading}}" class="loading-state">
        <view class="loading-spinner"></view>
        <text>åŠ è½½ä¸­...</text>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{incomeExpectations.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ’°</view>
        <text>è¿˜æ²¡æœ‰è®¾ç½®æ”¶å…¥é¢„æœŸ</text>
        <button class="add-first-btn" bindtap="showAddDialog">æ·»åŠ ç¬¬ä¸€ä¸ªé¢„æœŸ</button>
      </view>
      
      <!-- æ”¶å…¥é¢„æœŸé¡¹åˆ—è¡¨ -->
      <view wx:else class="budget-items">
        <view 
          wx:for="{{incomeExpectations}}" 
          wx:key="id"
          class="budget-item income-item {{item.isUnderExpected ? 'under-expected-item' : ''}}"
          bindtap="showEditDialog"
          data-item="{{item}}"
          data-id="{{item.id || item._id}}"
        >
          <view class="budget-header">
            <view class="category-info">
              <text class="category-name">{{item.categoryName}}</text>
              <text class="budget-amount income">é¢„æœŸ: Â¥{{item.formattedAmount}}</text>
            </view>
            <view class="budget-actions">
              <view 
                class="action-btn edit"
                catchtap="showEditDialog"
                data-item="{{item}}"
                data-id="{{item.id || item._id}}"
              >
                ç¼–è¾‘
              </view>
              <view 
                class="action-btn delete"
                catchtap="onDelete"
                data-item="{{item}}"
                data-id="{{item.id || item._id}}"
              >
                åˆ é™¤
              </view>
            </view>
          </view>
          
          <view class="budget-progress">
            <view class="progress-bar-container">
              <view class="progress-bar">
                <view 
                  class="progress-fill income-progress"
                  style="width: {{item.progress}}%"
                ></view>
              </view>
            </view>
            
            <view class="progress-details">
              <view class="progress-info">
                <text class="spent-amount income">
                  å·²æ”¶å…¥: Â¥{{item.formattedReceived}}
                </text>
                <text class="progress-percent">{{item.progressPercent}}%</text>
              </view>
              
              <view class="remaining-info">
                <text class="remaining-amount {{item.remaining >= 0 ? 'expense' : 'income'}}">
                  {{item.remaining >= 0 ? 'å¾…æ”¶å…¥: ' : 'è¶…é¢: '}}Â¥{{item.formattedRemaining}}
                </text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æ·»åŠ å¯¹è¯æ¡† -->
  <view wx:if="{{showAddDialog}}" class="dialog-overlay" bindtap="closeDialog">
    <view class="dialog" catchtap="noop">
      <view class="dialog-header">
        <text class="dialog-title">{{currentTab === 0 ? 'æ·»åŠ é¢„ç®—' : 'æ·»åŠ æ”¶å…¥é¢„æœŸ'}}</text>
        <view class="close-btn" bindtap="closeDialog">Ã—</view>
      </view>
      
      <view class="dialog-content">
        <!-- é€‰æ‹©åˆ†ç±» -->
        <view class="form-group">
          <view class="label">é€‰æ‹©åˆ†ç±»</view>
          <picker 
            mode="selector" 
            range="{{currentTab === 0 ? expenseCategories : incomeCategories}}"
            range-key="name"
            value="{{-1}}"
            bindchange="onCategoryChange"
          >
            <view class="picker {{errors.category ? 'error' : ''}}">
              {{formData.categoryName || 'è¯·é€‰æ‹©åˆ†ç±»'}}
            </view>
          </picker>
          <view wx:if="{{errors.category}}" class="error-text">{{errors.category}}</view>
        </view>
        
        <!-- é‡‘é¢ -->
        <view class="form-group">
          <view class="label">{{currentTab === 0 ? 'é¢„ç®—é‡‘é¢' : 'é¢„æœŸé‡‘é¢'}}</view>
          <input 
            class="input {{errors.amount ? 'error' : ''}}"
            type="digit"
            placeholder="{{currentTab === 0 ? 'è¯·è¾“å…¥é¢„ç®—é‡‘é¢' : 'è¯·è¾“å…¥é¢„æœŸé‡‘é¢'}}"
            value="{{formData.amount}}"
            bindinput="onAmountInput"
          />
          <view wx:if="{{errors.amount}}" class="error-text">{{errors.amount}}</view>
        </view>
        
        <!-- å‘¨æœŸ -->
        <view class="form-group">
          <view class="label">{{currentTab === 0 ? 'é¢„ç®—å‘¨æœŸ' : 'é¢„æœŸå‘¨æœŸ'}}</view>
          <picker 
            mode="selector" 
            range="{{['æ¯æœˆ', 'æ¯å¹´']}}"
            value="{{formData.period === 'monthly' ? 0 : 1}}"
            bindchange="onPeriodChange"
          >
            <view class="picker">
              {{formData.period === 'monthly' ? 'æ¯æœˆ' : 'æ¯å¹´'}}
            </view>
          </picker>
        </view>
      </view>
      
      <view class="dialog-footer">
        <button class="btn cancel" bindtap="closeDialog">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="onSave">ä¿å­˜</button>
      </view>
    </view>
  </view>
  
  <!-- ç¼–è¾‘å¯¹è¯æ¡† -->
  <view wx:if="{{showEditDialog}}" class="dialog-overlay" bindtap="closeDialog">
    <view class="dialog" catchtap="noop">
      <view class="dialog-header">
        <text class="dialog-title">{{currentTab === 0 ? 'ç¼–è¾‘é¢„ç®—' : 'ç¼–è¾‘æ”¶å…¥é¢„æœŸ'}}</text>
        <view class="close-btn" bindtap="closeDialog">Ã—</view>
      </view>
      
      <view class="dialog-content">
        <!-- åˆ†ç±»æ˜¾ç¤ºï¼ˆä¸å¯ç¼–è¾‘ï¼‰ -->
        <view class="form-group">
          <view class="label">åˆ†ç±»</view>
          <view class="category-display">{{formData.categoryName}}</view>
        </view>
        
        <!-- é‡‘é¢ -->
        <view class="form-group">
          <view class="label">{{currentTab === 0 ? 'é¢„ç®—é‡‘é¢' : 'é¢„æœŸé‡‘é¢'}}</view>
          <input 
            class="input {{errors.amount ? 'error' : ''}}"
            type="digit"
            placeholder="{{currentTab === 0 ? 'è¯·è¾“å…¥é¢„ç®—é‡‘é¢' : 'è¯·è¾“å…¥é¢„æœŸé‡‘é¢'}}"
            value="{{formData.amount}}"
            bindinput="onAmountInput"
          />
          <view wx:if="{{errors.amount}}" class="error-text">{{errors.amount}}</view>
        </view>
        
        <!-- å‘¨æœŸ -->
        <view class="form-group">
          <view class="label">{{currentTab === 0 ? 'é¢„ç®—å‘¨æœŸ' : 'é¢„æœŸå‘¨æœŸ'}}</view>
          <picker 
            mode="selector" 
            range="{{['æ¯æœˆ', 'æ¯å¹´']}}"
            value="{{formData.period === 'monthly' ? 0 : 1}}"
            bindchange="onPeriodChange"
          >
            <view class="picker">
              {{formData.period === 'monthly' ? 'æ¯æœˆ' : 'æ¯å¹´'}}
            </view>
          </picker>
        </view>
      </view>
      
      <view class="dialog-footer">
        <button class="btn cancel" bindtap="closeDialog">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="onSave">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æœˆä»½é€‰æ‹©å™¨å¼¹çª— - ä¼˜åŒ–äº¤äº’ä½“éªŒ -->
  <view wx:if="{{showMonthPicker}}" class="month-picker-overlay" bindtap="hideMonthPicker">
    <view class="month-picker-container" catchtap="noop">
      <view class="month-picker-header">
        <text class="month-picker-title">é€‰æ‹©æŸ¥çœ‹æœˆä»½</text>
        <view class="month-picker-close" bindtap="cancelMonthPicker">Ã—</view>
      </view>
      
      <view class="month-picker-content">
        <!-- å¹´æœˆè”åˆé€‰æ‹©å™¨ -->
        <view class="picker-section">
          <view class="picker-label">é€‰æ‹©å¹´æœˆ</view>
          <picker 
            mode="date"
            fields="month"
            value="{{datePickerValue}}"
            end="{{currentDate}}"
            bindchange="onDatePickerChange"
          >
            <view class="picker-display">
              {{selectedYear}}å¹´{{selectedMonth + 1}}æœˆ
            </view>
          </picker>
        </view>
        
        <!-- å¿«é€Ÿé€‰æ‹©é€‰é¡¹ -->
        <view class="picker-section">
          <view class="picker-label">å¿«é€Ÿé€‰æ‹©</view>
          <view class="quick-select-options">
            <view 
              class="quick-option {{isCurrentMonth ? 'active' : ''}}"
              bindtap="selectCurrentMonth"
            >
              æœ¬æœˆ
            </view>
            <view 
              class="quick-option {{isLastMonth ? 'active' : ''}}"
              bindtap="selectLastMonth"
            >
              ä¸Šæœˆ
            </view>
            <view 
              class="quick-option {{isThreeMonthsAgo ? 'active' : ''}}"
              bindtap="selectThreeMonthsAgo"
            >
              ä¸‰ä¸ªæœˆå‰
            </view>
          </view>
        </view>
      </view>
      
      <view class="month-picker-footer">
        <button class="picker-btn cancel" bindtap="cancelMonthPicker">å–æ¶ˆ</button>
        <button class="picker-btn confirm" bindtap="confirmMonthPicker">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>