<!--pages/operation-logs/operation-logs.wxml-->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="操作日志" show-back="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- 搜索和筛选区域 -->
  <view class="search-filter-section">
    <!-- 搜索框 -->
    <view class="search-container">
      <input 
        class="search-input" 
        value="{{searchKeyword}}" 
        placeholder="搜索操作记录..." 
        bind:input="onSearchInput"
        bind:confirm="onSearchConfirm"
      />
      <view wx:if="{{searchKeyword}}" class="search-clear" bind:tap="onSearchClear">
        <text class="clear-icon">✕</text>
      </view>
    </view>
    
    <!-- 简化的筛选标签 -->
    <view class="filter-tabs">
      <view 
        wx:for="{{filterTabs}}" 
        wx:key="value"
        class="filter-tab {{activeFilter === item.value ? 'active' : ''}}"
        bind:tap="onFilterTabChange"
        data-filter="{{item.value}}"
      >
        <text class="tab-text">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- 统计信息卡片 -->
  <view wx:if="{{logs.length > 0}}" class="stats-summary">
    <view class="summary-item">
      <text class="summary-number">{{stats.total || logs.length}}</text>
      <text class="summary-label">总记录</text>
    </view>
    <view class="summary-item">
      <text class="summary-number">{{stats.todayCount || 0}}</text>
      <text class="summary-label">今日</text>
    </view>
    <view class="summary-item">
      <text class="summary-number">{{stats.activeUsers || 0}}</text>
      <text class="summary-label">活跃用户</text>
    </view>
  </view>

  <!-- 操作日志列表 -->
  <view class="logs-container">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
    
    <!-- 空状态 -->
    <view wx:elif="{{logs.length === 0}}" class="empty-container">
      <view class="empty-icon">📝</view>
      <text class="empty-title">{{searchKeyword ? '未找到相关记录' : '暂无操作记录'}}</text>
      <text class="empty-desc">{{searchKeyword ? '尝试调整搜索条件' : '开始使用后会显示操作记录'}}</text>
    </view>
    
    <!-- 时间轴日志列表 -->
    <view wx:else class="timeline-container">
      <view wx:for="{{groupedLogs}}" wx:key="date" class="timeline-group">
        <!-- 日期分隔线 -->
        <view class="date-divider">
          <view class="date-line"></view>
          <view class="date-badge">
            <text class="date-text">{{item.dateLabel || item.date}}</text>
            <text class="count-text">{{item.logs.length}}条</text>
          </view>
          <view class="date-line"></view>
        </view>
        
        <!-- 该日期下的日志卡片 -->
        <view class="timeline-logs">
          <view wx:for="{{item.logs}}" wx:for-item="log" wx:key="id" class="timeline-item">
            <!-- 时间轴标记 -->
            <view class="timeline-marker">
              <view class="marker-dot {{log.level || 'info'}}"></view>
              <view wx:if="{{!log.isLast}}" class="marker-line"></view>
            </view>
            
            <!-- 日志卡片 -->
            <view class="log-card" bind:tap="toggleLogDetail" data-log-id="{{log.id}}">
              <!-- 卡片头部 -->
              <view class="card-header">
                <view class="user-info">
                  <view class="user-avatar">
                    <image wx:if="{{log.userAvatar}}" src="{{log.userAvatar}}" class="avatar-img" />
                    <text wx:else class="avatar-text">{{log.userInitial || '系'}}</text>
                  </view>
                  <view class="user-details">
                    <text class="user-name">{{log.userName || '系统'}}</text>
                    <view class="user-meta">
                      <text class="user-role {{log.userRole || 'system'}}">
                        {{log.userRole === 'owner' ? '创建者' : log.userRole === 'admin' ? '管理员' : log.userRole === 'member' ? '成员' : '系统'}}
                      </text>
                      <text class="log-time">{{log.timeDisplay || log.time}}</text>
                    </view>
                  </view>
                </view>
                <view class="log-status {{log.level || 'info'}}">
                  <text class="status-text">
                    {{log.level === 'success' ? '成功' : log.level === 'error' ? '错误' : log.level === 'warning' ? '警告' : '信息'}}
                  </text>
                </view>
              </view>
              
              <!-- 卡片主体 -->
              <view class="card-body">
                <text class="operation-title">{{log.operationName || log.action || '未知操作'}}</text>
                <text wx:if="{{log.summary || log.details}}" class="operation-desc">{{log.summary || log.details}}</text>
                
                <!-- 操作标签 -->
                <view wx:if="{{log.tags && log.tags.length > 0}}" class="operation-tags">
                  <view wx:for="{{log.tags}}" wx:for-item="tag" wx:key="*this" class="tag">
                    <text class="tag-text">{{tag}}</text>
                  </view>
                </view>
                
                <!-- 数据变更 -->
                <view wx:if="{{log.changes && log.changes.length > 0}}" class="data-changes">
                  <view wx:for="{{log.changes}}" wx:for-item="change" wx:key="field" class="change-item">
                    <text class="change-field">{{change.field}}</text>
                    <view class="change-values">
                      <text class="old-value">{{change.oldValue}}</text>
                      <text class="arrow">→</text>
                      <text class="new-value">{{change.newValue}}</text>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- 操作结果 -->
              <view wx:if="{{log.result}}" class="card-footer">
                <view class="result-indicator {{log.result.success ? 'success' : 'error'}}">
                  <text class="result-icon">{{log.result.success ? '✓' : '✗'}}</text>
                  <text class="result-text">{{log.result.success ? '执行成功' : '执行失败'}}</text>
                </view>
                <text wx:if="{{log.result.message}}" class="result-message">{{log.result.message}}</text>
              </view>
              
              <!-- 展开详情 -->
              <view wx:if="{{log.expanded}}" class="card-details">
                <view class="details-divider"></view>
                
                <!-- 详细信息 -->
                <view wx:if="{{log.detailItems && log.detailItems.length > 0}}" class="detail-section">
                  <text class="detail-title">详细信息</text>
                  <view class="detail-items">
                    <view wx:for="{{log.detailItems}}" wx:key="key" class="detail-row">
                      <text class="detail-label">{{item.key}}</text>
                      <text class="detail-value">{{item.value}}</text>
                    </view>
                  </view>
                </view>
                
                <!-- 影响数据 -->
                <view wx:if="{{log.affectedData && log.affectedData.length > 0}}" class="detail-section">
                  <text class="detail-title">影响数据</text>
                  <view class="affected-tags">
                    <view wx:for="{{log.affectedData}}" wx:key="type" class="affected-tag">
                      <text class="affected-type">{{item.type}}</text>
                      <text class="affected-count">{{item.count}}</text>
                    </view>
                  </view>
                </view>
                
                <!-- 操作按钮 -->
                <view class="detail-actions">
                  <view class="action-btn" bind:tap="copyLogInfo" data-log-id="{{log.id}}">
                    <text class="action-icon">📋</text>
                    <text class="action-text">复制</text>
                  </view>
                  <view wx:if="{{log.canRevert}}" class="action-btn" bind:tap="revertOperation" data-log-id="{{log.id}}">
                    <text class="action-icon">↶</text>
                    <text class="action-text">撤销</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 加载更多 -->
    <view wx:if="{{hasMore && logs.length > 0}}" class="load-more">
      <view wx:if="{{loadingMore}}" class="loading-more">
        <view class="loading-spinner small"></view>
        <text class="loading-text">加载更多...</text>
      </view>
      <view wx:else class="load-more-btn" bind:tap="loadMore">
        <text class="load-more-text">加载更多</text>
      </view>
    </view>

    <!-- 到底提示 -->
    <view wx:if="{{!hasMore && logs.length > 0}}" class="end-tip">
      <text class="end-text">已显示全部日志</text>
    </view>
  </view>

  <!-- 浮动操作按钮 -->
  <view class="fab-container">
    <view class="fab-menu {{fabExpanded ? 'expanded' : ''}}" bind:tap="toggleFab">
      <view class="fab-item" bind:tap="exportLogs">
        <text class="fab-icon">📤</text>
        <text class="fab-text">导出</text>
      </view>
      <view class="fab-item" bind:tap="clearFilters">
        <text class="fab-icon">🔄</text>
        <text class="fab-text">重置</text>
      </view>
      <view class="fab-main">
        <text class="fab-icon">{{fabExpanded ? '✕' : '⋯'}}</text>
      </view>
    </view>
  </view>
</view>