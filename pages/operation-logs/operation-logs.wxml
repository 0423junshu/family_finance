<!--pages/operation-logs/operation-logs.wxml-->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="æ“ä½œæ—¥å¿—" show-back="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
  <view class="search-filter-section">
    <!-- æœç´¢æ¡† -->
    <view class="search-container">
      <input 
        class="search-input" 
        value="{{searchKeyword}}" 
        placeholder="æœç´¢æ“ä½œè®°å½•..." 
        bind:input="onSearchInput"
        bind:confirm="onSearchConfirm"
      />
      <view wx:if="{{searchKeyword}}" class="search-clear" bind:tap="onSearchClear">
        <text class="clear-icon">âœ•</text>
      </view>
    </view>
    
    <!-- ç®€åŒ–çš„ç­›é€‰æ ‡ç­¾ -->
    <view class="filter-tabs">
      <view 
        wx:for="{{filterTabs}}" 
        wx:key="value"
        class="filter-tab {{activeFilter === item.value ? 'active' : ''}}"
        bind:tap="onFilterTabChange"
        data-filter="{{item.value}}"
      >
        <text class="tab-text">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
  <view wx:if="{{logs.length > 0}}" class="stats-summary">
    <view class="summary-item">
      <text class="summary-number">{{stats.total || logs.length}}</text>
      <text class="summary-label">æ€»è®°å½•</text>
    </view>
    <view class="summary-item">
      <text class="summary-number">{{stats.todayCount || 0}}</text>
      <text class="summary-label">ä»Šæ—¥</text>
    </view>
    <view class="summary-item">
      <text class="summary-number">{{stats.activeUsers || 0}}</text>
      <text class="summary-label">æ´»è·ƒç”¨æˆ·</text>
    </view>
  </view>

  <!-- æ“ä½œæ—¥å¿—åˆ—è¡¨ -->
  <view class="logs-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{logs.length === 0}}" class="empty-container">
      <view class="empty-icon">ğŸ“</view>
      <text class="empty-title">{{searchKeyword ? 'æœªæ‰¾åˆ°ç›¸å…³è®°å½•' : 'æš‚æ— æ“ä½œè®°å½•'}}</text>
      <text class="empty-desc">{{searchKeyword ? 'å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶' : 'å¼€å§‹ä½¿ç”¨åä¼šæ˜¾ç¤ºæ“ä½œè®°å½•'}}</text>
    </view>
    
    <!-- æ—¶é—´è½´æ—¥å¿—åˆ—è¡¨ -->
    <view wx:else class="timeline-container">
      <view wx:for="{{groupedLogs}}" wx:key="date" class="timeline-group">
        <!-- æ—¥æœŸåˆ†éš”çº¿ -->
        <view class="date-divider">
          <view class="date-line"></view>
          <view class="date-badge">
            <text class="date-text">{{item.dateLabel || item.date}}</text>
            <text class="count-text">{{item.logs.length}}æ¡</text>
          </view>
          <view class="date-line"></view>
        </view>
        
        <!-- è¯¥æ—¥æœŸä¸‹çš„æ—¥å¿—å¡ç‰‡ -->
        <view class="timeline-logs">
          <view wx:for="{{item.logs}}" wx:for-item="log" wx:key="id" class="timeline-item">
            <!-- æ—¶é—´è½´æ ‡è®° -->
            <view class="timeline-marker">
              <view class="marker-dot {{log.level || 'info'}}"></view>
              <view wx:if="{{!log.isLast}}" class="marker-line"></view>
            </view>
            
            <!-- æ—¥å¿—å¡ç‰‡ -->
            <view class="log-card" bind:tap="toggleLogDetail" data-log-id="{{log.id}}">
              <!-- å¡ç‰‡å¤´éƒ¨ -->
              <view class="card-header">
                <view class="user-info">
                  <view class="user-avatar">
                    <image wx:if="{{log.userAvatar}}" src="{{log.userAvatar}}" class="avatar-img" />
                    <text wx:else class="avatar-text">{{log.userInitial || 'ç³»'}}</text>
                  </view>
                  <view class="user-details">
                    <text class="user-name">{{log.userName || 'ç³»ç»Ÿ'}}</text>
                    <view class="user-meta">
                      <text class="user-role {{log.userRole || 'system'}}">
                        {{log.userRole === 'owner' ? 'åˆ›å»ºè€…' : log.userRole === 'admin' ? 'ç®¡ç†å‘˜' : log.userRole === 'member' ? 'æˆå‘˜' : 'ç³»ç»Ÿ'}}
                      </text>
                      <text class="log-time">{{log.timeDisplay || log.time}}</text>
                    </view>
                  </view>
                </view>
                <view class="log-status {{log.level || 'info'}}">
                  <text class="status-text">
                    {{log.level === 'success' ? 'æˆåŠŸ' : log.level === 'error' ? 'é”™è¯¯' : log.level === 'warning' ? 'è­¦å‘Š' : 'ä¿¡æ¯'}}
                  </text>
                </view>
              </view>
              
              <!-- å¡ç‰‡ä¸»ä½“ -->
              <view class="card-body">
                <text class="operation-title">{{log.operationName || log.action || 'æœªçŸ¥æ“ä½œ'}}</text>
                <text wx:if="{{log.summary || log.details}}" class="operation-desc">{{log.summary || log.details}}</text>
                
                <!-- æ“ä½œæ ‡ç­¾ -->
                <view wx:if="{{log.tags && log.tags.length > 0}}" class="operation-tags">
                  <view wx:for="{{log.tags}}" wx:for-item="tag" wx:key="*this" class="tag">
                    <text class="tag-text">{{tag}}</text>
                  </view>
                </view>
                
                <!-- æ•°æ®å˜æ›´ -->
                <view wx:if="{{log.changes && log.changes.length > 0}}" class="data-changes">
                  <view wx:for="{{log.changes}}" wx:for-item="change" wx:key="field" class="change-item">
                    <text class="change-field">{{change.field}}</text>
                    <view class="change-values">
                      <text class="old-value">{{change.oldValue}}</text>
                      <text class="arrow">â†’</text>
                      <text class="new-value">{{change.newValue}}</text>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- æ“ä½œç»“æœ -->
              <view wx:if="{{log.result}}" class="card-footer">
                <view class="result-indicator {{log.result.success ? 'success' : 'error'}}">
                  <text class="result-icon">{{log.result.success ? 'âœ“' : 'âœ—'}}</text>
                  <text class="result-text">{{log.result.success ? 'æ‰§è¡ŒæˆåŠŸ' : 'æ‰§è¡Œå¤±è´¥'}}</text>
                </view>
                <text wx:if="{{log.result.message}}" class="result-message">{{log.result.message}}</text>
              </view>
              
              <!-- å±•å¼€è¯¦æƒ… -->
              <view wx:if="{{log.expanded}}" class="card-details">
                <view class="details-divider"></view>
                
                <!-- è¯¦ç»†ä¿¡æ¯ -->
                <view wx:if="{{log.detailItems && log.detailItems.length > 0}}" class="detail-section">
                  <text class="detail-title">è¯¦ç»†ä¿¡æ¯</text>
                  <view class="detail-items">
                    <view wx:for="{{log.detailItems}}" wx:key="key" class="detail-row">
                      <text class="detail-label">{{item.key}}</text>
                      <text class="detail-value">{{item.value}}</text>
                    </view>
                  </view>
                </view>
                
                <!-- å½±å“æ•°æ® -->
                <view wx:if="{{log.affectedData && log.affectedData.length > 0}}" class="detail-section">
                  <text class="detail-title">å½±å“æ•°æ®</text>
                  <view class="affected-tags">
                    <view wx:for="{{log.affectedData}}" wx:key="type" class="affected-tag">
                      <text class="affected-type">{{item.type}}</text>
                      <text class="affected-count">{{item.count}}</text>
                    </view>
                  </view>
                </view>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <view class="detail-actions">
                  <view class="action-btn" bind:tap="copyLogInfo" data-log-id="{{log.id}}">
                    <text class="action-icon">ğŸ“‹</text>
                    <text class="action-text">å¤åˆ¶</text>
                  </view>
                  <view wx:if="{{log.canRevert}}" class="action-btn" bind:tap="revertOperation" data-log-id="{{log.id}}">
                    <text class="action-icon">â†¶</text>
                    <text class="action-text">æ’¤é”€</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore && logs.length > 0}}" class="load-more">
      <view wx:if="{{loadingMore}}" class="loading-more">
        <view class="loading-spinner small"></view>
        <text class="loading-text">åŠ è½½æ›´å¤š...</text>
      </view>
      <view wx:else class="load-more-btn" bind:tap="loadMore">
        <text class="load-more-text">åŠ è½½æ›´å¤š</text>
      </view>
    </view>

    <!-- åˆ°åº•æç¤º -->
    <view wx:if="{{!hasMore && logs.length > 0}}" class="end-tip">
      <text class="end-text">å·²æ˜¾ç¤ºå…¨éƒ¨æ—¥å¿—</text>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-menu {{fabExpanded ? 'expanded' : ''}}" bind:tap="toggleFab">
      <view class="fab-item" bind:tap="exportLogs">
        <text class="fab-icon">ğŸ“¤</text>
        <text class="fab-text">å¯¼å‡º</text>
      </view>
      <view class="fab-item" bind:tap="clearFilters">
        <text class="fab-icon">ğŸ”„</text>
        <text class="fab-text">é‡ç½®</text>
      </view>
      <view class="fab-main">
        <text class="fab-icon">{{fabExpanded ? 'âœ•' : 'â‹¯'}}</text>
      </view>
    </view>
  </view>
</view>