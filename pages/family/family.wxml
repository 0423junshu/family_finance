<!--pages/family/family.wxml-->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="å®¶åº­ç®¡ç†" showBack="{{false}}" class="transparent-navbar">
    <view slot="right" wx:if="{{familyInfo && canEditName}}" class="nav-edit-btn" bind:tap="toggleEditMode">
      <text class="edit-icon">{{isEditingName ? 'âœ“' : 'âœï¸'}}</text>
    </view>
  </navigation-bar>
</view>

<view class="page-container">
  <!-- å®¶åº­ä¿¡æ¯ + æˆå‘˜ï¼ˆåˆå¹¶å¡ç‰‡ï¼‰ -->
  <view wx:if="{{familyInfo}}" class="card family-basic-info">
    <view class="family-header">
      <view class="family-title-section">
        <view wx:if="{{!isEditingName}}" class="family-name-display">
          <text class="family-name">{{familyInfo.name || 'æˆ‘çš„å®¶åº­'}}</text>
          <text wx:if="{{canEditName}}" class="inline-edit-btn" bind:tap="toggleEditMode">âœï¸</text>
        </view>
        <view wx:if="{{isEditingName}}" class="family-name-edit">
          <input 
            class="family-name-input" 
            value="{{editingName}}" 
            placeholder="è¯·è¾“å…¥å®¶åº­åç§°"
            maxlength="20"
            bind:input="onNameInput"
            bind:confirm="saveFamilyName"
            focus="{{isEditingName}}"
          />
          <view class="edit-actions">
            <text class="edit-btn save" bind:tap="saveFamilyName">ä¿å­˜</text>
            <text class="edit-btn cancel" bind:tap="cancelEdit">å–æ¶ˆ</text>
          </view>
        </view>
        <view class="role-badge {{familyInfo.role}}">
          {{familyInfo.role === 'owner' ? 'åˆ›å»ºè€…' : (familyInfo.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æˆå‘˜')}}
        </view>
      </view>

      <view class="family-header-actions">
        <text class="member-count">{{familyInfo.memberCount || 0}}ä½æˆå‘˜</text>
        <view wx:if="{{canInvite}}" class="invite-member-btn" bind:tap="copyFamilyCodeForInvite">
          <text class="invite-icon">ğŸ‘¥</text>
          <text class="invite-text">é‚€è¯·æ–°æˆå‘˜</text>
        </view>
      </view>
    </view>

    <!-- åˆå¹¶åçš„æˆå‘˜åˆ—è¡¨ -->
    <view class="members-list merged">
      <block wx:for="{{members}}" wx:key="id">
        <view class="member-item {{canManageMemberPermissions(item) ? 'clickable' : ''}}" bind:tap="onMemberTap" data-member="{{item}}">
          <view class="member-avatar-container">
            <view class="member-avatar" style="background-image: url({{item.avatar}})">
              {{!item.avatar ? item.nickname.charAt(0) : ''}}
            </view>
            <view wx:if="{{item.isOnline}}" class="online-indicator"></view>
          </view>
          <view class="member-info">
            <view class="member-main">
              <text class="member-name">{{item.nickname}}</text>
              <view class="member-role-badge {{item.role}}">{{item.roleText}}</view>
            </view>
            <view class="member-status">
              <text class="status-dot {{item.isOnline ? 'online' : 'offline'}}">â—</text>
              <text class="status-text">{{item.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
            </view>
          </view>
          <view wx:if="{{canManageMembers}}" class="member-arrow">â€º</view>
        </view>
      </block>
      <view wx:if="{{members.length === 0}}" class="empty-members">
        <text class="empty-icon">ğŸ‘¥</text>
        <text class="empty-text">æš‚æ— å…¶ä»–æˆå‘˜</text>
        <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’"é‚€è¯·æ–°æˆå‘˜"æŒ‰é’®é‚€è¯·å®¶äººåŠ å…¥</text>
      </view>
    </view>
  </view>

  <!-- æœªåŠ å…¥å®¶åº­æç¤ºå¡ç‰‡ -->
  <view wx:if="{{!familyInfo}}" class="card no-family-card">
    <view class="no-family-content">
      <view class="no-family-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</view>
      <text class="no-family-title">è¿˜æœªåŠ å…¥å®¶åº­</text>
      <text class="no-family-desc">åˆ›å»ºæ–°å®¶åº­æˆ–åŠ å…¥ç°æœ‰å®¶åº­ï¼Œå¼€å§‹åä½œç®¡ç†è´¢åŠ¡</text>
      <view class="no-family-actions">
        <t-button theme="primary" bind:tap="createFamily">åˆ›å»ºå®¶åº­</t-button>
        <t-button theme="light" bind:tap="joinFamily">åŠ å…¥å®¶åº­</t-button>
      </view>
    </view>
  </view>

  

  

  <!-- æ•°æ®åŒæ­¥çŠ¶æ€ -->
  <view class="card sync-status-card">
    <view class="card-header">
      <text class="card-title">æ•°æ®åŒæ­¥</text>
      <view class="refresh-btn" bind:tap="refreshData">
        <text class="refresh-icon">ğŸ”„</text>
        <text class="refresh-text">åˆ·æ–°</text>
      </view>
    </view>
    
    <view class="sync-info">
      <view class="sync-status {{syncStatus}}">
        <text class="status-dot"></text>
        <text class="status-text">{{syncStatus === 'synced' ? 'å·²åŒæ­¥' : (syncStatus === 'syncing' ? 'åŒæ­¥ä¸­...' : 'åŒæ­¥å¼‚å¸¸')}}</text>
      </view>
      <text class="last-sync-time">æœ€ååŒæ­¥ï¼šåˆšåˆš</text>
    </view>
  </view>

  <!-- æƒé™ç¼–è¾‘å¼¹çª— -->
  <view wx:if="{{showPermModal}}" class="perm-modal-mask" catchtouchmove="true">
    <view class="perm-modal">
      <view class="perm-modal-header">
        <text class="perm-modal-title">æˆå‘˜æƒé™</text>
        <text class="perm-modal-subtitle">{{selectedMember.nickname}}</text>
      </view>
      <view class="perm-modal-body">
        <view class="perm-row">
          <text class="perm-label">å¯ç¼–è¾‘</text>
          <switch checked="{{permDraft.canEdit}}" bindchange="onPermEditChange"/>
        </view>
        <view class="perm-row">
          <text class="perm-label">å¯åˆ é™¤</text>
          <switch checked="{{permDraft.canDelete}}" bindchange="onPermDeleteChange"/>
        </view>
        <view class="perm-row">
          <text class="perm-label">å¯å¯¼å‡º</text>
          <switch checked="{{permDraft.canExport}}" bindchange="onPermExportChange"/>
        </view>
        <view class="perm-tip">æ‰€æœ‰æˆå‘˜é»˜è®¤æ‹¥æœ‰â€œæŸ¥çœ‹â€æƒé™</view>
      </view>
      <view class="perm-modal-actions">
        <button class="btn cancel" bindtap="closePermModal">å–æ¶ˆ</button>
        <button class="btn save" bindtap="saveMemberPerms" loading="{{savingPerms}}">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæ—¥å¿—ï¼ˆå†…åµŒæœ¬é¡µåº•éƒ¨ï¼‰ -->
  <view class="card logs-card">
    <view class="card-header">
      <text class="card-title">æ“ä½œæ—¥å¿—</text>
    </view>

    <view class="logs-filters">
      <picker mode="selector" range="{{logTypeOptions}}" value="{{logTypeIndex}}" bindchange="onLogTypeChange">
        <view class="filter-item">
          <text class="filter-label">ç±»å‹</text>
          <text class="filter-value">{{logTypeOptions[logTypeIndex]}}</text>
        </view>
      </picker>

      <picker mode="selector" range="{{memberOptions}}" value="{{memberIndex}}" bindchange="onLogMemberChange">
        <view class="filter-item">
          <text class="filter-label">æˆå‘˜</text>
          <text class="filter-value">{{memberOptions[memberIndex]}}</text>
        </view>
      </picker>

      <picker mode="selector" range="{{timeRangeOptions}}" value="{{timeRangeIndex}}" bindchange="onLogTimeRangeChange">
        <view class="filter-item">
          <text class="filter-label">æ—¶é—´</text>
          <text class="filter-value">{{timeRangeOptions[timeRangeIndex]}}</text>
        </view>
      </picker>
    </view>

    <view class="logs-list">
      <block wx:for="{{filteredLogs}}" wx:key="id">
        <view class="log-item">
          <view class="log-top">
            <text class="log-type">{{item.typeText}}</text>
            <text class="log-time">{{item.timeText}}</text>
          </view>
          <view class="log-middle">
            <text class="log-actor">{{item.userName || 'ç³»ç»Ÿ'}}</text>
            <text class="log-action">{{item.actionText}}</text>
          </view>
          <view wx:if="{{item.detail}}" class="log-detail">{{item.detail}}</view>
        </view>
      </block>

      <view wx:if="{{filteredLogs.length === 0}}" class="logs-empty">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">æš‚æ— æ—¥å¿—</text>
      </view>
    </view>
  </view>
</view>



<!-- Toast æç¤º -->
<t-toast id="t-toast" />

<!-- Dialog å¯¹è¯æ¡† -->
<t-dialog id="t-dialog" />