<!--pages/family/family.wxml-->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="家庭管理" showBack="{{false}}" class="transparent-navbar">
    <view slot="right" wx:if="{{familyInfo && canEditName}}" class="nav-edit-btn" bind:tap="toggleEditMode">
      <text class="edit-icon">{{isEditingName ? '✓' : '✏️'}}</text>
    </view>
  </navigation-bar>
</view>

<view class="page-container">
  <!-- 家庭信息 + 成员（合并卡片） -->
  <view wx:if="{{familyInfo}}" class="card family-basic-info">
    <view class="family-header">
      <view class="family-title-section">
        <view wx:if="{{!isEditingName}}" class="family-name-display">
          <text class="family-name">{{familyInfo.name || '我的家庭'}}</text>
          <text wx:if="{{canEditName}}" class="inline-edit-btn" bind:tap="toggleEditMode">✏️</text>
        </view>
        <view wx:if="{{isEditingName}}" class="family-name-edit">
          <input 
            class="family-name-input" 
            value="{{editingName}}" 
            placeholder="请输入家庭名称"
            maxlength="20"
            bind:input="onNameInput"
            bind:confirm="saveFamilyName"
            focus="{{isEditingName}}"
          />
          <view class="edit-actions">
            <text class="edit-btn save" bind:tap="saveFamilyName">保存</text>
            <text class="edit-btn cancel" bind:tap="cancelEdit">取消</text>
          </view>
        </view>
        <view class="role-badge {{familyInfo.role}}">
          {{familyInfo.role === 'owner' ? '创建者' : (familyInfo.role === 'admin' ? '管理员' : '成员')}}
        </view>
      </view>

      <view class="family-header-actions">
        <text class="member-count">{{familyInfo.memberCount || 0}}位成员</text>
        <view wx:if="{{canInvite}}" class="invite-member-btn" bind:tap="copyFamilyCodeForInvite">
          <text class="invite-icon">👥</text>
          <text class="invite-text">邀请新成员</text>
        </view>
      </view>
    </view>

    <!-- 合并后的成员列表 -->
    <view class="members-list merged">
      <block wx:for="{{members}}" wx:key="id">
        <view class="member-item {{canManageMemberPermissions(item) ? 'clickable' : ''}}" bind:tap="onMemberTap" data-member="{{item}}">
          <view class="member-avatar-container">
            <view class="member-avatar" style="background-image: url({{item.avatar}})">
              {{!item.avatar ? item.nickname.charAt(0) : ''}}
            </view>
            <view wx:if="{{item.isOnline}}" class="online-indicator"></view>
          </view>
          <view class="member-info">
            <view class="member-main">
              <text class="member-name">{{item.nickname}}</text>
              <view class="member-role-badge {{item.role}}">{{item.roleText}}</view>
            </view>
            <view class="member-status">
              <text class="status-dot {{item.isOnline ? 'online' : 'offline'}}">●</text>
              <text class="status-text">{{item.isOnline ? '在线' : '离线'}}</text>
            </view>
          </view>
          <view wx:if="{{canManageMembers}}" class="member-arrow">›</view>
        </view>
      </block>
      <view wx:if="{{members.length === 0}}" class="empty-members">
        <text class="empty-icon">👥</text>
        <text class="empty-text">暂无其他成员</text>
        <text class="empty-hint">点击右上角"邀请新成员"按钮邀请家人加入</text>
      </view>
    </view>
  </view>

  <!-- 未加入家庭提示卡片 -->
  <view wx:if="{{!familyInfo}}" class="card no-family-card">
    <view class="no-family-content">
      <view class="no-family-icon">👨‍👩‍👧‍👦</view>
      <text class="no-family-title">还未加入家庭</text>
      <text class="no-family-desc">创建新家庭或加入现有家庭，开始协作管理财务</text>
      <view class="no-family-actions">
        <t-button theme="primary" bind:tap="createFamily">创建家庭</t-button>
        <t-button theme="light" bind:tap="joinFamily">加入家庭</t-button>
      </view>
    </view>
  </view>

  

  

  <!-- 数据同步状态 -->
  <view class="card sync-status-card">
    <view class="card-header">
      <text class="card-title">数据同步</text>
      <view class="refresh-btn" bind:tap="refreshData">
        <text class="refresh-icon">🔄</text>
        <text class="refresh-text">刷新</text>
      </view>
    </view>
    
    <view class="sync-info">
      <view class="sync-status {{syncStatus}}">
        <text class="status-dot"></text>
        <text class="status-text">{{syncStatus === 'synced' ? '已同步' : (syncStatus === 'syncing' ? '同步中...' : '同步异常')}}</text>
      </view>
      <text class="last-sync-time">最后同步：刚刚</text>
    </view>
  </view>

  <!-- 权限编辑弹窗 -->
  <view wx:if="{{showPermModal}}" class="perm-modal-mask" catchtouchmove="true">
    <view class="perm-modal">
      <view class="perm-modal-header">
        <text class="perm-modal-title">成员权限</text>
        <text class="perm-modal-subtitle">{{selectedMember.nickname}}</text>
      </view>
      <view class="perm-modal-body">
        <view class="perm-row">
          <text class="perm-label">可编辑</text>
          <switch checked="{{permDraft.canEdit}}" bindchange="onPermEditChange"/>
        </view>
        <view class="perm-row">
          <text class="perm-label">可删除</text>
          <switch checked="{{permDraft.canDelete}}" bindchange="onPermDeleteChange"/>
        </view>
        <view class="perm-row">
          <text class="perm-label">可导出</text>
          <switch checked="{{permDraft.canExport}}" bindchange="onPermExportChange"/>
        </view>
        <view class="perm-tip">所有成员默认拥有“查看”权限</view>
      </view>
      <view class="perm-modal-actions">
        <button class="btn cancel" bindtap="closePermModal">取消</button>
        <button class="btn save" bindtap="saveMemberPerms" loading="{{savingPerms}}">保存</button>
      </view>
    </view>
  </view>

  <!-- 操作日志（内嵌本页底部） -->
  <view class="card logs-card">
    <view class="card-header">
      <text class="card-title">操作日志</text>
    </view>

    <view class="logs-filters">
      <picker mode="selector" range="{{logTypeOptions}}" value="{{logTypeIndex}}" bindchange="onLogTypeChange">
        <view class="filter-item">
          <text class="filter-label">类型</text>
          <text class="filter-value">{{logTypeOptions[logTypeIndex]}}</text>
        </view>
      </picker>

      <picker mode="selector" range="{{memberOptions}}" value="{{memberIndex}}" bindchange="onLogMemberChange">
        <view class="filter-item">
          <text class="filter-label">成员</text>
          <text class="filter-value">{{memberOptions[memberIndex]}}</text>
        </view>
      </picker>

      <picker mode="selector" range="{{timeRangeOptions}}" value="{{timeRangeIndex}}" bindchange="onLogTimeRangeChange">
        <view class="filter-item">
          <text class="filter-label">时间</text>
          <text class="filter-value">{{timeRangeOptions[timeRangeIndex]}}</text>
        </view>
      </picker>
    </view>

    <view class="logs-list">
      <block wx:for="{{filteredLogs}}" wx:key="id">
        <view class="log-item">
          <view class="log-top">
            <text class="log-type">{{item.typeText}}</text>
            <text class="log-time">{{item.timeText}}</text>
          </view>
          <view class="log-middle">
            <text class="log-actor">{{item.userName || '系统'}}</text>
            <text class="log-action">{{item.actionText}}</text>
          </view>
          <view wx:if="{{item.detail}}" class="log-detail">{{item.detail}}</view>
        </view>
      </block>

      <view wx:if="{{filteredLogs.length === 0}}" class="logs-empty">
        <text class="empty-icon">📝</text>
        <text class="empty-text">暂无日志</text>
      </view>
    </view>
  </view>
</view>



<!-- Toast 提示 -->
<t-toast id="t-toast" />

<!-- Dialog 对话框 -->
<t-dialog id="t-dialog" />