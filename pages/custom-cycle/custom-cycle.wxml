<!-- pages/custom-cycle/custom-cycle.wxml -->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="è®°è´¦å‘¨æœŸ" showBack="{{true}}" class="transparent-navbar" background="transparent"></navigation-bar>
</view>

<view class="page-container">
  <!-- å½“å‰å‘¨æœŸæ˜¾ç¤º -->
  <view class="current-cycle-card">
    <view class="card-header">
      <text class="card-title">å½“å‰å‘¨æœŸ</text>
      <view class="reset-btn" bindtap="resetToDefault">
        <text>é‡ç½®</text>
      </view>
    </view>
    <view class="cycle-info">
      <text class="cycle-name">{{currentCycle.name}}</text>
      <text class="cycle-description">{{currentCycle.description}}</text>
    </view>
    <view class="preview-section">
      <text class="preview-label">é¢„è§ˆï¼š</text>
      <text class="preview-text">{{previewText}}</text>
    </view>
  </view>
  
  <!-- å‘¨æœŸç±»å‹é€‰æ‹© -->
  <view class="cycle-types">
    <view class="section-title">é€‰æ‹©å‘¨æœŸç±»å‹</view>
    
    <view class="type-options">
      <view 
        class="type-option {{cycleType === 'natural' ? 'active' : ''}}"
        bindtap="onCycleTypeChange"
        data-type="natural"
      >
        <view class="option-icon">ğŸ“…</view>
        <view class="option-info">
          <text class="option-name">è‡ªç„¶æœˆ</text>
          <text class="option-desc">æ¯æœˆ1æ—¥-æœˆæœ«</text>
        </view>
        <view class="option-check">
          <text wx:if="{{cycleType === 'natural'}}" class="check-icon">âœ“</text>
        </view>
      </view>
      
      <view 
        class="type-option {{cycleType === 'salary' ? 'active' : ''}}"
        bindtap="onCycleTypeChange"
        data-type="salary"
      >
        <view class="option-icon">ğŸ’°</view>
        <view class="option-info">
          <text class="option-name">å·¥èµ„å‘¨æœŸ</text>
          <text class="option-desc">æŒ‰å‘è–ªæ—¥è®¡ç®—å‘¨æœŸ</text>
        </view>
        <view class="option-check">
          <text wx:if="{{cycleType === 'salary'}}" class="check-icon">âœ“</text>
        </view>
      </view>
      
      <view 
        class="type-option {{cycleType === 'custom' ? 'active' : ''}}"
        bindtap="onCycleTypeChange"
        data-type="custom"
      >
        <view class="option-icon">âš™ï¸</view>
        <view class="option-info">
          <text class="option-name">è‡ªå®šä¹‰</text>
          <text class="option-desc">è‡ªç”±è®¾ç½®èµ·æ­¢æ—¶é—´</text>
        </view>
        <view class="option-check">
          <text wx:if="{{cycleType === 'custom'}}" class="check-icon">âœ“</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- å¿«é€Ÿæ¨¡æ¿ -->
  <view class="templates-section">
    <view class="section-title">å¿«é€Ÿæ¨¡æ¿</view>
    
    <view class="template-list">
      <view 
        wx:for="{{templates}}" 
        wx:key="id"
        class="template-item"
        bindtap="onTemplateSelect"
        data-template="{{item}}"
      >
        <view class="template-info">
          <text class="template-name">{{item.name}}</text>
          <text class="template-desc">{{item.description}}</text>
        </view>
        <view class="template-arrow">â†’</view>
      </view>
    </view>
  </view>
  
  <!-- å‘¨æœŸè®¾ç½®åŒºåŸŸ -->
  <view wx:if="{{cycleType === 'salary'}}" class="settings-section">
    <view class="section-title">å·¥èµ„å‘¨æœŸè®¾ç½®</view>
    <view class="setting-card">
      <view class="setting-item">
        <text class="setting-label">å‘è–ªæ—¥</text>
        <view class="setting-control" bindtap="showSalaryDialog">
          <text class="setting-value">æ¯æœˆ{{salarySettings.payDay}}æ—¥</text>
          <text class="setting-arrow">></text>
        </view>
      </view>
    </view>
  </view>
  
  <view wx:if="{{cycleType === 'custom'}}" class="settings-section">
    <view class="section-title">è‡ªå®šä¹‰å‘¨æœŸè®¾ç½®</view>
    <view class="setting-card">
      <view class="setting-item">
        <text class="setting-label">å‘¨æœŸèŒƒå›´</text>
        <view class="setting-control" bindtap="showCustomDialog">
          <text class="setting-value">
            {{customSettings.startMonth}}æœˆ{{customSettings.startDay}}æ—¥ - {{customSettings.endMonth}}æœˆ{{customSettings.endDay}}æ—¥
          </text>
          <text class="setting-arrow">></text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- åº”ç”¨æŒ‰é’® -->
  <view class="apply-section">
    <button class="apply-btn" bindtap="applyCycle">åº”ç”¨è®¾ç½®</button>
  </view>
  
  <!-- å·¥èµ„å‘¨æœŸè®¾ç½®å¯¹è¯æ¡† -->
  <view wx:if="{{showSalaryDialog}}" class="dialog-overlay" bindtap="closeDialog">
    <view class="dialog" catchtap="true">
      <view class="dialog-header">
        <text class="dialog-title">å·¥èµ„å‘¨æœŸè®¾ç½®</text>
        <view class="close-btn" bindtap="closeDialog">Ã—</view>
      </view>
      
      <view class="dialog-content">
        <view class="form-group">
          <view class="label">å‘è–ªæ—¥</view>
          <picker 
            mode="selector" 
            range="{{[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]}}"
            value="{{salarySettings.payDay - 1}}"
            bindchange="onPayDayChange"
          >
            <view class="picker">æ¯æœˆ{{salarySettings.payDay}}æ—¥</view>
          </picker>
          <view wx:if="{{errors.payDay}}" class="error-text">{{errors.payDay}}</view>
        </view>
        
        <view class="form-group">
          <view class="label">å‘¨æœŸé•¿åº¦</view>
          <input 
            class="input"
            type="number"
            placeholder="å‘¨æœŸå¤©æ•°"
            value="{{salarySettings.cycleLength}}"
            bindinput="onCycleLengthInput"
          />
          <view class="input-hint">å»ºè®®è®¾ç½®ä¸º30å¤©</view>
          <view wx:if="{{errors.cycleLength}}" class="error-text">{{errors.cycleLength}}</view>
        </view>
        
        <view class="preview-info">
          <text class="preview-label">é¢„è§ˆï¼š</text>
          <text class="preview-text">{{previewText}}</text>
        </view>
      </view>
      
      <view class="dialog-footer">
        <button class="btn cancel" bindtap="closeDialog">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="applyCycle">ç¡®å®š</button>
      </view>
    </view>
  </view>
  
  <!-- è‡ªå®šä¹‰å‘¨æœŸè®¾ç½®å¯¹è¯æ¡† -->
  <view wx:if="{{showCustomDialog}}" class="dialog-overlay" bindtap="closeDialog">
    <view class="dialog" catchtap="true">
      <view class="dialog-header">
        <text class="dialog-title">è‡ªå®šä¹‰å‘¨æœŸè®¾ç½®</text>
        <view class="close-btn" bindtap="closeDialog">Ã—</view>
      </view>
      
      <view class="dialog-content">
        <view class="date-range-section">
          <view class="date-group">
            <view class="date-label">å¼€å§‹æ—¶é—´</view>
            <view class="date-pickers">
              <picker 
                mode="selector" 
                range="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}"
                range-key=""
                value="{{customSettings.startMonth - 1}}"
                bindchange="onStartMonthChange"
              >
                <view class="date-picker">{{customSettings.startMonth}}æœˆ</view>
              </picker>
              <picker 
                mode="selector" 
                range="{{[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]}}"
                value="{{customSettings.startDay - 1}}"
                bindchange="onStartDayChange"
              >
                <view class="date-picker">{{customSettings.startDay}}æ—¥</view>
              </picker>
            </view>
          </view>
          
          <view class="date-group">
            <view class="date-label">ç»“æŸæ—¶é—´</view>
            <view class="date-pickers">
              <picker 
                mode="selector" 
                range="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}"
                value="{{customSettings.endMonth - 1}}"
                bindchange="onEndMonthChange"
              >
                <view class="date-picker">{{customSettings.endMonth}}æœˆ</view>
              </picker>
              <picker 
                mode="selector" 
                range="{{[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]}}"
                value="{{customSettings.endDay - 1}}"
                bindchange="onEndDayChange"
              >
                <view class="date-picker">{{customSettings.endDay}}æ—¥</view>
              </picker>
            </view>
          </view>
        </view>
        
        <view wx:if="{{errors.general}}" class="error-text">{{errors.general}}</view>
        
        <view class="preview-info">
          <text class="preview-label">é¢„è§ˆï¼š</text>
          <text class="preview-text">{{previewText}}</text>
        </view>
      </view>
      
      <view class="dialog-footer">
        <button class="btn cancel" bindtap="closeDialog">å–æ¶ˆ</button>
        <button class="btn confirm" bindtap="applyCycle">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>