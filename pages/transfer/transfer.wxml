<!-- pages/transfer/transfer.wxml -->
<navigation-bar title="账户转账" showBack="{{true}}" />

<view class="page-container">
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
  
  <view wx:else class="content">
    <!-- 转账表单 -->
    <view class="form-container">
      <!-- 金额输入 -->
      <view class="form-section">
        <view class="section-title">转账金额</view>
        <view class="amount-input-container">
          <text class="currency-symbol">¥</text>
          <input 
            class="amount-input {{errors.amount ? 'error' : ''}}"
            type="digit"
            placeholder="0.00"
            value="{{formData.amount}}"
            bindinput="onAmountInput"
            bindblur="onAmountBlur"
            confirm-type="done"
            cursor-spacing="50"
          />
        </view>
        <view wx:if="{{errors.amount}}" class="error-text">{{errors.amount}}</view>
      </view>

      <!-- 转出账户 -->
      <view class="form-item" bindtap="onFromAccountTap">
        <view class="form-label">
          <image class="form-icon" src="/images/icons/account-out.png" />
          <text>转出账户</text>
        </view>
        <view class="form-value">
          <view wx:if="{{fromAccount}}" class="account-info">
            <text class="account-name">{{fromAccount.name}}</text>
            <text class="account-balance">余额: {{fromAccount.balanceDisplay}}</text>
          </view>
          <text wx:else class="placeholder-text">请选择转出账户</text>
          <image class="arrow-icon" src="/images/icons/arrow-right.png" />
        </view>
      </view>
      <view wx:if="{{errors.fromAccountId}}" class="error-text">{{errors.fromAccountId}}</view>

      <!-- 转账箭头 -->
      <view class="transfer-arrow">
        <image class="arrow-down-icon" src="/images/icons/arrow-down.png" />
      </view>

      <!-- 转入账户 -->
      <view class="form-item" bindtap="onToAccountTap">
        <view class="form-label">
          <image class="form-icon" src="/images/icons/account-in.png" />
          <text>转入账户</text>
        </view>
        <view class="form-value">
          <view wx:if="{{toAccount}}" class="account-info">
            <text class="account-name">{{toAccount.name}}</text>
            <text class="account-balance">余额: {{toAccount.balanceDisplay}}</text>
          </view>
          <text wx:else class="placeholder-text">请选择转入账户</text>
          <image class="arrow-icon" src="/images/icons/arrow-right.png" />
        </view>
      </view>
      <view wx:if="{{errors.toAccountId}}" class="error-text">{{errors.toAccountId}}</view>

      <!-- 日期选择 -->
      <view class="form-item">
        <view class="form-label">
          <image class="form-icon" src="/images/icons/calendar.png" />
          <text>转账日期</text>
        </view>
        <view class="form-value">
          <picker mode="date" value="{{formData.date}}" bindchange="onDateChange">
            <text class="selected-text">{{formData.date}}</text>
          </picker>
        </view>
      </view>

      <!-- 备注输入 -->
      <view class="form-item">
        <view class="form-label">
          <image class="form-icon" src="/images/icons/note.png" />
          <text>备注</text>
        </view>
        <view class="form-value">
          <input 
            class="note-input"
            placeholder="添加转账备注"
            value="{{formData.description}}"
            bindinput="onDescriptionInput"
            maxlength="100"
          />
        </view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="submit-container">
      <button 
        class="btn btn-primary btn-large {{submitting ? 'btn-disabled' : ''}}"
        bindtap="onSubmit"
        disabled="{{submitting}}"
      >
        <text wx:if="{{submitting}}">转账中...</text>
        <text wx:else>确认转账</text>
      </button>
    </view>
  </view>

  <!-- 转出账户选择器 -->
  <view wx:if="{{showFromAccountPicker}}" class="picker-overlay" bindtap="onPickerClose">
    <view class="picker-container" catchtap="">
      <view class="picker-header">
        <text class="picker-title">选择转出账户</text>
        <view class="picker-close" bindtap="onPickerClose">
          <image class="close-icon" src="/images/icons/close.png" />
        </view>
      </view>
      <view class="picker-content">
        <view 
          wx:for="{{accounts}}" 
          wx:key="_id"
          class="picker-item {{item._id === formData.fromAccountId ? 'selected' : ''}}"
          data-id="{{item._id}}"
          bindtap="onFromAccountSelect"
        >
          <view class="account-info">
            <text class="account-name">{{item.name}}</text>
            <text class="account-balance">余额: {{item.balanceDisplay}}</text>
          </view>
          <image wx:if="{{item._id === formData.fromAccountId}}" class="check-icon" src="/images/icons/check.png" />
        </view>
      </view>
    </view>
  </view>

  <!-- 转入账户选择器 -->
  <view wx:if="{{showToAccountPicker}}" class="picker-overlay" bindtap="onPickerClose">
    <view class="picker-container" catchtap="">
      <view class="picker-header">
        <text class="picker-title">选择转入账户</text>
        <view class="picker-close" bindtap="onPickerClose">
          <image class="close-icon" src="/images/icons/close.png" />
        </view>
      </view>
      <view class="picker-content">
        <view 
          wx:for="{{accounts}}" 
          wx:key="_id"
          wx:if="{{item._id !== formData.fromAccountId}}"
          class="picker-item {{item._id === formData.toAccountId ? 'selected' : ''}}"
          data-id="{{item._id}}"
          bindtap="onToAccountSelect"
        >
          <view class="account-info">
            <text class="account-name">{{item.name}}</text>
            <text class="account-balance">余额: {{item.balanceDisplay}}</text>
          </view>
          <image wx:if="{{item._id === formData.toAccountId}}" class="check-icon" src="/images/icons/check.png" />
        </view>
      </view>
    </view>
  </view>
</view>