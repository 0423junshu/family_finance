<!--pages/family-permissions/family-permissions.wxml-->
<navigation-bar title="æˆå‘˜æƒé™ç®¡ç†" showBack="{{true}}" />

<view class="page-container">
  <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
  <t-tabs value="{{activeTab}}" bind:change="onTabChange" class="permission-tabs">
    <t-tab-panel label="æˆå‘˜ç®¡ç†" value="members" />
    <t-tab-panel label="è§’è‰²æ¨¡æ¿" value="roles" />
    <t-tab-panel label="æƒé™è¯¦æƒ…" value="permissions" />
  </t-tabs>

  <!-- æˆå‘˜ç®¡ç†æ ‡ç­¾é¡µ -->
  <view wx:if="{{activeTab === 'members'}}" class="tab-content">
    <!-- æˆå‘˜åˆ—è¡¨ -->
    <view class="card members-management-card">
      <view class="card-header">
        <text class="card-title">å®¶åº­æˆå‘˜ ({{members.length}})</text>
        <t-button size="small" theme="primary" bind:tap="showBatchEdit">
          æ‰¹é‡è®¾ç½®
        </t-button>
      </view>

      <view class="members-list">
        <view 
          wx:for="{{members}}" 
          wx:key="id"
          class="member-item {{selectedMembers.includes(item.id) ? 'selected' : ''}}"
          bind:tap="selectMember"
          data-member="{{item}}"
        >
          <view class="member-info">
            <t-avatar size="medium" image="{{item.avatar}}" />
            <view class="member-details">
              <text class="member-name">{{item.nickname}}</text>
              <view class="member-meta">
                <t-tag 
                  theme="{{item.role === 'owner' ? 'primary' : item.role === 'admin' ? 'success' : 'default'}}" 
                  size="small"
                >
                  {{item.roleText}}
                </t-tag>
                <text class="join-date">{{item.joinedAtText}}</text>
              </view>
            </view>
          </view>
          
          <view class="member-actions">
            <view wx:if="{{item.isOnline}}" class="online-status">åœ¨çº¿</view>
            <view wx:else class="offline-status">ç¦»çº¿</view>
            <t-button 
              wx:if="{{canEditMember(item)}}"
              size="small" 
              variant="text" 
              bind:tap="editMember"
              data-member="{{item}}"
            >
              ç¼–è¾‘
            </t-button>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«æ·æƒé™è®¾ç½® -->
    <view class="card quick-permissions-card">
      <view class="card-header">
        <text class="card-title">å¿«æ·æƒé™è®¾ç½®</text>
      </view>
      
      <view class="quick-actions">
        <view class="quick-action" bind:tap="setQuickPermission" data-type="viewOnly">
          <view class="action-icon">ğŸ‘ï¸</view>
          <text class="action-title">ä»…æŸ¥çœ‹</text>
          <text class="action-desc">åªèƒ½æŸ¥çœ‹æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹</text>
        </view>
        
        <view class="quick-action" bind:tap="setQuickPermission" data-type="basicEdit">
          <view class="action-icon">âœï¸</view>
          <text class="action-title">åŸºç¡€ç¼–è¾‘</text>
          <text class="action-desc">å¯ä»¥è®°è´¦å’ŒæŸ¥çœ‹æŠ¥è¡¨</text>
        </view>
        
        <view class="quick-action" bind:tap="setQuickPermission" data-type="fullAccess">
          <view class="action-icon">ğŸ”§</view>
          <text class="action-title">å®Œå…¨è®¿é—®</text>
          <text class="action-desc">é™¤åˆ é™¤å¤–çš„æ‰€æœ‰æƒé™</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è§’è‰²æ¨¡æ¿æ ‡ç­¾é¡µ -->
  <view wx:if="{{activeTab === 'roles'}}" class="tab-content">
    <view class="card role-templates-card">
      <view class="card-header">
        <text class="card-title">é¢„è®¾è§’è‰²æ¨¡æ¿</text>
        <t-button size="small" theme="primary" bind:tap="createCustomRole">
          è‡ªå®šä¹‰è§’è‰²
        </t-button>
      </view>

      <view class="role-list">
        <view 
          wx:for="{{roleTemplates}}" 
          wx:key="id"
          class="role-item"
          bind:tap="selectRole"
          data-role="{{item}}"
        >
          <view class="role-header">
            <view class="role-info">
              <text class="role-name">{{item.name}}</text>
              <text class="role-desc">{{item.description}}</text>
            </view>
            <view class="role-badge">
              <text class="member-count">{{item.memberCount}}äºº</text>
            </view>
          </view>
          
          <view class="role-permissions-preview">
            <view 
              wx:for="{{item.keyPermissions}}" 
              wx:for-item="permission"
              wx:key="*this"
              class="permission-tag"
            >
              {{permission}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æƒé™è¯¦æƒ…æ ‡ç­¾é¡µ -->
  <view wx:if="{{activeTab === 'permissions'}}" class="tab-content">
    <view class="card permissions-matrix-card">
      <view class="card-header">
        <text class="card-title">æƒé™çŸ©é˜µ</text>
        <view class="matrix-controls">
          <t-button size="small" variant="text" bind:tap="expandAll">
            {{allExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}å…¨éƒ¨
          </t-button>
        </view>
      </view>

      <!-- æƒé™åˆ†ç±» -->
      <view class="permissions-matrix">
        <view 
          wx:for="{{permissionCategories}}" 
          wx:key="category"
          class="permission-category"
        >
          <view 
            class="category-header"
            bind:tap="toggleCategory"
            data-category="{{item.category}}"
          >
            <view class="category-title">
              <text class="category-icon">{{item.expanded ? 'ğŸ“‚' : 'ğŸ“'}}</text>
              <text class="category-name">{{item.name}}</text>
            </view>
            <text class="category-count">{{item.permissions.length}}é¡¹æƒé™</text>
          </view>

          <view wx:if="{{item.expanded}}" class="category-permissions">
            <view class="permission-header">
              <text class="permission-name-header">æƒé™åç§°</text>
              <text class="role-header" wx:for="{{roles}}" wx:key="*this">{{item}}</text>
            </view>

            <view 
              wx:for="{{item.permissions}}" 
              wx:for-item="permission"
              wx:key="key"
              class="permission-row"
            >
              <view class="permission-info">
                <text class="permission-name">{{permission.name}}</text>
                <text class="permission-desc">{{permission.description}}</text>
              </view>
              
              <view class="permission-switches">
                <t-switch 
                  wx:for="{{roles}}" 
                  wx:for-item="role"
                  wx:key="*this"
                  value="{{getPermissionValue(permission.key, role)}}"
                  disabled="{{!canEditRole(role)}}"
                  bind:change="onPermissionChange"
                  data-permission="{{permission.key}}"
                  data-role="{{role}}"
                  size="small"
                />
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æƒé™è¯´æ˜ -->
    <view class="card permission-help-card">
      <view class="card-header">
        <text class="card-title">æƒé™è¯´æ˜</text>
      </view>
      
      <view class="help-content">
        <view class="help-item">
          <text class="help-title">ğŸ”’ æ•°æ®æƒé™</text>
          <text class="help-desc">æ§åˆ¶æˆå‘˜å¯¹è´¢åŠ¡æ•°æ®çš„è®¿é—®å’Œä¿®æ”¹æƒé™</text>
        </view>
        
        <view class="help-item">
          <text class="help-title">ğŸ‘¥ æˆå‘˜ç®¡ç†</text>
          <text class="help-desc">ç®¡ç†å®¶åº­æˆå‘˜çš„é‚€è¯·ã€ç§»é™¤å’Œæƒé™è®¾ç½®</text>
        </view>
        
        <view class="help-item">
          <text class="help-title">âš™ï¸ å®¶åº­ç®¡ç†</text>
          <text class="help-desc">å®¶åº­è®¾ç½®ã€åˆ é™¤ç­‰é«˜çº§ç®¡ç†åŠŸèƒ½</text>
        </view>
        
        <view class="help-item">
          <text class="help-title">ğŸ“Š åŠŸèƒ½æƒé™</text>
          <text class="help-desc">å„ä¸ªåŠŸèƒ½æ¨¡å—çš„ä½¿ç”¨æƒé™æ§åˆ¶</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- æˆå‘˜ç¼–è¾‘å¼¹çª— -->
<t-popup visible="{{showMemberEdit}}" placement="bottom" bind:visible-change="onMemberEditChange">
  <view class="member-edit-popup">
    <view class="popup-header">
      <text class="popup-title">ç¼–è¾‘æˆå‘˜æƒé™</text>
      <t-button size="small" variant="text" bind:tap="closeMemberEdit">å…³é—­</t-button>
    </view>

    <view wx:if="{{editingMember}}" class="edit-content">
      <!-- æˆå‘˜ä¿¡æ¯ -->
      <view class="edit-member-info">
        <t-avatar size="large" image="{{editingMember.avatar}}" />
        <view class="edit-member-details">
          <text class="edit-member-name">{{editingMember.nickname}}</text>
          <text class="edit-member-role">å½“å‰è§’è‰²ï¼š{{editingMember.roleText}}</text>
        </view>
      </view>

      <!-- è§’è‰²é€‰æ‹© -->
      <view class="edit-section">
        <text class="section-title">é€‰æ‹©è§’è‰²</text>
        <t-radio-group value="{{editingMember.role}}" bind:change="onRoleChange">
          <t-radio 
            wx:for="{{availableRoles}}" 
            wx:key="value"
            value="{{item.value}}" 
            label="{{item.label}}"
            disabled="{{item.disabled}}"
          />
        </t-radio-group>
      </view>

      <!-- è‡ªå®šä¹‰æƒé™ -->
      <view class="edit-section">
        <text class="section-title">è‡ªå®šä¹‰æƒé™</text>
        <view class="custom-permissions">
          <t-cell-group>
            <t-cell 
              wx:for="{{editPermissions}}" 
              wx:key="key"
              title="{{item.name}}"
              description="{{item.description}}"
            >
              <t-switch 
                slot="note"
                value="{{item.enabled}}"
                bind:change="onCustomPermissionChange"
                data-key="{{item.key}}"
                size="small"
              />
            </t-cell>
          </t-cell-group>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="edit-actions">
        <t-button theme="primary" bind:tap="saveMemberPermissions">
          ä¿å­˜æ›´æ”¹
        </t-button>
        <t-button 
          wx:if="{{canRemoveMember(editingMember)}}"
          theme="danger" 
          variant="outline" 
          bind:tap="removeMember"
        >
          ç§»é™¤æˆå‘˜
        </t-button>
      </view>
    </view>
  </view>
</t-popup>

<!-- æ‰¹é‡ç¼–è¾‘å¼¹çª— -->
<t-popup visible="{{showBatchEdit}}" placement="center" bind:visible-change="onBatchEditChange">
  <view class="batch-edit-popup">
    <view class="popup-header">
      <text class="popup-title">æ‰¹é‡æƒé™è®¾ç½®</text>
    </view>

    <view class="batch-content">
      <text class="batch-desc">å·²é€‰æ‹© {{selectedMembers.length}} ä½æˆå‘˜</text>
      
      <view class="batch-actions">
        <t-button 
          wx:for="{{batchActions}}" 
          wx:key="type"
          theme="{{item.theme}}" 
          size="large"
          bind:tap="executeBatchAction"
          data-action="{{item.type}}"
          class="batch-action-btn"
        >
          {{item.label}}
        </t-button>
      </view>
    </view>

    <view class="popup-actions">
      <t-button theme="light" bind:tap="closeBatchEdit">å–æ¶ˆ</t-button>
    </view>
  </view>
</t-popup>

<!-- Toast æç¤º -->
<t-toast id="t-toast" />

<!-- Dialog å¯¹è¯æ¡† -->
<t-dialog id="t-dialog" />