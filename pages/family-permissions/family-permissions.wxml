<!--pages/family-permissions/family-permissions.wxml-->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="{{currentMember ? currentMember.nickname + 'çš„æƒé™' : 'æƒé™ç®¡ç†'}}" showBack="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- å•ä¸ªæˆå‘˜æƒé™ç®¡ç†æ¨¡å¼ -->
  <view wx:if="{{mode === 'simple' && currentMember}}" class="simple-permission-mode">
    <!-- æˆå‘˜ä¿¡æ¯ -->
    <view class="card member-info-card">
      <view class="member-header">
        <view class="member-avatar-large">
          <image wx:if="{{currentMember.avatar}}" src="{{currentMember.avatar}}" mode="aspectFill" />
          <text wx:else class="avatar-text-large">{{currentMember.nickname.charAt(0)}}</text>
        </view>
        <view class="member-details">
          <text class="member-name-large">{{currentMember.nickname}}</text>
          <view class="member-role-badge {{currentMember.role}}">{{currentMember.roleText}}</view>
          <text class="member-join-time">åŠ å…¥æ—¶é—´ï¼š{{currentMember.joinedAtText}}</text>
        </view>
      </view>
    </view>

    <!-- åŸºç¡€æƒé™è®¾ç½® -->
    <view class="card basic-permissions-card">
      <view class="card-header">
        <text class="card-title">åŸºç¡€æƒé™</text>
        <text class="permission-note">æ‰€æœ‰æˆå‘˜é»˜è®¤æ‹¥æœ‰æŸ¥çœ‹æƒé™</text>
      </view>
      
      <view class="basic-permissions-list">
        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">âœï¸</view>
            <view class="permission-details">
              <text class="permission-name">å¯ç¼–è¾‘</text>
              <text class="permission-desc">å¯ä»¥æ·»åŠ ã€ä¿®æ”¹è´¢åŠ¡è®°å½•</text>
            </view>
          </view>
          <switch 
            checked="{{currentMember.permissions.canEdit}}" 
            bind:change="onPermissionChange" 
            data-permission="canEdit"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">ğŸ—‘ï¸</view>
            <view class="permission-details">
              <text class="permission-name">å¯åˆ é™¤</text>
              <text class="permission-desc">å¯ä»¥åˆ é™¤è´¢åŠ¡è®°å½•</text>
            </view>
          </view>
          <switch 
            checked="{{currentMember.permissions.canDelete}}" 
            bind:change="onPermissionChange" 
            data-permission="canDelete"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">ğŸ“¤</view>
            <view class="permission-details">
              <text class="permission-name">å¯å¯¼å‡º</text>
              <text class="permission-desc">å¯ä»¥å¯¼å‡ºå®¶åº­è´¢åŠ¡æ•°æ®</text>
            </view>
          </view>
          <switch 
            checked="{{currentMember.permissions.canExport}}" 
            bind:change="onPermissionChange" 
            data-permission="canExport"
            color="#667eea"
          />
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="save-btn" bind:tap="savePermissions" disabled="{{saving}}">
        {{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜æƒé™'}}
      </button>
      <button wx:if="{{canRemoveMember}}" class="remove-btn" bind:tap="removeMember">
        ç§»é™¤æˆå‘˜
      </button>
    </view>
  </view>

  <!-- æ‰¹é‡æƒé™ç®¡ç†æ¨¡å¼ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ä½†ç®€åŒ–ï¼‰ -->
  <view wx:else class="batch-permission-mode">
    <!-- æˆå‘˜é€‰æ‹© -->
    <view class="card member-selector-card">
      <view class="card-header">
        <text class="card-title">é€‰æ‹©æˆå‘˜</text>
        <text class="select-all-btn" bind:tap="toggleSelectAll">
          {{isAllSelected ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
        </text>
      </view>
      
      <view class="member-list">
        <view 
          wx:for="{{members}}" 
          wx:key="id"
          class="member-selector-item {{selectedMembers.includes(item.id) ? 'selected' : ''}}"
          bind:tap="toggleMemberSelection"
          data-member-id="{{item.id}}"
        >
          <view class="member-checkbox">
            <text class="checkbox-icon">{{selectedMembers.includes(item.id) ? 'âœ“' : 'â—‹'}}</text>
          </view>
          <view class="member-avatar">
            <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" />
            <text wx:else class="avatar-text">{{item.nickname.charAt(0)}}</text>
          </view>
          <view class="member-info">
            <text class="member-name">{{item.nickname}}</text>
            <view class="member-role-badge {{item.role}}">{{item.roleText}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ‰¹é‡æƒé™è®¾ç½® -->
    <view wx:if="{{selectedMembers.length > 0}}" class="card batch-permissions-card">
      <view class="card-header">
        <text class="card-title">æ‰¹é‡æƒé™è®¾ç½®</text>
        <text class="selected-hint">å°†åº”ç”¨åˆ°æ‰€é€‰ {{selectedMembers.length}} ä½æˆå‘˜</text>
      </view>
      
      <view class="batch-permissions-list">
        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">âœï¸</view>
            <view class="permission-details">
              <text class="permission-name">å¯ç¼–è¾‘</text>
              <text class="permission-desc">å¯ä»¥æ·»åŠ ã€ä¿®æ”¹è´¢åŠ¡è®°å½•</text>
            </view>
          </view>
          <switch 
            checked="{{batchPermissions.canEdit}}" 
            bind:change="onBatchPermissionChange" 
            data-permission="canEdit"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">ğŸ—‘ï¸</view>
            <view class="permission-details">
              <text class="permission-name">å¯åˆ é™¤</text>
              <text class="permission-desc">å¯ä»¥åˆ é™¤è´¢åŠ¡è®°å½•</text>
            </view>
          </view>
          <switch 
            checked="{{batchPermissions.canDelete}}" 
            bind:change="onBatchPermissionChange" 
            data-permission="canDelete"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">ğŸ“¤</view>
            <view class="permission-details">
              <text class="permission-name">å¯å¯¼å‡º</text>
              <text class="permission-desc">å¯ä»¥å¯¼å‡ºå®¶åº­è´¢åŠ¡æ•°æ®</text>
            </view>
          </view>
          <switch 
            checked="{{batchPermissions.canExport}}" 
            bind:change="onBatchPermissionChange" 
            data-permission="canExport"
            color="#667eea"
          />
        </view>
      </view>

      <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
      <view class="batch-action-buttons">
        <button class="apply-btn" bind:tap="applyBatchPermissions" disabled="{{saving}}">
          {{saving ? 'åº”ç”¨ä¸­...' : 'åº”ç”¨åˆ°æ‰€é€‰æˆå‘˜'}}
        </button>
      </view>
    </view>
  </view>
</view>

<!-- Toast æç¤º -->
<view class="toast-container" wx:if="{{showToast}}">
  <view class="toast {{toastType}}">
    <text class="toast-text">{{toastMessage}}</text>
  </view>
</view>