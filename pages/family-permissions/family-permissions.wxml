<!--pages/family-permissions/family-permissions.wxml-->
<view class="safe-area-wrapper safe-area-white">
  <navigation-bar title="{{currentMember ? currentMember.nickname + '的权限' : '权限管理'}}" showBack="{{true}}" class="transparent-navbar" />
</view>

<view class="page-container">
  <!-- 单个成员权限管理模式 -->
  <view wx:if="{{mode === 'simple' && currentMember}}" class="simple-permission-mode">
    <!-- 成员信息 -->
    <view class="card member-info-card">
      <view class="member-header">
        <view class="member-avatar-large">
          <image wx:if="{{currentMember.avatar}}" src="{{currentMember.avatar}}" mode="aspectFill" />
          <text wx:else class="avatar-text-large">{{currentMember.nickname.charAt(0)}}</text>
        </view>
        <view class="member-details">
          <text class="member-name-large">{{currentMember.nickname}}</text>
          <view class="member-role-badge {{currentMember.role}}">{{currentMember.roleText}}</view>
          <text class="member-join-time">加入时间：{{currentMember.joinedAtText}}</text>
        </view>
      </view>
    </view>

    <!-- 基础权限设置 -->
    <view class="card basic-permissions-card">
      <view class="card-header">
        <text class="card-title">基础权限</text>
        <text class="permission-note">所有成员默认拥有查看权限</text>
      </view>
      
      <view class="basic-permissions-list">
        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">✏️</view>
            <view class="permission-details">
              <text class="permission-name">可编辑</text>
              <text class="permission-desc">可以添加、修改财务记录</text>
            </view>
          </view>
          <switch 
            checked="{{currentMember.permissions.canEdit}}" 
            bind:change="onPermissionChange" 
            data-permission="canEdit"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">🗑️</view>
            <view class="permission-details">
              <text class="permission-name">可删除</text>
              <text class="permission-desc">可以删除财务记录</text>
            </view>
          </view>
          <switch 
            checked="{{currentMember.permissions.canDelete}}" 
            bind:change="onPermissionChange" 
            data-permission="canDelete"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">📤</view>
            <view class="permission-details">
              <text class="permission-name">可导出</text>
              <text class="permission-desc">可以导出家庭财务数据</text>
            </view>
          </view>
          <switch 
            checked="{{currentMember.permissions.canExport}}" 
            bind:change="onPermissionChange" 
            data-permission="canExport"
            color="#667eea"
          />
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <button class="save-btn" bind:tap="savePermissions" disabled="{{saving}}">
        {{saving ? '保存中...' : '保存权限'}}
      </button>
      <button wx:if="{{canRemoveMember}}" class="remove-btn" bind:tap="removeMember">
        移除成员
      </button>
    </view>
  </view>

  <!-- 批量权限管理模式（保留原有功能但简化） -->
  <view wx:else class="batch-permission-mode">
    <!-- 成员选择 -->
    <view class="card member-selector-card">
      <view class="card-header">
        <text class="card-title">选择成员</text>
        <text class="select-all-btn" bind:tap="toggleSelectAll">
          {{isAllSelected ? '取消全选' : '全选'}}
        </text>
      </view>
      
      <view class="member-list">
        <view 
          wx:for="{{members}}" 
          wx:key="id"
          class="member-selector-item {{selectedMembers.includes(item.id) ? 'selected' : ''}}"
          bind:tap="toggleMemberSelection"
          data-member-id="{{item.id}}"
        >
          <view class="member-checkbox">
            <text class="checkbox-icon">{{selectedMembers.includes(item.id) ? '✓' : '○'}}</text>
          </view>
          <view class="member-avatar">
            <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" />
            <text wx:else class="avatar-text">{{item.nickname.charAt(0)}}</text>
          </view>
          <view class="member-info">
            <text class="member-name">{{item.nickname}}</text>
            <view class="member-role-badge {{item.role}}">{{item.roleText}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 批量权限设置 -->
    <view wx:if="{{selectedMembers.length > 0}}" class="card batch-permissions-card">
      <view class="card-header">
        <text class="card-title">批量权限设置</text>
        <text class="selected-hint">将应用到所选 {{selectedMembers.length}} 位成员</text>
      </view>
      
      <view class="batch-permissions-list">
        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">✏️</view>
            <view class="permission-details">
              <text class="permission-name">可编辑</text>
              <text class="permission-desc">可以添加、修改财务记录</text>
            </view>
          </view>
          <switch 
            checked="{{batchPermissions.canEdit}}" 
            bind:change="onBatchPermissionChange" 
            data-permission="canEdit"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">🗑️</view>
            <view class="permission-details">
              <text class="permission-name">可删除</text>
              <text class="permission-desc">可以删除财务记录</text>
            </view>
          </view>
          <switch 
            checked="{{batchPermissions.canDelete}}" 
            bind:change="onBatchPermissionChange" 
            data-permission="canDelete"
            color="#667eea"
          />
        </view>

        <view class="permission-item">
          <view class="permission-info">
            <view class="permission-icon">📤</view>
            <view class="permission-details">
              <text class="permission-name">可导出</text>
              <text class="permission-desc">可以导出家庭财务数据</text>
            </view>
          </view>
          <switch 
            checked="{{batchPermissions.canExport}}" 
            bind:change="onBatchPermissionChange" 
            data-permission="canExport"
            color="#667eea"
          />
        </view>
      </view>

      <!-- 批量操作按钮 -->
      <view class="batch-action-buttons">
        <button class="apply-btn" bind:tap="applyBatchPermissions" disabled="{{saving}}">
          {{saving ? '应用中...' : '应用到所选成员'}}
        </button>
      </view>
    </view>
  </view>
</view>

<!-- Toast 提示 -->
<view class="toast-container" wx:if="{{showToast}}">
  <view class="toast {{toastType}}">
    <text class="toast-text">{{toastMessage}}</text>
  </view>
</view>