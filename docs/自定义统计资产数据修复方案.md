# 自定义统计资产数据修复方案

## 问题根因

通过深入分析发现，自定义统计资产数据不准确的根本原因是：

**后端逻辑正确，前端处理错误**

- ✅ **后端**: `services/report.js` 中自定义统计正确调用了 `generateMonthlyAssetData(ymKey)` 获取历史资产快照
- ❌ **前端**: `pages/reports/reports-simple.js` 中错误地用当前资产总额覆盖了后端返回的历史数据

## 具体问题分析

### 后端数据流（正确）
```javascript
// services/report.js 第1335-1370行
for (const ymKey of Object.keys(trendMap)) {
  const assetData = await generateMonthlyAssetData(ymKey);  // 获取历史快照
  trendMap[ymKey].totalAssets = assetData.totalAssets || 0; // 使用历史数据
}
```

### 前端数据流（错误）
```javascript
// pages/reports/reports-simple.js 第790-820行 - 修复前
const totalAssets = accounts.reduce(...) + investments.reduce(...); // 当前资产
const filledData = months.map(m => {
  return existing ? {
    ...existing,
    totalAssets: existing.totalAssets || totalAssets  // ❌ 覆盖历史数据
  } : {
    totalAssets: totalAssets  // ❌ 使用当前资产
  };
});
```

## 修复方案

### 核心修复
**保留后端返回的历史资产数据，不进行前端覆盖**

```javascript
// 修复后的逻辑
return existing ? {
  ...existing,
  // 关键修复：完全保留后端的 totalAssets，不进行任何覆盖
} : {
  totalAssets: 0  // 只有完全没有数据的月份才设为0
};
```

### 调试增强
添加详细的数据处理日志：
```javascript
console.log(`处理月份 ${m.year}-${m.month}:`, {
  hasExisting: !!existing,
  backendAssets: existing?.totalAssets,
  source: existing ? 'backend' : 'frontend_fill'
});
```

## 修复效果预期

### 修复前
- 自定义统计所有月份显示相同的资产数值（当前资产）
- 无法反映资产的历史变化趋势
- 与按年统计的资产数据存在差异

### 修复后
- 自定义统计显示真实的历史资产变化趋势
- 每个月份使用对应的历史资产快照数据
- 与按年统计的资产数据保持一致性

## 验证方法

1. **数据一致性验证**
   - 选择相同的时间范围（如2024年1-12月）
   - 对比按年统计和自定义统计的资产数值
   - 确认数值完全一致

2. **趋势合理性验证**
   - 检查资产数值是否随时间合理变化
   - 验证是否反映了实际的收支影响

3. **调试日志验证**
   - 查看控制台日志确认使用的是后端数据
   - 确认没有前端覆盖行为

## 技术要点

1. **数据源优先级**: 后端历史快照 > 前端当前资产
2. **数据完整性**: 保持后端返回数据的完整性，避免前端篡改
3. **调试可见性**: 增加日志便于问题定位和验证

这个修复方案确保了自定义统计能够准确反映资产的历史变化趋势，与按年统计保持数据一致性。