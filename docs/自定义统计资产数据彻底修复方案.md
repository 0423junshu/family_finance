# 自定义统计资产数据彻底修复方案

## 问题根本原因确认

通过深入分析后端代码，发现自定义统计的资产数据获取逻辑是**完全正确**的：

### 后端逻辑验证
在 `services/report.js` 第1365-1368行：
```javascript
// 为每个月添加资产数据
for (const ymKey of Object.keys(trendMap)) {
  const assetData = await generateMonthlyAssetData(ymKey);
  trendMap[ymKey].totalAssets = assetData.totalAssets || 0;
  trendMap[ymKey].balance = trendMap[ymKey].income - trendMap[ymKey].expense;
}
```

**结论**：后端确实为自定义统计的每个月份调用了 `generateMonthlyAssetData()` 获取资产数据，与按年统计使用完全相同的逻辑。

## 真正的问题所在

问题出现在**前端数据处理**中：前端的本地计算逻辑覆盖了后端提供的正确资产数据。

### 问题代码分析
在 `pages/reports/reports-simple.js` 的 `processReportData` 函数中：
1. 前端尝试进行本地交易计算
2. 当发现本地有交易数据时，创建新的数据对象
3. **错误地使用当前资产总额**作为历史月份的资产数据
4. 完全忽略了后端提供的正确历史资产数据

## 彻底修复方案

### 修复原则
1. **完全依赖后端数据**：不在前端进行任何资产数据计算
2. **移除数据覆盖逻辑**：不创建新的数据对象覆盖后端数据
3. **保持数据完整性**：让后端的正确资产数据能够完整传递到前端

### 具体修复内容

#### 1. 移除前端本地计算
```javascript
// 修复前：前端进行本地计算并覆盖后端数据
if (monthIncome > 0 || monthExpense > 0) {
  return {
    // ... 创建新对象，覆盖后端数据
    totalAssets: fallbackAssets  // 错误：使用当前资产
  };
}

// 修复后：完全依赖后端数据
if (!existing && customTransactions.length > 0) {
  // 只记录日志，不进行数据覆盖
  console.log(`月份 ${m.year}-${m.month} 后端无数据但本地有交易，依赖后端处理`);
}
```

#### 2. 保持后端数据完整性
```javascript
// 优先使用后端返回的数据（包括历史资产数据）
return existing ? {
  ...existing,
  label: m.label,
  dateDisplay: existing.dateDisplay || `${existing.year || m.year}年${String(existing.month || m.month).padStart(2, '0')}月`
  // 关键：不再覆盖 totalAssets，完全保留后端数据
} : {
  // 对于完全没有数据的月份，设为0
  year: m.year,
  month: m.month,
  date: m.date,
  label: m.label,
  dateDisplay: `${m.year}年${String(m.month).padStart(2, '0')}月`,
  income: 0,
  expense: 0,
  totalAssets: 0
};
```

## 修复效果预期

### 自定义统计
- 每个月份将显示**真实的历史资产数据**
- 资产趋势图将显示**正确的变化曲线**
- 不再出现所有月份显示相同资产数据的问题

### 按年统计
- 保持完全不变，继续正常工作
- 使用相同的后端逻辑，确保数据一致性

### 数据流完整性
- 后端 → 前端：数据完整传递，无覆盖
- 前端处理：只进行格式化，不进行业务逻辑计算
- 显示效果：真实反映历史资产变化

## 技术要点

### 修复位置
- 文件：`pages/reports/reports-simple.js`
- 函数：`processReportData` 中的自定义统计数据填充逻辑
- 核心：移除前端本地计算，保持后端数据完整性

### 修复类型
- **数据流修复**：确保后端数据完整传递到前端
- **逻辑简化**：移除不必要的前端计算逻辑
- **一致性保证**：自定义统计与按年统计使用相同的数据源

### 调试验证
- 控制台将显示后端数据传递过程
- 可追踪每个月份的资产数据来源
- 便于验证修复效果

## 最终验证要点

1. **资产数据准确性**：每个月份显示对应的历史资产数据
2. **趋势图连续性**：资产变化曲线合理且连续
3. **数据一致性**：自定义统计与按年统计的资产数据逻辑一致
4. **功能完整性**：收入、支出、结余数据保持准确

这次修复彻底解决了数据覆盖问题，确保自定义统计能够正确显示历史资产变化趋势。