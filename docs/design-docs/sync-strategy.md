# 一键同步策略与数据流设计

## 目标
- 明确同步方向：本地缓存/离线变更 → 云端主真相源 → 回写本地
- 支持增量同步、冲突处理、弱网重试与可观测性

## 同步范围
- 账户、分类、预算、未上传交易、用户偏好
- 统一携带版本字段：_version, _updatedAt

## 流程
1) 能力检测 + 鉴权
2) 增量上行：仅提交本地 version 落后于云端的新增/变更
3) 增量下行：拉取云端较新变更
4) 校验：关键集合快照一致性校验（哈希/计数/时间戳）
5) 回写：合并成功后，持久化到本地缓存（storage）

## 冲突策略
- Version Compare：本地_version vs 云端_version
- 冲突时选项：
  - 以云端为准（本地覆盖）
  - 以本地为准（上行覆盖）
  - 进入“冲突合并界面”（记录冲突项，辅助用户选择）
- 记录冲突日志：logs/sync-conflicts-YYYYMMDD.json

## 重试与超时
- 请求超时：8~12s
- 重试：指数退避(1s, 2s, 4s)，最多3次
- 失败回退：保留本地队列，不清空；标记下次冷启动继续

## UI/UX
- 首页“一键同步”按钮触发
- 显示步骤化进度（上传/下载/校验）
- 成功/失败统一 toast；失败提供“查看详情/重试”

## 可观测性
- 关键节点埋点：sync_start/sync_success/sync_fail
- 日志：logs/sync-*.json（不含隐私）

## 封装与分层
- services/sync.ts：对外暴露 startSync、resolveConflicts
- repositories/*：数据访问适配层
- utils/storage.ts：带版本读写与校验

## 验收标准
- 弱网/断网恢复后可继续
- 发生冲突时有明确提示与操作选项
- 同步完成后首页与交易页数据一致