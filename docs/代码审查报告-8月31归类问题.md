# 代码审查报告：8月31日归属月份问题

日期：2025-09-08

结论（TL;DR）：
- 核心根因是多处使用 `toISOString().split('T')[0]` 生成“YYYY-MM-DD”，该方法基于 UTC，会把东八区本地日期向前截断至前一天（如本地 9月1日 00:00 -> UTC 8月31日 16:00 -> "2025-08-31"）。
- 影响范围：月份范围传参、报表筛选、部分页面默认日期及服务层返回的 `startDateString/endDateString`。
- 修复策略：统一使用本地格式化 `utils/formatter.formatDate` 生成“YYYY-MM-DD”；筛选比较改用时间戳或将交易记录日期规范化为本地日期再比较。

已修复点：
1) pages/transaction-list/transaction-list-simple.js
   - 引入 `formatter.formatDate` 生成范围日期，避免 `toISOString()`
   - 将“按日期范围筛选”由字符串比较改为时间戳比较，规避时区与字符串比较误差
2) services/transaction-simple.js
   - `getCycleDateRange` 返回的 `startDateString/endDateString` 改为 `formatter.formatDate(startDate/endDate)`
3) pages/index/index.js
   - `onViewAllTap` 的降级回退范围由 `toISOString()` 改为 `formatter.formatDate()`

仍需关注/潜在风险：
- services/report.js 中仍存在 `toISOString().split('T')[0]`（月、年统计及交易日期归属判断）。建议同样替换为 `formatter.formatDate()` 或使用本地 `new Date(y, m, d)` 与时间戳比较（强烈建议）。
- 历史数据中交易 `t.date` 字段可能为 ISO 字符串（带 Z）。我们在筛选时已采用时间戳比较，可避免大部分偏移。但如需“以本地日历日”为口径严格统计，建议在读取时将 `t.date` 规范化为本地日字符串（`formatter.formatDate(t.date)`）用于显示与月份归类。
- mock 数据生成处（services/transaction-simple.js/generateMockTransactions）仍用 `date.toISOString()` 写入。为避免后续偏移，建议写入 `date` 字段为本地日字符串（`formatter.formatDate(date)`），`createTime/updateTime` 可保留 ISO。

建议后续动作（优先级从高到低）：
A. 替换 services/report.js 里的所有 `toISOString().split('T')[0]` 为 `formatter.formatDate()`，并将比较逻辑改为：
   - 范围边界：用 `new Date(year, month, day)` 生成本地时间，再 `formatter.formatDate` 得到边界字符串
   - 交易日期：使用 `formatter.formatDate(t.date)` 得到本地“YYYY-MM-DD”，再做字符串区间比较，或直接时间戳区间比较（以本地 00:00/23:59:59 为边界）
B. 统一 mock 数据：将 `transaction.date` 改为本地日字符串，确保新数据不会再受 UTC 影响
C. 回归测试用例：
   - 2025-09 月：范围应为 2025-09-01 ~ 2025-09-30，8.31 不应算入
   - 2024-02 闰年：范围应为 2024-02-01 ~ 2024-02-29
   - “本周”“本月”“自定义”均保持选择器不消失、可操作且生效

本报告对应提交：
- pages/transaction-list/transaction-list-simple.js 更新
- services/transaction-simple.js 更新
- pages/index/index.js 更新（回退逻辑）
以上已在本次提交中完成。