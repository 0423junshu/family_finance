# 家庭协作功能修复记录（晚间批次）

时间: 2025-09-07 17:00
版本: v1.0.0-evening
维护: CodeBuddy AI

## 问题 #008: app.json 无效/冲突配置
- 现象:
  - DevTools 报警告 window.enableSkia、rendererOptions.skyline.sdkVersion 无效
  - 全局 usingComponents 导致按需注入失效（检测到 7 个 TDesign 组件）
  - preloadRule 指向不存在的 "tdesign-miniprogram" 包
  - sitemapLocation、permission 重复
- 根因:
  - 不兼容/废弃字段与错误的全局注册/预加载配置
- 解决:
  - 移除 window.enableSkia
  - 移除 skyline.sdkVersion，仅保留合法项（defaultDisplayBlock、disableABTest）
  - 删除 app.json 的全局 usingComponents，改用各页面按需注册（项目已分散声明）
  - 删除 preloadRule 中 tdesign-miniprogram
  - 去除重复字段
- 影响面: 恢复按需注入，减少包体与启动警告，避免组件扫描异常

## 问题 #009: SharedArrayBuffer 跨域隔离警告
- 现象: 控制台出现 SharedArrayBuffer/OffscreenCanvas 警告
- 根因: 依赖的类型定义/三方库在 Node/浏览器环境说明中存在相关 API；小程序环境未实际使用 SAB
- 处理: 代码中未调用相关能力，无运行路径；记录为“无需动作”的已知警告，持续监控

## 问题 #010: 全局自定义组件影响按需注入
- 现象: 检测到 7 个全局 TDesign 组件注册，按需注入失效
- 根因: app.json usingComponents 全局注册
- 解决: 已从 app.json 移除全局注册；各页面保留局部 usingComponents

## 问题 #011: TDesign 字体加载失败 (https://tdesign.gtimg.com/icon/0.3.2/fonts/t.woff)
- 现象: 网络不佳时 icon 字体加载失败，UI 退化
- 解决:
  - 在 app.wxss 新增 @font-face 覆盖：
    - font-family: 't' 指向本地 /fonts/t.woff（本地优先，display: swap）
  - 保留先前的 't-icon' 方案作为额外兜底
- 验证:
  - 断网/弱网场景下图标仍能显示（或快速回退），不阻塞渲染
  - fonts 目录已存在 t.woff

## 问题 #012: 预加载分包失败（包 "tdesign-miniprogram" 不存在）
- 现象: DevTools 报告预加载包不存在
- 根因: preloadRule 指向错误
- 解决: 删除 app.json preloadRule 项

## 问题 #013: 家庭协作页点击后闪烁并跳首页（根因：canSync 被设为 undefined）
- 现象:
  - 点击家庭协作功能入口，页面闪烁并未按预期停留在目标页
  - 相关提示与按钮处于异常禁用/状态不一致
- 根因:
  - 组件 components/sync-status/sync-status.js 在 updateSyncStatus 中直接使用 status.canSync，部分调用未传入该字段，导致 setData({ canSync: undefined })
  - 由此引发 disabled 计算、状态机与后续逻辑的连锁异常（存在跳转失败后的默认回落体验，被误感知为“跳到首页”）
- 解决:
  - 为 canSync 与 lastSyncTime 增加安全默认值：
    - canSync 默认为非 offline 时可同步
    - lastSyncTime 缺省取 Storage 缓存
  - 引入 services/sync 并在手动同步调用 forcSync()，完成后回写 lastSyncTime 并刷新状态
- 涉及修改:
  - components/sync-status/sync-status.js
    - import: 引入 services/sync
    - updateSyncStatus(): 默认值防御
    - onManualSync(): 调用 forcSync，更新 lastSyncTime
- 验证:
  - 初次进入/离线/错误状态下不再出现 canSync 为 undefined
  - 手动同步按钮状态正确，点击后状态与时间同步更新
  - 家庭协作页交互不再出现闪屏与异常回退

## 文件变更摘要
- app.json: 清理无效/错误/重复配置，移除全局 usingComponents 与 preloadRule
- app.wxss: 新增 @font-face('t' -> /fonts/t.woff) 本地化；保留 't-icon' 兜底
- components/sync-status/sync-status.js: 默认值防御与同步逻辑完善

## 手动验证清单
- 启动后无 Skyline/Skia/预加载相关告警
- 已加入/未加入家庭两种状态切换正常，无异常跳转
- 同步面板 “手动同步” 可正常点击，完成后显示成功与时间刷新
- 断网时图标显示回退流畅，无布局崩溃