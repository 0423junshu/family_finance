# 数据库问题完整解决方案

## 问题概述

家庭财务管理小程序遇到多个数据库查询问题，所有操作均返回错误代码 -502005，提示"数据库集合不存在"。

## 问题详情

### 主要错误
- **错误代码**: -502005
- **错误信息**: database collection not exists
- **影响功能**:
  1. 待解决冲突查询失败
  2. 日志统计获取失败  
  3. 统计数据加载失败
  4. 操作日志查询失败
  5. 初始数据加载失败
  6. 数据刷新失败

### 附加问题
- 字体加载问题：t.woff 缓存缺失错误
- SharedArrayBuffer 兼容性警告（Chrome M92+ 需要跨域隔离）
- 数据库查询缺乏高效索引支持

## 解决方案

### 1. 自动化数据库初始化

#### 新增工具页面
- **完整数据库初始化**: `/pages/complete-db-init/complete-db-init`
- **手动创建指南**: `/pages/manual-db-guide/manual-db-guide`

#### 新增云函数
- **completeDbInit**: 自动创建所有必需的数据库集合

### 2. 必需数据库集合

#### 核心业务集合（必须创建）
```
families              - 家庭信息表
family_members        - 家庭成员表  
transactions          - 交易记录表
categories            - 分类管理表
accounts              - 账户管理表
```

#### 协作功能集合
```
family_invites        - 家庭邀请表
data_conflicts        - 数据冲突表
data_locks            - 数据锁定表
data_versions         - 数据版本表
```

#### 日志和统计集合
```
operation_logs        - 操作日志表
user_statistics       - 用户统计表
system_logs           - 系统日志表
```

#### 扩展功能集合
```
budgets               - 预算管理表
templates             - 交易模板表
sync_records          - 同步记录表
conflict_resolutions  - 冲突解决表
```

### 3. 数据库索引建议

为提升查询性能，建议创建以下索引：

```javascript
// transactions 集合
{ userId: 1, date: -1 }        // 用户交易按日期查询
{ familyId: 1, date: -1 }      // 家庭交易按日期查询
{ category: 1, date: -1 }      // 分类交易按日期查询

// family_members 集合  
{ familyId: 1, userId: 1 }     // 家庭成员关系查询

// operation_logs 集合
{ userId: 1, timestamp: -1 }   // 用户操作日志查询

// data_conflicts 集合
{ status: 1, createdAt: -1 }   // 冲突状态查询
```

### 4. 字体加载问题修复

#### 问题原因
TDesign 组件尝试加载远程字体文件 `https://tdesign.gtimg.com/icon/0.3.2/fonts/t.woff`，导致缓存缺失错误。

#### 解决方案
在 `app.wxss` 中强制使用本地字体：

```css
/* TDesign 字体完全本地化 */
@font-face {
  font-family: 't' !important;
  src: url('/fonts/t.woff') format('woff') !important;
  font-display: swap !important;
  font-weight: normal !important;
  font-style: normal !important;
}

/* 强制覆盖所有 TDesign 字体引用 */
.t-icon, 
[class*="t-icon"], 
.tdesign-icon {
  font-family: 't' !important;
}
```

## 操作步骤

### 方案一：自动化创建（推荐）

1. **部署云函数**
   ```bash
   # 在微信开发者工具中
   # 右键 cloudfunctions/completeDbInit
   # 选择"上传并部署：云端安装依赖"
   ```

2. **使用初始化工具**
   - 在小程序中访问：`/pages/complete-db-init/complete-db-init`
   - 点击"创建所有缺失集合"按钮
   - 等待创建完成

3. **验证结果**
   - 查看创建结果日志
   - 测试各项功能是否正常

### 方案二：手动创建

1. **查看创建指南**
   - 访问：`/pages/manual-db-guide/manual-db-guide`
   - 按照指南逐个创建集合

2. **在云开发控制台操作**
   - 打开微信开发者工具
   - 点击"云开发" → "数据库"
   - 点击"+"创建集合
   - 输入集合名称并确认

3. **创建索引**
   - 选择对应集合
   - 点击"索引管理"
   - 创建建议的复合索引

## 验证方法

### 1. 功能测试清单
- [ ] 用户登录功能
- [ ] 家庭创建/加入功能  
- [ ] 交易记录添加/查询
- [ ] 统计报表显示
- [ ] 操作日志记录
- [ ] 冲突解决功能

### 2. 数据库验证
```javascript
// 在云函数中验证集合是否存在
const db = cloud.database();
const collections = ['families', 'family_members', 'transactions', 'categories', 'accounts'];

for (const name of collections) {
  try {
    await db.collection(name).limit(1).get();
    console.log(`✅ 集合 ${name} 存在`);
  } catch (error) {
    console.log(`❌ 集合 ${name} 不存在: ${error.message}`);
  }
}
```

### 3. 字体加载验证
- 清除浏览器缓存
- 重新加载小程序
- 检查控制台是否还有字体加载错误
- 验证图标是否正常显示

## 环境信息

- **平台**: Windows
- **微信小程序基础库**: 1.06.2504030
- **SDK版本**: 3.9.3
- **TDesign版本**: miniprogram

## 注意事项

1. **云函数部署**: 必须选择"云端安装依赖"选项
2. **集合创建**: 核心集合必须全部创建，可选集合可按需创建
3. **索引创建**: 建议在数据量较大时创建，提升查询性能
4. **字体文件**: 确保 `/fonts/t.woff` 文件存在于项目中
5. **缓存清理**: 修复后建议清除小程序缓存重新测试

## 故障排除

### 如果自动创建失败
1. 检查云函数是否正确部署
2. 检查云开发环境是否正确初始化
3. 查看云函数日志获取详细错误信息
4. 使用手动创建方案作为备选

### 如果字体问题仍然存在
1. 检查 `/fonts/t.woff` 文件是否存在
2. 清除小程序缓存和浏览器缓存
3. 检查 `app.wxss` 中的字体定义是否正确
4. 考虑使用 emoji 或文字作为图标备选方案

### 如果性能问题仍然存在
1. 在云开发控制台创建建议的索引
2. 优化查询语句，避免全表扫描
3. 考虑数据分页加载
4. 监控数据库使用情况

## 完成标志

当以下条件全部满足时，问题解决完成：

- [ ] 所有核心数据库集合创建成功
- [ ] 登录和家庭功能正常工作
- [ ] 交易记录可以正常添加和查询
- [ ] 统计功能正常显示数据
- [ ] 字体加载错误消失
- [ ] 控制台无 -502005 错误

---

**创建时间**: 2025-09-07  
**更新时间**: 2025-09-07  
**状态**: 解决方案已实施