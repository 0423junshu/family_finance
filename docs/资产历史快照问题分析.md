# 资产历史快照问题分析报告

## 问题描述
自定义统计和按年统计中，资产数据显示异常：
- 只有2025年8月和9月显示数据
- 8月和9月都显示相同的数据（实际为9月数据）
- 其他月份显示为0

## 根本原因分析

### 1. 数据依赖问题
`generateMonthlyAssetData` 函数的数据获取逻辑：
```javascript
const assetSnap = wx.getStorageSync(`assets_${yearMonth}`) || null
const accounts = (assetSnap && Array.isArray(assetSnap.accounts))
  ? assetSnap.accounts
  : (wx.getStorageSync(`accounts:${yearMonth}`) || wx.getStorageSync('accounts') || [])
```

### 2. 历史快照缺失
- 系统依赖 `assets_YYYY-MM` 格式的历史快照数据
- 当历史快照不存在时，回退到当前数据
- 导致所有历史月份都显示当前月份的资产状态

### 3. 数据一致性问题
- 按年统计和自定义统计使用相同的数据源
- 但数据处理逻辑可能存在差异
- 前端数据填充可能覆盖了后端提供的历史数据

## 解决方案

### 方案1：历史快照生成机制
1. 创建历史资产快照生成功能
2. 基于交易记录重建历史资产状态
3. 定期保存资产快照到本地存储

### 方案2：实时计算历史资产
1. 基于交易记录实时计算历史资产
2. 不依赖预存的快照数据
3. 确保数据的准确性和一致性

### 方案3：混合模式
1. 优先使用快照数据（如果存在）
2. 快照不存在时实时计算
3. 提供快照重建功能

## 推荐实施方案
采用方案2（实时计算），因为：
- 数据准确性最高
- 不依赖历史快照的完整性
- 可以处理任意时间范围的查询
- 实现相对简单

## 实施步骤
1. 修改 `generateMonthlyAssetData` 函数
2. 添加基于交易记录的资产计算逻辑
3. 确保与现有数据结构兼容
4. 添加调试日志验证数据准确性