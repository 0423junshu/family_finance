# codebuddy-weapp-rules

> 📝 本文档由多个相关文档合并而成
> 🕒 合并时间: 2025-09-18 07:19:59
> 📂 原始文档数量: 4

---

## 主要内容
# Rules: WeChat Mini Program (CodeBuddy)

version: 1.0.0
last_updated: 2025-09-14
scope: family_finance mini-program
note: 本文件采用标准化规则块结构，便于 CodeBuddy 解析与自动化检查。

## index
- compatibility.api_versioning
- compatibility.cloud_sdk_network
- compatibility.device_variants
- architecture.layering
- architecture.data_flow
- architecture.state_management
- reuse.ui_components
- reuse.utils
- reuse.business_services
- productivity.lint_flow
- productivity.test_coverage
- performance.checklist
- weapp.wxs
- weapp.lifecycle
- pitfalls.setData_throttle
- pitfalls.cloud_permissions
- pitfalls.api_incompat
- pitfalls.sync_conflict
- pitfalls.component_communication
- appendix.structure
- appendix.commit_ci
- appendix.recommended_rules

### rule: compatibility.api_versioning
meta:
  title: 基础库与 API 版本适配
  priority: P0
  applicable: 使用新/差异化 API 时；Android/iOS/开发者工具/真机差异
definition:
  - 在调用能力前进行功能检测优先于版本判断
  - 对不支持能力提供降级/禁用提示；集中维护兼容封装
params:
  detect: wx.canIUse 或运行时能力检测
  fallback: 提示/禁用/polyfill
  registry: 在 docs/problems 记录最低基础库与差异
bad_example: |
  // 直接调用，未做能力检测
  wx.xxxNewAPI(options)
good_example: |
  if (!wx.canIUse('xxx')) {
    fallback()
  } else {
    wx.xxxNewAPI(options)
  }

### rule: compatibility.cloud_sdk_network
meta:
  title: 云开发 SDK 与网络请求统一
  priority: P1
  applicable: 同时存在 @cloudbase SDK / axios / wx.request
definition:
  - 统一 http 适配层，收敛重试、超时、错误码标准化
  - 固定 SDK 版本并定期审计
params:
  http_entry: services/http.ts
  policies: retry/timeout/error-normalization
bad_example: |
  // 页面内混用多种请求方式
  wx.request(...); axios.get(...);
good_example: |
  // 统一从 http 封装层调用
  import { http } from '@/services/http'
  http.get('/transactions')

### rule: compatibility.device_variants
meta:
  title: 端差异与设备能力
  priority: P1
  applicable: 刘海屏/键盘/性能差异；工具与真机差异
definition:
  - 使用 getSystemInfo 能力标识；采用安全区与自适应
  - 禁止硬编码魔数
params:
  info: wx.getSystemInfo
  layout: 安全区域 + 自适应布局
bad_example: |
  /* 顶部写死 44px */
  .navbar { padding-top: 44px; }
good_example: |
  // 通过系统信息动态计算安全区并应用样式变量

### rule: architecture.layering
meta:
  title: 分层架构
  priority: P0
  applicable: 页面复杂/多人协作
definition:
  - 层级：components/pages/services/repositories/cloudfunctions/utils/constants-types
  - 禁止跨层反向依赖；页面不直连数据库
params:
  flow: pages -> services -> repositories -> cloudfunctions
bad_example: |
  // 页面直接访问云数据库
  db.collection('t').add({...})
good_example: |
  // 页面经 service 调用
  import { createTxn } from '@/services/transactions'
  await createTxn(payload)

### rule: architecture.data_flow
meta:
  title: 单向数据流
  priority: P0
  applicable: 多组件数据传递
definition:
  - 页面持有源数据向下传递；事件向上冒泡
  - setData 批量/节流，避免高频更新
params:
  shared_state: 页面/全局 store 承载
bad_example: |
  // 各组件各自请求同一数据，导致竞态
good_example: |
  // 页面统一获取并通过 props 分发

### rule: architecture.state_management
meta:
  title: 状态管理方案
  priority: P0
  applicable: 登录、家庭成员、预算等全局数据
definition:
  - 采用 store 模式：state/actions/mutations/selectors
  - 本地缓存带版本；冷启动增量同步；冲突处理
params:
  persistence: storage + version
  conflict: version compare + 提示/合并
bad_example: |
  // 任意位置随意写 globalData
good_example: |
  // 通过封装的 store API 读写并广播

### rule: reuse.ui_components
meta:
  title: 公共组件库规范
  priority: P1
  applicable: 导航/弹窗/空态/骨架等
definition:
  - components/common 下放置；props 驱动，无副作用
  - 不在组件内部发起业务请求
params:
  doc: 组件需有属性表与 demo
bad_example: |
  // 通用弹窗中写死业务请求
good_example: |
  // 弹窗通过事件/插槽接入业务

### rule: reuse.utils
meta:
  title: 工具函数集
  priority: P1
  applicable: 格式化/校验/节流/拷贝/日志
definition:
  - utils 下按领域归类；保持纯函数；关键分支单测
params:
  side_effect: disallow
bad_example: |
  // 工具函数内部写入 storage
good_example: |
  // 纯函数返回结果，由上层决定副作用

### rule: reuse.business_services
meta:
  title: 业务逻辑封装
  priority: P0
  applicable: 账目、预算、权限等用例
definition:
  - services 聚合用例；repositories 适配数据源
  - I/O 在 types 定义；错误统一 code/message/hint
params:
  io: typed
bad_example: |
  // 多页面重复实现相同业务
good_example: |
  // service 封装后页面调用

### rule: productivity.lint_flow
meta:
  title: 代码风格检查流程
  priority: P0
  applicable: 提交前与 CI
definition:
  - 使用 ESLint/Prettier/Stylelint；提交前 lint-staged，CI 全量
  - 命名规范：camelCase/PascalCase/UPPER_SNAKE_CASE；JSDoc 注释复杂导出
params:
  tools: ESLint + Prettier + Stylelint
  hooks: husky pre-commit
bad_example: |
  // 跳过 lint 直接提交
good_example: |
  // pre-commit 自动执行 lint-staged 并阻止不合规提交

### rule: productivity.test_coverage
meta:
  title: 自动化测试覆盖率
  priority: P0
  applicable: 核心/高风险模块
definition:
  - 阈值：单元70%/集成50%/云函数60%
  - utils/services 优先单测；页面集成用例覆盖关键路径
params:
  thresholds:
    unit: 70
    integration: 50
    cloudfunctions: 60
bad_example: |
  // 新增复杂逻辑无任何测试
good_example: |
  // 补齐单测并满足覆盖率阈值

### rule: performance.checklist
meta:
  title: 性能优化清单
  priority: P0
  applicable: 首屏/长列表/频繁更新
definition:
  - setData 合并与最小化；长列表虚拟化；分包优化
  - 图片与字体按需与子集化；重计算放 WXS/云函数；接入性能监控
params:
  checklist:
    - setData batch/minimize
    - virtual_list
    - subpackages
    - image_cdn/webp/lazy
    - font_subset/display
    - wxs_or_cloud_precompute
    - perf_metrics_reporting
bad_example: |
  // 滚动中每项更新都 setData
good_example: |
  // 节流、批量更新或虚拟列表

### rule: weapp.wxs
meta:
  title: WXS 语法与边界
  priority: P1
  applicable: 渲染层轻逻辑、同步计算
definition:
  - 仅纯计算/格式化；禁止副作用与异步
  - 独立 wxs 文件，kebab-case 命名；与 JS 同名函数保持一致语义
params:
  purity: required
bad_example: |
  // 在 WXS 中访问全局或发起请求
good_example: |
  // 纯函数格式化数字与日期

### rule: weapp.lifecycle
meta:
  title: 生命周期管理
  priority: P1
  applicable: 数据拉取、监听注册、资源释放
definition:
  - App onLaunch 初始化；Page onLoad 取参、onShow 轻量刷新、onUnload 释放
  - Component attached 初始化、detached 释放；避免深度 observer 大对象
params:
  symmetry: subscribe/unsubscribe 对称
bad_example: |
  // onShow 每次全量拉取重数据
good_example: |
  // 缓存校验 + 增量刷新

### rule: pitfalls.setData_throttle
meta:
  title: 频繁 setData 导致卡顿
  priority: P0
  applicable: 滚动列表/输入联动
definition:
  - 合并与节流；仅更新变动字段
params:
  strategy: throttle + batch
bad_example: |
  for (i=0;i<n;i++){ this.setData({x:i}) }
good_example: |
  // 收集变更后单次 setData({x})

### rule: pitfalls.cloud_permissions
meta:
  title: 云函数权限与环境
  priority: P0
  applicable: 新环境/新成员部署
definition:
  - 最小权限；环境变量检查；发布前 checklist
params:
  scope: per-collection rules
bad_example: |
  // 默认权限访问敏感集合
good_example: |
  // 明确集合权限并最小授权

### rule: pitfalls.api_incompat
meta:
  title: 基础库差异导致 API 不可用
  priority: P0
  applicable: 低版本基础库/旧机型
definition:
  - canIUse 检测 + 降级；集中封装能力探测层
params:
  compat_layer: required
bad_example: |
  wx.xxxNewAPI()
good_example: |
  if (canUse) call(); else fallback();

### rule: pitfalls.sync_conflict
meta:
  title: 多端数据同步与冲突
  priority: P0
  applicable: 并发编辑预算/账目
definition:
  - 版本号/时间戳比对；最后写策略 + 冲突日志；必要时合并 UI
params:
  fields: _version/_updatedAt
bad_example: |
  // 无版本字段直接覆盖写
good_example: |
  // 比较版本，冲突则提示/合并

### rule: pitfalls.component_communication
meta:
  title: 组件通信混乱
  priority: P1
  applicable: 复杂嵌套组件
definition:
  - 单向数据流；事件冒泡；避免多真相源
params:
  state: 无状态优先，或局部本地状态
bad_example: |
  // 子组件直接修改父级数据
good_example: |
  // 子组件发事件，父级更新并下发 props

### rule: appendix.structure
meta:
  title: 目录结构建议
  priority: P2
  applicable: 项目初始化/重构
definition:
  - components/common、services、repositories、utils、constants/types、pages、cloudfunctions、docs
params:
  notes: 避免跨层依赖

### rule: appendix.commit_ci
meta:
  title: 提交与 CI 建议
  priority: P2
  applicable: 团队协作/流水线
definition:
  - 约定式提交；CI lint->test(阈值)->build->artifact
params:
  fail_fast: true

### rule: appendix.recommended_rules
meta:
  title: 推荐工具规则摘要
  priority: P2
  applicable: 本地与 CI 校验
definition:
  - ESLint/Prettier/Stylelint 推荐集，详见 docs/config
params:
  eslint: '@typescript-eslint/recommended, import/order, no-console warn, complexity 10'
  prettier: 'printWidth 100, singleQuote, trailingComma all'
  stylelint: 'standard config, BEM, no !important'
---
## 补充信息
### 来源: compatibility-fix.md
# 基础库3.9.3兼容性问题修复方案
## 问题分析
基础库从2.19.6升级到3.9.3后，报表页面出现显示不全和按钮无反应的问题。经过分析，主要原因包括：
### 1. Canvas API变化
### 2. 事件处理机制变化
### 3. 样式渲染问题
### 4. 生命周期变化
## 修复方案
### 方案1: 更新Canvas渲染逻辑
### 方案2: 修复事件处理机制
### 方案3: 适配样式兼容性
### 方案4: 优化页面加载逻辑
## 具体修复代码
详见下方修复文件...

### 来源: SharedArrayBuffer兼容性说明.md
# SharedArrayBuffer 兼容性说明（小程序环境）
- 无需对小程序代码做额外改动即可规避运行期问题。

### 来源: 为CodeBuddy制定微信小程序项目Rules（质量、架构、效率、兼容性、WXS与生命周期）.md
# 为CodeBuddy制定微信小程序项目Rules（质量、架构、效率、兼容性、WXS与生命周期）
## Core Features
- 版本兼容性、架构、复用、效率、性能、WXS/生命周期、问题清单
## Tech Stack
## Design
## Plan

## 原始文档列表
1. `analysis-reports\compatibility-fix.md`
2. `analysis-reports\SharedArrayBuffer兼容性说明.md`
3. `governance\为CodeBuddy制定微信小程序项目Rules（质量、架构、效率、兼容性、WXS与生命周期）.md`
4. `rules\codebuddy-weapp-rules.md`
