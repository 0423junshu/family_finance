# codebuddy-weapp-rules

> ğŸ“ æœ¬æ–‡æ¡£ç”±å¤šä¸ªç›¸å…³æ–‡æ¡£åˆå¹¶è€Œæˆ
> ğŸ•’ åˆå¹¶æ—¶é—´: 2025-09-18 07:19:59
> ğŸ“‚ åŸå§‹æ–‡æ¡£æ•°é‡: 4

---

## ä¸»è¦å†…å®¹
# Rules: WeChat Mini Program (CodeBuddy)

version: 1.0.0
last_updated: 2025-09-14
scope: family_finance mini-program
note: æœ¬æ–‡ä»¶é‡‡ç”¨æ ‡å‡†åŒ–è§„åˆ™å—ç»“æ„ï¼Œä¾¿äº CodeBuddy è§£æä¸è‡ªåŠ¨åŒ–æ£€æŸ¥ã€‚

## index
- compatibility.api_versioning
- compatibility.cloud_sdk_network
- compatibility.device_variants
- architecture.layering
- architecture.data_flow
- architecture.state_management
- reuse.ui_components
- reuse.utils
- reuse.business_services
- productivity.lint_flow
- productivity.test_coverage
- performance.checklist
- weapp.wxs
- weapp.lifecycle
- pitfalls.setData_throttle
- pitfalls.cloud_permissions
- pitfalls.api_incompat
- pitfalls.sync_conflict
- pitfalls.component_communication
- appendix.structure
- appendix.commit_ci
- appendix.recommended_rules

### rule: compatibility.api_versioning
meta:
  title: åŸºç¡€åº“ä¸ API ç‰ˆæœ¬é€‚é…
  priority: P0
  applicable: ä½¿ç”¨æ–°/å·®å¼‚åŒ– API æ—¶ï¼›Android/iOS/å¼€å‘è€…å·¥å…·/çœŸæœºå·®å¼‚
definition:
  - åœ¨è°ƒç”¨èƒ½åŠ›å‰è¿›è¡ŒåŠŸèƒ½æ£€æµ‹ä¼˜å…ˆäºç‰ˆæœ¬åˆ¤æ–­
  - å¯¹ä¸æ”¯æŒèƒ½åŠ›æä¾›é™çº§/ç¦ç”¨æç¤ºï¼›é›†ä¸­ç»´æŠ¤å…¼å®¹å°è£…
params:
  detect: wx.canIUse æˆ–è¿è¡Œæ—¶èƒ½åŠ›æ£€æµ‹
  fallback: æç¤º/ç¦ç”¨/polyfill
  registry: åœ¨ docs/problems è®°å½•æœ€ä½åŸºç¡€åº“ä¸å·®å¼‚
bad_example: |
  // ç›´æ¥è°ƒç”¨ï¼Œæœªåšèƒ½åŠ›æ£€æµ‹
  wx.xxxNewAPI(options)
good_example: |
  if (!wx.canIUse('xxx')) {
    fallback()
  } else {
    wx.xxxNewAPI(options)
  }

### rule: compatibility.cloud_sdk_network
meta:
  title: äº‘å¼€å‘ SDK ä¸ç½‘ç»œè¯·æ±‚ç»Ÿä¸€
  priority: P1
  applicable: åŒæ—¶å­˜åœ¨ @cloudbase SDK / axios / wx.request
definition:
  - ç»Ÿä¸€ http é€‚é…å±‚ï¼Œæ”¶æ•›é‡è¯•ã€è¶…æ—¶ã€é”™è¯¯ç æ ‡å‡†åŒ–
  - å›ºå®š SDK ç‰ˆæœ¬å¹¶å®šæœŸå®¡è®¡
params:
  http_entry: services/http.ts
  policies: retry/timeout/error-normalization
bad_example: |
  // é¡µé¢å†…æ··ç”¨å¤šç§è¯·æ±‚æ–¹å¼
  wx.request(...); axios.get(...);
good_example: |
  // ç»Ÿä¸€ä» http å°è£…å±‚è°ƒç”¨
  import { http } from '@/services/http'
  http.get('/transactions')

### rule: compatibility.device_variants
meta:
  title: ç«¯å·®å¼‚ä¸è®¾å¤‡èƒ½åŠ›
  priority: P1
  applicable: åˆ˜æµ·å±/é”®ç›˜/æ€§èƒ½å·®å¼‚ï¼›å·¥å…·ä¸çœŸæœºå·®å¼‚
definition:
  - ä½¿ç”¨ getSystemInfo èƒ½åŠ›æ ‡è¯†ï¼›é‡‡ç”¨å®‰å…¨åŒºä¸è‡ªé€‚åº”
  - ç¦æ­¢ç¡¬ç¼–ç é­”æ•°
params:
  info: wx.getSystemInfo
  layout: å®‰å…¨åŒºåŸŸ + è‡ªé€‚åº”å¸ƒå±€
bad_example: |
  /* é¡¶éƒ¨å†™æ­» 44px */
  .navbar { padding-top: 44px; }
good_example: |
  // é€šè¿‡ç³»ç»Ÿä¿¡æ¯åŠ¨æ€è®¡ç®—å®‰å…¨åŒºå¹¶åº”ç”¨æ ·å¼å˜é‡

### rule: architecture.layering
meta:
  title: åˆ†å±‚æ¶æ„
  priority: P0
  applicable: é¡µé¢å¤æ‚/å¤šäººåä½œ
definition:
  - å±‚çº§ï¼šcomponents/pages/services/repositories/cloudfunctions/utils/constants-types
  - ç¦æ­¢è·¨å±‚åå‘ä¾èµ–ï¼›é¡µé¢ä¸ç›´è¿æ•°æ®åº“
params:
  flow: pages -> services -> repositories -> cloudfunctions
bad_example: |
  // é¡µé¢ç›´æ¥è®¿é—®äº‘æ•°æ®åº“
  db.collection('t').add({...})
good_example: |
  // é¡µé¢ç» service è°ƒç”¨
  import { createTxn } from '@/services/transactions'
  await createTxn(payload)

### rule: architecture.data_flow
meta:
  title: å•å‘æ•°æ®æµ
  priority: P0
  applicable: å¤šç»„ä»¶æ•°æ®ä¼ é€’
definition:
  - é¡µé¢æŒæœ‰æºæ•°æ®å‘ä¸‹ä¼ é€’ï¼›äº‹ä»¶å‘ä¸Šå†’æ³¡
  - setData æ‰¹é‡/èŠ‚æµï¼Œé¿å…é«˜é¢‘æ›´æ–°
params:
  shared_state: é¡µé¢/å…¨å±€ store æ‰¿è½½
bad_example: |
  // å„ç»„ä»¶å„è‡ªè¯·æ±‚åŒä¸€æ•°æ®ï¼Œå¯¼è‡´ç«æ€
good_example: |
  // é¡µé¢ç»Ÿä¸€è·å–å¹¶é€šè¿‡ props åˆ†å‘

### rule: architecture.state_management
meta:
  title: çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
  priority: P0
  applicable: ç™»å½•ã€å®¶åº­æˆå‘˜ã€é¢„ç®—ç­‰å…¨å±€æ•°æ®
definition:
  - é‡‡ç”¨ store æ¨¡å¼ï¼šstate/actions/mutations/selectors
  - æœ¬åœ°ç¼“å­˜å¸¦ç‰ˆæœ¬ï¼›å†·å¯åŠ¨å¢é‡åŒæ­¥ï¼›å†²çªå¤„ç†
params:
  persistence: storage + version
  conflict: version compare + æç¤º/åˆå¹¶
bad_example: |
  // ä»»æ„ä½ç½®éšæ„å†™ globalData
good_example: |
  // é€šè¿‡å°è£…çš„ store API è¯»å†™å¹¶å¹¿æ’­

### rule: reuse.ui_components
meta:
  title: å…¬å…±ç»„ä»¶åº“è§„èŒƒ
  priority: P1
  applicable: å¯¼èˆª/å¼¹çª—/ç©ºæ€/éª¨æ¶ç­‰
definition:
  - components/common ä¸‹æ”¾ç½®ï¼›props é©±åŠ¨ï¼Œæ— å‰¯ä½œç”¨
  - ä¸åœ¨ç»„ä»¶å†…éƒ¨å‘èµ·ä¸šåŠ¡è¯·æ±‚
params:
  doc: ç»„ä»¶éœ€æœ‰å±æ€§è¡¨ä¸ demo
bad_example: |
  // é€šç”¨å¼¹çª—ä¸­å†™æ­»ä¸šåŠ¡è¯·æ±‚
good_example: |
  // å¼¹çª—é€šè¿‡äº‹ä»¶/æ’æ§½æ¥å…¥ä¸šåŠ¡

### rule: reuse.utils
meta:
  title: å·¥å…·å‡½æ•°é›†
  priority: P1
  applicable: æ ¼å¼åŒ–/æ ¡éªŒ/èŠ‚æµ/æ‹·è´/æ—¥å¿—
definition:
  - utils ä¸‹æŒ‰é¢†åŸŸå½’ç±»ï¼›ä¿æŒçº¯å‡½æ•°ï¼›å…³é”®åˆ†æ”¯å•æµ‹
params:
  side_effect: disallow
bad_example: |
  // å·¥å…·å‡½æ•°å†…éƒ¨å†™å…¥ storage
good_example: |
  // çº¯å‡½æ•°è¿”å›ç»“æœï¼Œç”±ä¸Šå±‚å†³å®šå‰¯ä½œç”¨

### rule: reuse.business_services
meta:
  title: ä¸šåŠ¡é€»è¾‘å°è£…
  priority: P0
  applicable: è´¦ç›®ã€é¢„ç®—ã€æƒé™ç­‰ç”¨ä¾‹
definition:
  - services èšåˆç”¨ä¾‹ï¼›repositories é€‚é…æ•°æ®æº
  - I/O åœ¨ types å®šä¹‰ï¼›é”™è¯¯ç»Ÿä¸€ code/message/hint
params:
  io: typed
bad_example: |
  // å¤šé¡µé¢é‡å¤å®ç°ç›¸åŒä¸šåŠ¡
good_example: |
  // service å°è£…åé¡µé¢è°ƒç”¨

### rule: productivity.lint_flow
meta:
  title: ä»£ç é£æ ¼æ£€æŸ¥æµç¨‹
  priority: P0
  applicable: æäº¤å‰ä¸ CI
definition:
  - ä½¿ç”¨ ESLint/Prettier/Stylelintï¼›æäº¤å‰ lint-stagedï¼ŒCI å…¨é‡
  - å‘½åè§„èŒƒï¼šcamelCase/PascalCase/UPPER_SNAKE_CASEï¼›JSDoc æ³¨é‡Šå¤æ‚å¯¼å‡º
params:
  tools: ESLint + Prettier + Stylelint
  hooks: husky pre-commit
bad_example: |
  // è·³è¿‡ lint ç›´æ¥æäº¤
good_example: |
  // pre-commit è‡ªåŠ¨æ‰§è¡Œ lint-staged å¹¶é˜»æ­¢ä¸åˆè§„æäº¤

### rule: productivity.test_coverage
meta:
  title: è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡
  priority: P0
  applicable: æ ¸å¿ƒ/é«˜é£é™©æ¨¡å—
definition:
  - é˜ˆå€¼ï¼šå•å…ƒ70%/é›†æˆ50%/äº‘å‡½æ•°60%
  - utils/services ä¼˜å…ˆå•æµ‹ï¼›é¡µé¢é›†æˆç”¨ä¾‹è¦†ç›–å…³é”®è·¯å¾„
params:
  thresholds:
    unit: 70
    integration: 50
    cloudfunctions: 60
bad_example: |
  // æ–°å¢å¤æ‚é€»è¾‘æ— ä»»ä½•æµ‹è¯•
good_example: |
  // è¡¥é½å•æµ‹å¹¶æ»¡è¶³è¦†ç›–ç‡é˜ˆå€¼

### rule: performance.checklist
meta:
  title: æ€§èƒ½ä¼˜åŒ–æ¸…å•
  priority: P0
  applicable: é¦–å±/é•¿åˆ—è¡¨/é¢‘ç¹æ›´æ–°
definition:
  - setData åˆå¹¶ä¸æœ€å°åŒ–ï¼›é•¿åˆ—è¡¨è™šæ‹ŸåŒ–ï¼›åˆ†åŒ…ä¼˜åŒ–
  - å›¾ç‰‡ä¸å­—ä½“æŒ‰éœ€ä¸å­é›†åŒ–ï¼›é‡è®¡ç®—æ”¾ WXS/äº‘å‡½æ•°ï¼›æ¥å…¥æ€§èƒ½ç›‘æ§
params:
  checklist:
    - setData batch/minimize
    - virtual_list
    - subpackages
    - image_cdn/webp/lazy
    - font_subset/display
    - wxs_or_cloud_precompute
    - perf_metrics_reporting
bad_example: |
  // æ»šåŠ¨ä¸­æ¯é¡¹æ›´æ–°éƒ½ setData
good_example: |
  // èŠ‚æµã€æ‰¹é‡æ›´æ–°æˆ–è™šæ‹Ÿåˆ—è¡¨

### rule: weapp.wxs
meta:
  title: WXS è¯­æ³•ä¸è¾¹ç•Œ
  priority: P1
  applicable: æ¸²æŸ“å±‚è½»é€»è¾‘ã€åŒæ­¥è®¡ç®—
definition:
  - ä»…çº¯è®¡ç®—/æ ¼å¼åŒ–ï¼›ç¦æ­¢å‰¯ä½œç”¨ä¸å¼‚æ­¥
  - ç‹¬ç«‹ wxs æ–‡ä»¶ï¼Œkebab-case å‘½åï¼›ä¸ JS åŒåå‡½æ•°ä¿æŒä¸€è‡´è¯­ä¹‰
params:
  purity: required
bad_example: |
  // åœ¨ WXS ä¸­è®¿é—®å…¨å±€æˆ–å‘èµ·è¯·æ±‚
good_example: |
  // çº¯å‡½æ•°æ ¼å¼åŒ–æ•°å­—ä¸æ—¥æœŸ

### rule: weapp.lifecycle
meta:
  title: ç”Ÿå‘½å‘¨æœŸç®¡ç†
  priority: P1
  applicable: æ•°æ®æ‹‰å–ã€ç›‘å¬æ³¨å†Œã€èµ„æºé‡Šæ”¾
definition:
  - App onLaunch åˆå§‹åŒ–ï¼›Page onLoad å–å‚ã€onShow è½»é‡åˆ·æ–°ã€onUnload é‡Šæ”¾
  - Component attached åˆå§‹åŒ–ã€detached é‡Šæ”¾ï¼›é¿å…æ·±åº¦ observer å¤§å¯¹è±¡
params:
  symmetry: subscribe/unsubscribe å¯¹ç§°
bad_example: |
  // onShow æ¯æ¬¡å…¨é‡æ‹‰å–é‡æ•°æ®
good_example: |
  // ç¼“å­˜æ ¡éªŒ + å¢é‡åˆ·æ–°

### rule: pitfalls.setData_throttle
meta:
  title: é¢‘ç¹ setData å¯¼è‡´å¡é¡¿
  priority: P0
  applicable: æ»šåŠ¨åˆ—è¡¨/è¾“å…¥è”åŠ¨
definition:
  - åˆå¹¶ä¸èŠ‚æµï¼›ä»…æ›´æ–°å˜åŠ¨å­—æ®µ
params:
  strategy: throttle + batch
bad_example: |
  for (i=0;i<n;i++){ this.setData({x:i}) }
good_example: |
  // æ”¶é›†å˜æ›´åå•æ¬¡ setData({x})

### rule: pitfalls.cloud_permissions
meta:
  title: äº‘å‡½æ•°æƒé™ä¸ç¯å¢ƒ
  priority: P0
  applicable: æ–°ç¯å¢ƒ/æ–°æˆå‘˜éƒ¨ç½²
definition:
  - æœ€å°æƒé™ï¼›ç¯å¢ƒå˜é‡æ£€æŸ¥ï¼›å‘å¸ƒå‰ checklist
params:
  scope: per-collection rules
bad_example: |
  // é»˜è®¤æƒé™è®¿é—®æ•æ„Ÿé›†åˆ
good_example: |
  // æ˜ç¡®é›†åˆæƒé™å¹¶æœ€å°æˆæƒ

### rule: pitfalls.api_incompat
meta:
  title: åŸºç¡€åº“å·®å¼‚å¯¼è‡´ API ä¸å¯ç”¨
  priority: P0
  applicable: ä½ç‰ˆæœ¬åŸºç¡€åº“/æ—§æœºå‹
definition:
  - canIUse æ£€æµ‹ + é™çº§ï¼›é›†ä¸­å°è£…èƒ½åŠ›æ¢æµ‹å±‚
params:
  compat_layer: required
bad_example: |
  wx.xxxNewAPI()
good_example: |
  if (canUse) call(); else fallback();

### rule: pitfalls.sync_conflict
meta:
  title: å¤šç«¯æ•°æ®åŒæ­¥ä¸å†²çª
  priority: P0
  applicable: å¹¶å‘ç¼–è¾‘é¢„ç®—/è´¦ç›®
definition:
  - ç‰ˆæœ¬å·/æ—¶é—´æˆ³æ¯”å¯¹ï¼›æœ€åå†™ç­–ç•¥ + å†²çªæ—¥å¿—ï¼›å¿…è¦æ—¶åˆå¹¶ UI
params:
  fields: _version/_updatedAt
bad_example: |
  // æ— ç‰ˆæœ¬å­—æ®µç›´æ¥è¦†ç›–å†™
good_example: |
  // æ¯”è¾ƒç‰ˆæœ¬ï¼Œå†²çªåˆ™æç¤º/åˆå¹¶

### rule: pitfalls.component_communication
meta:
  title: ç»„ä»¶é€šä¿¡æ··ä¹±
  priority: P1
  applicable: å¤æ‚åµŒå¥—ç»„ä»¶
definition:
  - å•å‘æ•°æ®æµï¼›äº‹ä»¶å†’æ³¡ï¼›é¿å…å¤šçœŸç›¸æº
params:
  state: æ— çŠ¶æ€ä¼˜å…ˆï¼Œæˆ–å±€éƒ¨æœ¬åœ°çŠ¶æ€
bad_example: |
  // å­ç»„ä»¶ç›´æ¥ä¿®æ”¹çˆ¶çº§æ•°æ®
good_example: |
  // å­ç»„ä»¶å‘äº‹ä»¶ï¼Œçˆ¶çº§æ›´æ–°å¹¶ä¸‹å‘ props

### rule: appendix.structure
meta:
  title: ç›®å½•ç»“æ„å»ºè®®
  priority: P2
  applicable: é¡¹ç›®åˆå§‹åŒ–/é‡æ„
definition:
  - components/commonã€servicesã€repositoriesã€utilsã€constants/typesã€pagesã€cloudfunctionsã€docs
params:
  notes: é¿å…è·¨å±‚ä¾èµ–

### rule: appendix.commit_ci
meta:
  title: æäº¤ä¸ CI å»ºè®®
  priority: P2
  applicable: å›¢é˜Ÿåä½œ/æµæ°´çº¿
definition:
  - çº¦å®šå¼æäº¤ï¼›CI lint->test(é˜ˆå€¼)->build->artifact
params:
  fail_fast: true

### rule: appendix.recommended_rules
meta:
  title: æ¨èå·¥å…·è§„åˆ™æ‘˜è¦
  priority: P2
  applicable: æœ¬åœ°ä¸ CI æ ¡éªŒ
definition:
  - ESLint/Prettier/Stylelint æ¨èé›†ï¼Œè¯¦è§ docs/config
params:
  eslint: '@typescript-eslint/recommended, import/order, no-console warn, complexity 10'
  prettier: 'printWidth 100, singleQuote, trailingComma all'
  stylelint: 'standard config, BEM, no !important'
---
## è¡¥å……ä¿¡æ¯
### æ¥æº: compatibility-fix.md
# åŸºç¡€åº“3.9.3å…¼å®¹æ€§é—®é¢˜ä¿®å¤æ–¹æ¡ˆ
## é—®é¢˜åˆ†æ
åŸºç¡€åº“ä»2.19.6å‡çº§åˆ°3.9.3åï¼ŒæŠ¥è¡¨é¡µé¢å‡ºç°æ˜¾ç¤ºä¸å…¨å’ŒæŒ‰é’®æ— ååº”çš„é—®é¢˜ã€‚ç»è¿‡åˆ†æï¼Œä¸»è¦åŸå› åŒ…æ‹¬ï¼š
### 1. Canvas APIå˜åŒ–
### 2. äº‹ä»¶å¤„ç†æœºåˆ¶å˜åŒ–
### 3. æ ·å¼æ¸²æŸ“é—®é¢˜
### 4. ç”Ÿå‘½å‘¨æœŸå˜åŒ–
## ä¿®å¤æ–¹æ¡ˆ
### æ–¹æ¡ˆ1: æ›´æ–°Canvasæ¸²æŸ“é€»è¾‘
### æ–¹æ¡ˆ2: ä¿®å¤äº‹ä»¶å¤„ç†æœºåˆ¶
### æ–¹æ¡ˆ3: é€‚é…æ ·å¼å…¼å®¹æ€§
### æ–¹æ¡ˆ4: ä¼˜åŒ–é¡µé¢åŠ è½½é€»è¾‘
## å…·ä½“ä¿®å¤ä»£ç 
è¯¦è§ä¸‹æ–¹ä¿®å¤æ–‡ä»¶...

### æ¥æº: SharedArrayBufferå…¼å®¹æ€§è¯´æ˜.md
# SharedArrayBuffer å…¼å®¹æ€§è¯´æ˜ï¼ˆå°ç¨‹åºç¯å¢ƒï¼‰
- æ— éœ€å¯¹å°ç¨‹åºä»£ç åšé¢å¤–æ”¹åŠ¨å³å¯è§„é¿è¿è¡ŒæœŸé—®é¢˜ã€‚

### æ¥æº: ä¸ºCodeBuddyåˆ¶å®šå¾®ä¿¡å°ç¨‹åºé¡¹ç›®Rulesï¼ˆè´¨é‡ã€æ¶æ„ã€æ•ˆç‡ã€å…¼å®¹æ€§ã€WXSä¸ç”Ÿå‘½å‘¨æœŸï¼‰.md
# ä¸ºCodeBuddyåˆ¶å®šå¾®ä¿¡å°ç¨‹åºé¡¹ç›®Rulesï¼ˆè´¨é‡ã€æ¶æ„ã€æ•ˆç‡ã€å…¼å®¹æ€§ã€WXSä¸ç”Ÿå‘½å‘¨æœŸï¼‰
## Core Features
- ç‰ˆæœ¬å…¼å®¹æ€§ã€æ¶æ„ã€å¤ç”¨ã€æ•ˆç‡ã€æ€§èƒ½ã€WXS/ç”Ÿå‘½å‘¨æœŸã€é—®é¢˜æ¸…å•
## Tech Stack
## Design
## Plan

## åŸå§‹æ–‡æ¡£åˆ—è¡¨
1. `analysis-reports\compatibility-fix.md`
2. `analysis-reports\SharedArrayBufferå…¼å®¹æ€§è¯´æ˜.md`
3. `governance\ä¸ºCodeBuddyåˆ¶å®šå¾®ä¿¡å°ç¨‹åºé¡¹ç›®Rulesï¼ˆè´¨é‡ã€æ¶æ„ã€æ•ˆç‡ã€å…¼å®¹æ€§ã€WXSä¸ç”Ÿå‘½å‘¨æœŸï¼‰.md`
4. `rules\codebuddy-weapp-rules.md`
