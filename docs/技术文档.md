# 家庭财务管理微信小程序技术文档（方案一）

## 1. 技术架构概览
- 前端：微信小程序原生框架（WXML / WXSS / JS）
- 后端：腾讯云·云开发（CloudBase）
  - 云数据库（NoSQL）
  - 云函数（Node.js）
  - 云存储（图片、导出文件）
- 图表库：ECharts 小程序版
- 授权与推送：微信登录、订阅消息、文件上传能力

## 2. 环境与依赖

### 2.1 开发环境
- 操作系统：Windows/macOS
- 工具：微信开发者工具 v1.05+
- Node.js：v16+
- SDK：@cloudbase/js-sdk

### 2.2 项目依赖
- 小程序 SDK：微信内置
- CloudBase SDK：npm 包安装  
  ```bash
  npm install @cloudbase/js-sdk
  ```
- ECharts 小程序版：npm 包或手动拷贝  
  ```bash
  npm install echarts-for-weixin
  ```
- ESLint/Prettier：保持代码风格一致

## 3. 项目结构
```
/miniprogram
  ├── components/        # 自定义组件
  ├── pages/             # 页面目录
  ├── utils/             # 通用工具函数
  ├── services/          # 云函数调用封装
  ├── cloudfunctions/    # 云函数
  ├── app.js             # 入口逻辑
  ├── app.json           # 路由 & window 配置
  ├── app.wxss           # 全局样式
```

## 4. 云开发数据库设计

### 4.1 集合与字段
- `users`：用户表
  - _id, openid, nickname, avatar, createdAt, updatedAt
- `families`：家庭表
  - _id, name, ownerId, members[{userId, role, joinedAt}], createdAt, updatedAt
- `transactions`：交易记录
  - _id, familyId, type, amount, categoryId, accountId, targetAccountId, memberId, date, description, images[], tags[], createdBy, createdAt, updatedAt
- `accounts`、`categories`、`budgets`、`goals`、`debts`、`recurrings` 等同理

### 4.2 索引
- `familyId + date`：账单查询
- `familyId + type`：类型过滤
- `members.userId`：成员权限校验

## 5. 云函数设计

### 5.1 目录结构
```
/cloudfunctions
  ├── createTransaction
  ├── updateTransaction
  ├── deleteTransaction
  ├── syncBank
  ├── generateReport
  ├── conflictResolver
  └── ...
```

### 5.2 调用示例
```js
// services/transaction.js
import cloudbase from '@cloudbase/js-sdk'
const app = cloudbase.init({ env: 'prod-xxxxx' });
export async function createTransaction(data) {
  return app.callFunction({ name: 'createTransaction', data })
}
```

### 5.3 冲突解决
- 参数：localVersion, remoteVersion
- 返回：mergedRecord
- 云函数 `conflictResolver` 对比字段，按更新时间提示合并三选一

## 6. 前端交互与数据流

### 6.1 登录与鉴权
- `wx.login()` 获取临时 code
- 云函数 `login` 换取 openid 并写入 `users`
- 客户端全局 state 存储用户信息

### 6.2 数据同步
- CRUD 操作均调用云函数，返回后更新本地页面数据
- 实时提示：调用后触发页面顶部气泡标记同步状态
- 离线支持：使用 `wx.setStorageSync` 缓存未同步操作，网络恢复后逐条重试

### 6.3 显示/隐藏金额
- 全局 mixin 或 util 管理眼睛图标状态（保存在 `wx.getStorageSync('hideAmount')`）
- 页面 `onShow` 读取状态，渲染模板中 `{{ hideAmount ? '***' : amount }}`

## 7. 组件与页面

### 7.1 组件
- `<navigation-bar>`：定制导航
- `<period-selector>`：周期切换
- `<transaction-item>`：账单列表项
- `<chart-panel>`：ECharts 容器

### 7.2 主要页面
- `pages/index`：首页账本列表
- `pages/record`：记一笔
- `pages/reports`：报表
- `pages/assets`：资产
- `pages/invest`：投资
- `pages/me`：我的

## 8. 性能与优化

### 8.1 数据分页与懒加载
- 列表按日期倒序，分批加载 20 条
- 滚动触底触发 `onReachBottom`

### 8.2 缓存
- 热门分类、标签本地缓存一天刷新
- 报表数据缓存在 `wx.setStorageSync('report_'+period)`

### 8.3 云函数冷启动
- 将常用逻辑合并至同名函数，减少冷启动次数
- 关键函数预热：用户登录后调用空函数

## 9. 安全规则

- 云数据库权限配置：  
  ```json
  {
    "read": "request.auth != null && resource.data.familyId in request.auth.token.families",
    "write": "request.auth != null && resource.data.createdBy == request.auth.uid"
  }
  ```
- 云函数鉴权：检查 `WXContext.OPENID` 与记录 owner/admin 权限

## 10. 日志与监控

- 云函数 `console.log` 写入云开发日志
- 关键操作（CRUD、冲突）触发自定义统计埋点
- 使用微信小程序性能面板监测首屏渲染、JS 执行时长

## 11. 部署与 CI/CD

- GitHub Actions / Tencent Cloud CI：  
  - 提交 master 自动运行 `npm run lint` + 单元测试  
  - 部署云函数与小程序代码至微信开发者后台  

## 12. 附录

### 12.1 错误码定义
| Code | 描述                   |
|------|------------------------|
| 1001 | 参数校验失败           |
| 1002 | 权限不足               |
| 2001 | 云函数执行异常         |
| 3001 | 离线同步重试失败       |

### 12.2 接口列表
- `login`：用户登录  
- `createTransaction` / `updateTransaction` / `deleteTransaction`  
- `syncBank`：银行同步  
- `generateReport`：年度报表