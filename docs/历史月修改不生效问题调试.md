# 历史月修改不生效问题调试

## 问题发现

### 当前代码逻辑问题
**文件**：`pages/account-manage/account-manage.js`

**问题代码**：
```javascript
// 保存到本地存储
let accounts = wx.getStorageSync('accounts') || []  // ❌ 总是从主存储加载

if (this.data.mode === 'create') {
  accounts.push(accountData)
} else {
  const index = accounts.findIndex(acc => acc.id === accountData.id)
  if (index !== -1) {
    accounts[index] = { ...accounts[index], ...accountData }
  }
}

// 判断是否为当前月份
const lastViewedMonth = wx.getStorageSync('lastViewedMonth')
const isCurrentMonth = !lastViewedMonth || lastViewedMonth === currentYmKey

if (isCurrentMonth) {
  wx.setStorageSync('accounts', accounts)
  wx.setStorageSync(`accounts:${currentYmKey}`, accounts)
} else {
  // ❌ 问题：保存的是基于主存储修改的数据，不是基于历史存储
  wx.setStorageSync(`accounts:${lastViewedMonth}`, accounts)
}
```

### 问题根因
1. **数据源错误**：历史月份修改时仍从主存储 `accounts` 加载数据
2. **修改基础错误**：在主存储数据基础上修改，而不是历史存储数据
3. **数据覆盖**：历史月份的原有修改被主存储数据覆盖

### 错误流程示例
```
1. 历史月份 2024-10 有账户A余额1000元（已修改过）
2. 主存储中账户A余额500元（当前月份数据）
3. 用户在2024-10修改账户A余额为1500元
4. 代码从主存储加载账户A余额500元 ❌
5. 修改为1500元并保存到 accounts:2024-10
6. 结果：2024-10的原有修改（1000元）丢失 ❌
```

## 正确的修复方案

### 修复后的逻辑
```javascript
// 根据当前查看的月份加载正确的数据源
const lastViewedMonth = wx.getStorageSync('lastViewedMonth')
const currentDate = new Date()
const currentYmKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`
const isCurrentMonth = !lastViewedMonth || lastViewedMonth === currentYmKey

let accounts
if (isCurrentMonth) {
  // 当前月份：从主存储加载
  accounts = wx.getStorageSync('accounts') || []
} else {
  // 历史月份：从历史存储加载
  accounts = wx.getStorageSync(`accounts:${lastViewedMonth}`) || []
  
  // 如果历史存储为空，从主存储初始化
  if (accounts.length === 0) {
    accounts = wx.getStorageSync('accounts') || []
  }
}

// 执行修改操作
if (this.data.mode === 'create') {
  accounts.push(accountData)
} else {
  const index = accounts.findIndex(acc => acc.id === accountData.id)
  if (index !== -1) {
    accounts[index] = { ...accounts[index], ...accountData }
  }
}

// 保存到正确的存储位置
if (isCurrentMonth) {
  wx.setStorageSync('accounts', accounts)
  wx.setStorageSync(`accounts:${currentYmKey}`, accounts)
} else {
  wx.setStorageSync(`accounts:${lastViewedMonth}`, accounts)
}
```

### 正确流程示例
```
1. 历史月份 2024-10 有账户A余额1000元（已修改过）
2. 用户在2024-10修改账户A余额为1500元
3. 代码从 accounts:2024-10 加载账户A余额1000元 ✅
4. 修改为1500元并保存到 accounts:2024-10
5. 结果：2024-10显示1500元，历史修改得到保留 ✅
```

## 测试验证

### 测试用例1：历史月份修改
1. 选择历史月份 2024-10
2. 修改账户A余额为1000元
3. 切换到当前月份，再切换回2024-10
4. 验证：账户A余额仍为1000元

### 测试用例2：多次历史修改
1. 在2024-10修改账户A余额为1000元
2. 在2024-10再次修改账户A余额为1500元
3. 验证：账户A余额为1500元（基于1000元修改）

### 测试用例3：跨月份独立性
1. 在2024-10修改账户A余额为1000元
2. 切换到2024-11，账户A余额应为原始值
3. 切换到当前月份，账户A余额应为当前值
4. 切换回2024-10，账户A余额应为1000元

---

**问题状态**：已识别根因  
**修复方案**：已设计完成  
**优先级**：高（核心功能缺陷）  
**创建时间**：2025-01-06