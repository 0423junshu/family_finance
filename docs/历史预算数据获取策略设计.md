# å†å²é¢„ç®—æ•°æ®è·å–ç­–ç•¥è®¾è®¡

## é—®é¢˜åˆ†æ

### ç°æœ‰é¢„ç®—ç³»ç»Ÿçš„å±€é™æ€§

é€šè¿‡åˆ†æç°æœ‰ä»£ç ï¼Œå‘ç°é¢„ç®—ç®¡ç†ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

```javascript
// å½“å‰é¢„ç®—æ•°æ®ç»“æ„ï¼ˆcloudfunctions/manageBudget/index.jsï¼‰
const budgetData = {
  categoryId: 'food',
  categoryName: 'é¤é¥®',
  amount: 1500,
  period: 'monthly', // åªæœ‰å‘¨æœŸç±»å‹ï¼Œæ²¡æœ‰å…·ä½“æ—¶é—´
  type: 'expense',
  spent: 0,
  createdAt: new Date(),
  updatedAt: new Date()
  // ç¼ºå°‘: year, month ç­‰æ—¶é—´ç»´åº¦å­—æ®µ
}
```

**æ ¸å¿ƒé—®é¢˜ï¼š**
1. âŒ **ç¼ºå°‘æ—¶é—´ç»´åº¦**ï¼šé¢„ç®—æ•°æ®æ²¡æœ‰ç»‘å®šå…·ä½“çš„å¹´æœˆ
2. âŒ **æ— æ³•åŒºåˆ†å†å²é¢„ç®—**ï¼šæ— æ³•è·å–ç‰¹å®šæœˆä»½çš„å†å²é¢„ç®—è®¾ç½®
3. âŒ **æ•°æ®è¦†ç›–é—®é¢˜**ï¼šä¿®æ”¹é¢„ç®—ä¼šè¦†ç›–å†å²æ•°æ®ï¼Œæ— æ³•è¿½æº¯

## è§£å†³æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šé¢„ç®—æ•°æ®ç»“æ„é‡æ„ï¼ˆæ¨èï¼‰

#### 1.1 æ–°çš„é¢„ç®—æ•°æ®ç»“æ„
```javascript
// é‡æ„åçš„é¢„ç®—æ•°æ®ç»“æ„
const budgetDataV2 = {
  id: 'budget_expense_food_2025_09',
  categoryId: 'food',
  categoryName: 'é¤é¥®',
  amount: 1500,
  type: 'expense',
  year: 2025,           // æ–°å¢ï¼šå¹´ä»½
  month: 9,             // æ–°å¢ï¼šæœˆä»½
  period: 'monthly',    // ä¿ç•™ï¼šå‘¨æœŸç±»å‹
  status: 'active',     // æ–°å¢ï¼šçŠ¶æ€ï¼ˆactive/archived/templateï¼‰
  isTemplate: false,    // æ–°å¢ï¼šæ˜¯å¦ä¸ºæ¨¡æ¿
  templateId: null,     // æ–°å¢ï¼šæ¨¡æ¿IDï¼ˆç”¨äºå¤åˆ¶é¢„ç®—ï¼‰
  spent: 0,             // å®é™…æ”¯å‡ºï¼ˆå®æ—¶è®¡ç®—ï¼‰
  createdAt: new Date(),
  updatedAt: new Date(),
  createdBy: 'user_123' // æ–°å¢ï¼šåˆ›å»ºè€…
}
```

#### 1.2 é¢„ç®—æ¨¡æ¿æœºåˆ¶
```javascript
// é¢„ç®—æ¨¡æ¿æ•°æ®ç»“æ„
const budgetTemplate = {
  id: 'template_expense_food',
  categoryId: 'food',
  categoryName: 'é¤é¥®',
  amount: 1500,
  type: 'expense',
  period: 'monthly',
  isTemplate: true,
  status: 'active',
  createdAt: new Date(),
  updatedAt: new Date()
}
```

### æ–¹æ¡ˆäºŒï¼šå†å²æ•°æ®è·å–ç­–ç•¥

#### 2.1 æ•°æ®è·å–ä¼˜å…ˆçº§
```javascript
async function getHistoricalBudgetData(year, month, categoryId, type) {
  // ä¼˜å…ˆçº§1: æŸ¥æ‰¾è¯¥æœˆä»½çš„å…·ä½“é¢„ç®—è®¾ç½®
  const specificBudget = await getBudgetByMonth(year, month, categoryId, type);
  if (specificBudget) {
    return specificBudget;
  }
  
  // ä¼˜å…ˆçº§2: æŸ¥æ‰¾æœ€è¿‘çš„é¢„ç®—æ¨¡æ¿
  const template = await getBudgetTemplate(categoryId, type);
  if (template) {
    return {
      ...template,
      year,
      month,
      isFromTemplate: true,
      originalTemplateId: template.id
    };
  }
  
  // ä¼˜å…ˆçº§3: åŸºäºå†å²å®é™…æ”¯å‡ºè‡ªåŠ¨ç”Ÿæˆé¢„ç®—
  const historicalAverage = await calculateHistoricalAverage(categoryId, type, year, month);
  if (historicalAverage > 0) {
    return {
      categoryId,
      categoryName: await getCategoryName(categoryId),
      amount: Math.round(historicalAverage * 1.1), // å†å²å¹³å‡å€¼ + 10%
      type,
      year,
      month,
      isAutoGenerated: true,
      generationMethod: 'historical_average'
    };
  }
  
  // ä¼˜å…ˆçº§4: è¿”å›ç©ºé¢„ç®—ï¼ˆæ— å†å²æ•°æ®ï¼‰
  return null;
}
```

#### 2.2 å†å²æ•°æ®å¡«å……è§„åˆ™

##### è§„åˆ™1ï¼šåŸºäºå†å²å®é™…æ”¯å‡ºå¡«å……
```javascript
async function fillBudgetFromHistoricalSpending(categoryId, type, targetYear, targetMonth) {
  // è·å–è¿‡å»6ä¸ªæœˆçš„å¹³å‡æ”¯å‡º
  const historicalData = await getHistoricalSpending(categoryId, type, 6);
  
  if (historicalData.length === 0) {
    return null;
  }
  
  // è®¡ç®—åŠ æƒå¹³å‡ï¼ˆè¿‘æœŸæƒé‡æ›´é«˜ï¼‰
  const weightedAverage = calculateWeightedAverage(historicalData);
  
  // è€ƒè™‘å­£èŠ‚æ€§å› ç´ 
  const seasonalFactor = getSeasonalFactor(categoryId, targetMonth);
  
  // ç”Ÿæˆé¢„ç®—å»ºè®®
  const suggestedBudget = Math.round(weightedAverage * seasonalFactor);
  
  return {
    categoryId,
    amount: suggestedBudget,
    type,
    year: targetYear,
    month: targetMonth,
    isAutoGenerated: true,
    generationMethod: 'weighted_historical_average',
    confidence: calculateConfidence(historicalData),
    sourceData: {
      historicalMonths: historicalData.length,
      averageAmount: weightedAverage,
      seasonalFactor
    }
  };
}
```

##### è§„åˆ™2ï¼šåŸºäºåŒç±»åˆ†ç±»å¡«å……
```javascript
async function fillBudgetFromSimilarCategories(categoryId, type, targetYear, targetMonth) {
  // è·å–åŒç±»å‹åˆ†ç±»çš„é¢„ç®—è®¾ç½®
  const similarCategories = await getSimilarCategories(categoryId, type);
  
  if (similarCategories.length === 0) {
    return null;
  }
  
  // è®¡ç®—åŒç±»åˆ†ç±»çš„å¹³å‡é¢„ç®—
  const averageBudget = similarCategories.reduce((sum, cat) => sum + cat.amount, 0) / similarCategories.length;
  
  return {
    categoryId,
    amount: Math.round(averageBudget),
    type,
    year: targetYear,
    month: targetMonth,
    isAutoGenerated: true,
    generationMethod: 'similar_categories_average',
    sourceData: {
      similarCategoriesCount: similarCategories.length,
      averageAmount: averageBudget
    }
  };
}
```

##### è§„åˆ™3ï¼šåŸºäºæ”¶å…¥æ¯”ä¾‹å¡«å……
```javascript
async function fillBudgetFromIncomeRatio(categoryId, type, targetYear, targetMonth) {
  if (type !== 'expense') {
    return null;
  }
  
  // è·å–è¯¥æœˆä»½çš„æ€»æ”¶å…¥
  const monthlyIncome = await getMonthlyIncome(targetYear, targetMonth);
  if (monthlyIncome <= 0) {
    return null;
  }
  
  // æ ¹æ®åˆ†ç±»è·å–æ¨èæ¯”ä¾‹
  const recommendedRatio = getCategoryRecommendedRatio(categoryId);
  
  const suggestedBudget = Math.round(monthlyIncome * recommendedRatio);
  
  return {
    categoryId,
    amount: suggestedBudget,
    type,
    year: targetYear,
    month: targetMonth,
    isAutoGenerated: true,
    generationMethod: 'income_ratio',
    sourceData: {
      monthlyIncome,
      recommendedRatio,
      ratioPercentage: Math.round(recommendedRatio * 100)
    }
  };
}
```

### æ–¹æ¡ˆä¸‰ï¼šæ•°æ®è¿ç§»ç­–ç•¥

#### 3.1 ç°æœ‰æ•°æ®è¿ç§»
```javascript
async function migrateLegacyBudgetData() {
  console.log('å¼€å§‹è¿ç§»å†å²é¢„ç®—æ•°æ®...');
  
  // 1. è·å–æ‰€æœ‰ç°æœ‰é¢„ç®—æ•°æ®
  const legacyBudgets = await db.collection('budgets').get();
  
  // 2. ä¸ºæ¯ä¸ªé¢„ç®—åˆ›å»ºæ¨¡æ¿
  const templates = legacyBudgets.data.map(budget => ({
    ...budget,
    id: `template_${budget.type}_${budget.categoryId}`,
    isTemplate: true,
    status: 'active',
    migratedFrom: budget._id
  }));
  
  // 3. ä¿å­˜æ¨¡æ¿åˆ°æ–°é›†åˆ
  await db.collection('budget_templates').add(templates);
  
  // 4. ä¸ºå½“å‰æœˆä»½åˆ›å»ºå…·ä½“é¢„ç®—
  const currentYear = new Date().getFullYear();
  const currentMonth = new Date().getMonth() + 1;
  
  const currentBudgets = legacyBudgets.data.map(budget => ({
    ...budget,
    id: `budget_${budget.type}_${budget.categoryId}_${currentYear}_${currentMonth}`,
    year: currentYear,
    month: currentMonth,
    templateId: `template_${budget.type}_${budget.categoryId}`,
    isTemplate: false,
    status: 'active'
  }));
  
  // 5. ä¿å­˜å½“å‰æœˆä»½é¢„ç®—
  await db.collection('budgets_v2').add(currentBudgets);
  
  console.log('é¢„ç®—æ•°æ®è¿ç§»å®Œæˆ');
}
```

#### 3.2 æ¸è¿›å¼è¿ç§»
```javascript
// å…¼å®¹æ€§å¤„ç†ï¼šåŒæ—¶æ”¯æŒæ–°æ—§æ•°æ®ç»“æ„
async function getBudgetDataCompatible(year, month, categoryId, type) {
  // ä¼˜å…ˆä½¿ç”¨æ–°æ•°æ®ç»“æ„
  const newBudget = await getBudgetV2(year, month, categoryId, type);
  if (newBudget) {
    return newBudget;
  }
  
  // å›é€€åˆ°æ—§æ•°æ®ç»“æ„
  const legacyBudget = await getLegacyBudget(categoryId, type);
  if (legacyBudget) {
    // è½¬æ¢ä¸ºæ–°æ ¼å¼
    return {
      ...legacyBudget,
      year,
      month,
      isLegacy: true
    };
  }
  
  return null;
}
```

## å…·ä½“å®ç°æ–¹æ¡ˆ

### 4.1 æŒ‰å¹´ç»Ÿè®¡çš„å†å²é¢„ç®—è·å–

```javascript
async function getYearlyBudgetComparison(year) {
  const result = {
    year,
    months: [],
    categories: {}
  };
  
  // è·å–è¯¥å¹´åº¦æ¯ä¸ªæœˆçš„é¢„ç®—æ•°æ®
  for (let month = 1; month <= 12; month++) {
    const monthlyBudgets = await getMonthlyBudgets(year, month);
    
    result.months.push({
      month,
      budgets: monthlyBudgets,
      totalBudgeted: monthlyBudgets.reduce((sum, b) => sum + b.amount, 0),
      totalActual: await getMonthlyActualSpending(year, month)
    });
    
    // æŒ‰åˆ†ç±»æ±‡æ€»
    monthlyBudgets.forEach(budget => {
      if (!result.categories[budget.categoryId]) {
        result.categories[budget.categoryId] = {
          categoryId: budget.categoryId,
          categoryName: budget.categoryName,
          type: budget.type,
          monthlyData: []
        };
      }
      
      result.categories[budget.categoryId].monthlyData.push({
        month,
        budgeted: budget.amount,
        actual: await getCategoryMonthlySpending(year, month, budget.categoryId, budget.type),
        isAutoGenerated: budget.isAutoGenerated || false
      });
    });
  }
  
  return result;
}
```

### 4.2 è‡ªå®šä¹‰å‘¨æœŸçš„å†å²é¢„ç®—è·å–

```javascript
async function getCustomPeriodBudgetComparison(startDate, endDate) {
  const start = new Date(startDate);
  const end = new Date(endDate);
  const result = {
    period: `${startDate} è‡³ ${endDate}`,
    months: [],
    totalBudgeted: 0,
    totalActual: 0
  };
  
  // éå†å‘¨æœŸå†…çš„æ¯ä¸ªæœˆ
  let current = new Date(start.getFullYear(), start.getMonth(), 1);
  while (current <= end) {
    const year = current.getFullYear();
    const month = current.getMonth() + 1;
    
    // è®¡ç®—è¯¥æœˆåœ¨å‘¨æœŸå†…çš„å¤©æ•°æ¯”ä¾‹
    const monthStart = new Date(year, month - 1, 1);
    const monthEnd = new Date(year, month, 0);
    const periodStart = start > monthStart ? start : monthStart;
    const periodEnd = end < monthEnd ? end : monthEnd;
    const daysInPeriod = Math.ceil((periodEnd - periodStart) / (1000 * 60 * 60 * 24)) + 1;
    const totalDaysInMonth = monthEnd.getDate();
    const dayRatio = daysInPeriod / totalDaysInMonth;
    
    // è·å–è¯¥æœˆé¢„ç®—å¹¶æŒ‰æ¯”ä¾‹è®¡ç®—
    const monthlyBudgets = await getMonthlyBudgets(year, month);
    const adjustedBudgets = monthlyBudgets.map(budget => ({
      ...budget,
      amount: Math.round(budget.amount * dayRatio),
      originalAmount: budget.amount,
      dayRatio
    }));
    
    const monthlyBudgeted = adjustedBudgets.reduce((sum, b) => sum + b.amount, 0);
    const monthlyActual = await getPeriodActualSpending(periodStart, periodEnd);
    
    result.months.push({
      year,
      month,
      daysInPeriod,
      totalDaysInMonth,
      dayRatio,
      budgets: adjustedBudgets,
      budgeted: monthlyBudgeted,
      actual: monthlyActual
    });
    
    result.totalBudgeted += monthlyBudgeted;
    result.totalActual += monthlyActual;
    
    // ç§»åŠ¨åˆ°ä¸‹ä¸ªæœˆ
    current.setMonth(current.getMonth() + 1);
  }
  
  return result;
}
```

## ç”¨æˆ·ç•Œé¢æç¤º

### 5.1 æ•°æ®æ¥æºæ ‡è¯†
```javascript
// åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ•°æ®æ¥æº
const budgetSourceLabels = {
  'specific': 'âœ… å·²è®¾ç½®',
  'template': 'ğŸ“‹ æ¨¡æ¿',
  'historical_average': 'ğŸ“Š å†å²å¹³å‡',
  'similar_categories': 'ğŸ”„ åŒç±»å‚è€ƒ',
  'income_ratio': 'ğŸ’° æ”¶å…¥æ¯”ä¾‹',
  'auto_generated': 'ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ'
};

// ç•Œé¢å±•ç¤ºç¤ºä¾‹
function renderBudgetItem(budget) {
  const sourceLabel = budgetSourceLabels[budget.generationMethod] || 'â“ æœªçŸ¥';
  
  return `
    <view class="budget-item">
      <view class="category-name">${budget.categoryName}</view>
      <view class="budget-amount">é¢„ç®—: Â¥${budget.amount}</view>
      <view class="budget-source">${sourceLabel}</view>
      ${budget.isAutoGenerated ? '<view class="auto-tip">ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</view>' : ''}
    </view>
  `;
}
```

### 5.2 é¢„ç®—å»ºè®®åŠŸèƒ½
```javascript
// ä¸ºç¼ºå¤±é¢„ç®—çš„åˆ†ç±»æä¾›å»ºè®®
async function generateBudgetSuggestions(year, month) {
  const categories = await getAllCategories();
  const suggestions = [];
  
  for (const category of categories) {
    const existingBudget = await getBudgetByMonth(year, month, category.id, category.type);
    
    if (!existingBudget) {
      const suggestion = await generateBudgetSuggestion(category.id, category.type, year, month);
      if (suggestion) {
        suggestions.push(suggestion);
      }
    }
  }
  
  return suggestions;
}
```

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šè®¾è®¡æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ•ˆè§£å†³å†å²é¢„ç®—æ•°æ®è·å–çš„é—®é¢˜ï¼š

1. **æ•°æ®ç»“æ„é‡æ„**ï¼šä¸ºé¢„ç®—æ•°æ®å¢åŠ æ—¶é—´ç»´åº¦ï¼Œæ”¯æŒå†å²æ•°æ®è¿½æº¯
2. **æ™ºèƒ½å¡«å……ç­–ç•¥**ï¼šåŸºäºå†å²æ”¯å‡ºã€åŒç±»åˆ†ç±»ã€æ”¶å…¥æ¯”ä¾‹ç­‰å¤šç§æ–¹å¼è‡ªåŠ¨ç”Ÿæˆé¢„ç®—
3. **æ¸è¿›å¼è¿ç§»**ï¼šä¿è¯ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼Œå¹³æ»‘è¿‡æ¸¡åˆ°æ–°æ•°æ®ç»“æ„
4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šæ¸…æ™°æ ‡è¯†æ•°æ®æ¥æºï¼Œæä¾›é¢„ç®—å»ºè®®åŠŸèƒ½

è¿™æ ·æ—¢è§£å†³äº†å†å²æ•°æ®ç¼ºå¤±çš„é—®é¢˜ï¼Œåˆä¸ºç”¨æˆ·æä¾›äº†æ™ºèƒ½çš„é¢„ç®—ç®¡ç†ä½“éªŒã€‚