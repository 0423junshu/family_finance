# 资产历史数据修复实施方案

## 修复概述
针对自定义统计和按年统计中资产数据显示异常的问题，实施了基于交易记录的历史资产计算方案。

## 问题分析
### 原始问题
- 只有2025年8月和9月显示资产数据
- 8月和9月显示相同数据（实际为9月数据）
- 其他月份资产数据显示为0

### 根本原因
- `generateMonthlyAssetData` 函数依赖历史快照 `assets_${yearMonth}`
- 历史快照数据缺失或不完整
- 回退机制使用当前数据，导致历史数据不准确

## 修复方案

### 1. 增强数据获取逻辑
```javascript
// 优先使用历史快照，如果不存在则基于交易记录实时计算
const assetSnap = wx.getStorageSync(`assets_${yearMonth}`) || null

if (assetSnap && Array.isArray(assetSnap.accounts)) {
  // 使用历史快照数据
  accounts = assetSnap.accounts
  investments = assetSnap.investments || []
} else {
  // 基于交易记录计算历史状态
  accounts = await calculateHistoricalAccounts(currentAccounts, targetDate)
  investments = await calculateHistoricalInvestments(currentInvestments, targetDate)
}
```

### 2. 历史账户状态计算
实现 `calculateHistoricalAccounts` 函数：
- 从当前账户状态开始
- 倒序处理目标日期之后的交易
- 回退每笔交易对账户余额的影响
- 支持支出、收入、转账三种交易类型

### 3. 历史投资状态计算
实现 `calculateHistoricalInvestments` 函数：
- 过滤出目标日期之前存在的投资
- 使用简化的历史估值逻辑
- 确保投资数据的时间一致性

### 4. 调试日志增强
添加详细的调试日志：
- 数据源选择过程
- 历史计算步骤
- 交易回退数量
- 最终资产状态

## 技术实现

### 核心算法
1. **时间判断**：区分当前月份、历史月份、未来月份
2. **交易回退**：基于交易类型反向计算账户余额变化
3. **数据兼容**：保持与现有数据结构的兼容性

### 交易回退逻辑
```javascript
// 支出：回退时增加余额
if (type === 'expense') accountBalance += amount

// 收入：回退时减少余额  
if (type === 'income') accountBalance -= amount

// 转账：回退转出账户余额，减少转入账户余额
if (type === 'transfer') {
  fromAccount.balance += amount
  toAccount.balance -= amount
}
```

## 预期效果
1. **数据准确性**：历史月份显示真实的资产变化趋势
2. **数据一致性**：自定义统计与按年统计数据保持一致
3. **时间完整性**：所有月份都有对应的资产数据
4. **调试可见性**：通过日志可追踪数据处理过程

## 测试验证
### 验证点
1. 自定义统计是否显示历史资产变化趋势
2. 按年统计与自定义统计数据是否一致
3. 控制台日志是否显示正确的数据来源
4. 各月份资产数据是否合理且连续

### 测试场景
- 选择不同的自定义时间范围
- 对比按年统计和自定义统计结果
- 检查控制台调试日志输出
- 验证资产趋势图的连续性

## 后续优化
1. 考虑添加资产快照自动生成机制
2. 优化历史投资估值算法
3. 增加数据缓存机制提升性能
4. 完善错误处理和异常恢复