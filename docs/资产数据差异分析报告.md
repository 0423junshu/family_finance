# 按年统计与自定义统计资产数据差异分析报告

## 问题描述

用户反馈自定义统计功能下资产列数据不准确，需要对比按年统计和自定义统计两种模式的资产数据获取逻辑，找出差异原因。

## 数据源对比分析

### 按年统计资产数据获取方式

**位置**: `services/report.js` 第1120-1140行

**实现逻辑**:
```javascript
// 按年统计 - 每个月份调用 generateMonthlyAssetData
for (let i = 0; i < maxMonth; i++) {
  const ymKey = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
  const a = await generateMonthlyAssetData(ymKey);  // 获取历史资产快照
  const m = yearlyReport.monthlyStats[i] || { income: 0, expense: 0 };
  arr.push({
    date: ymKey,
    year: currentYear,
    month: i + 1,
    totalAssets: a.totalAssets || 0  // 使用历史快照数据
  });
}
```

**特点**:
- ✅ 每个月份都调用 `generateMonthlyAssetData(ymKey)` 获取历史资产快照
- ✅ 使用真实的月度资产历史数据
- ✅ 能准确反映资产变化趋势

### 自定义统计资产数据获取方式

**位置**: `services/report.js` 第1335-1393行

**实现逻辑**:
```javascript
// 自定义统计 - 按月聚合趋势数据
reportData.trendData = await (async () => {
  const trendMap = {};
  // ... 处理收支数据 ...
  
  // 为每个月份添加资产信息
  for (const ymKey of Object.keys(trendMap)) {
    const assetData = await generateMonthlyAssetData(ymKey);
    trendMap[ymKey].totalAssets = assetData.totalAssets || 0;
  }
  
  return Object.values(trendMap).sort((a, b) => a.date.localeCompare(b.date));
})();
```

**特点**:
- ✅ 也调用了 `generateMonthlyAssetData(ymKey)` 获取历史资产快照
- ✅ 理论上应该与按年统计使用相同的数据源

## 前端数据处理差异分析

### 按年统计前端处理

**位置**: `pages/reports/reports-simple.js` 第850-870行

```javascript
// 按年统计时，直接使用后端返回的 totalAssets
let result = (data.trendData || []).map(item => ({
  ...item,
  label: String(item.month).padStart(2, '0'),
  dateDisplay: item.dateDisplay || `${item.year}年${String(item.month).padStart(2, '0')}月`
}));
```

### 自定义统计前端处理

**位置**: `pages/reports/reports-simple.js` 第780-850行

```javascript
// 自定义统计 - 问题所在！
const accounts = wx.getStorageSync('accounts') || [];
const investments = wx.getStorageSync('investments') || [];
const totalAssets = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0) + 
                   investments.reduce((sum, inv) => sum + (inv.currentValue || 0), 0);

// 所有月份都使用相同的当前资产总额！
const filledData = months.map(m => {
  return {
    // ...
    totalAssets: totalAssets  // ❌ 错误：使用当前资产而非历史数据
  };
});
```

## 根本原因分析

### 🔍 发现的问题

1. **后端逻辑正确**: 自定义统计的后端逻辑与按年统计一致，都调用 `generateMonthlyAssetData()` 获取历史资产数据

2. **前端处理错误**: 自定义统计的前端在数据填充时，**忽略了后端返回的历史资产数据**，而是使用当前时刻的资产总额填充所有月份

3. **数据覆盖问题**: 前端的 `fillTrendData` 函数中，为了填充缺失月份，错误地用当前资产值覆盖了后端返回的正确历史数据

## 具体排查步骤

### 1. 数据源验证
```javascript
// 在 services/report.js 中添加调试日志
console.log('自定义统计后端资产数据:', {
  ymKey,
  backendAssets: assetData.totalAssets,
  source: 'generateMonthlyAssetData'
});
```

### 2. 前端处理验证
```javascript
// 在 pages/reports/reports-simple.js 中添加调试日志
console.log('自定义统计前端处理:', {
  backendData: data.trendData,
  frontendOverride: totalAssets,
  isOverriding: true
});
```

### 3. 结果校验方法
- 对比相同月份在按年统计和自定义统计中的资产数值
- 检查后端返回的原始数据是否包含正确的 `totalAssets`
- 验证前端是否错误覆盖了后端数据

## 修复方案

### 方案一：保留后端数据（推荐）
```javascript
// 修复前端逻辑，优先使用后端返回的历史资产数据
return existing ? {
  ...existing,
  totalAssets: existing.totalAssets || monthAssets  // 优先使用后端数据
} : {
  // 只有在后端完全没有数据时才使用当前资产
  totalAssets: monthAssets
};
```

### 方案二：完善数据获取
```javascript
// 为缺失的月份也调用后端获取历史资产数据
const monthAssets = await getHistoricalAssets(ymKey);
```

## 预期修复效果

- 自定义统计的资产列将显示真实的历史资产变化趋势
- 与按年统计的资产数据保持一致性
- 用户能够准确分析资产在自定义时间段内的变化情况