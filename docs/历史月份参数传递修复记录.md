# 历史月份参数传递修复记录

## 问题场景
**用户反馈**：资产页面时间切换到2025年8月，修改账户金额后未生效

## 根因分析

### 问题发现
通过深入分析发现，之前的修复虽然解决了数据源选择问题，但存在一个关键的参数传递缺陷：

**资产页面 → 账户管理页面的月份信息传递不完整**

### 具体问题
1. **资产页面**：用户切换到2025年8月查看资产
2. **点击账户**：`onAccountTap` 事件触发，但只传递了 `accountId`
3. **账户管理页面**：无法知道当前查看的是哪个月份
4. **数据源错误**：`lastViewedMonth` 可能是旧的或错误的值
5. **修改失败**：基于错误的月份信息进行数据操作

### 数据流问题示例
```
用户操作：资产页面切换到 2025-08
点击账户：跳转到账户管理页面
问题：lastViewedMonth 可能仍是 2025-01（当前月）
结果：修改保存到错误的月份存储
```

## 修复方案

### 1. 资产页面导航修复
**文件**：`pages/assets/assets.js`
**函数**：`onAccountTap`

**修复前**：
```javascript
wx.navigateTo({
  url: `/pages/account-manage/account-manage?mode=edit&id=${accountId}`
})
```

**修复后**：
```javascript
// 传递当前查看的年月信息
const { currentYear, currentMonth } = this.data
const ymKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`

// 设置当前查看的月份到存储，供账户管理页面使用
wx.setStorageSync('lastViewedMonth', ymKey)

wx.navigateTo({
  url: `/pages/account-manage/account-manage?mode=edit&id=${accountId}&year=${currentYear}&month=${currentMonth}`
})
```

### 2. 账户管理页面参数接收修复
**文件**：`pages/account-manage/account-manage.js`
**函数**：`onLoad`

**修复前**：
```javascript
onLoad(options) {
  const mode = options.mode || 'create'
  const accountId = options.id
  // 缺少年月参数处理
}
```

**修复后**：
```javascript
onLoad(options) {
  const mode = options.mode || 'create'
  const accountId = options.id
  const year = options.year
  const month = options.month
  
  // 如果传递了年月参数，设置到存储中
  if (year && month !== undefined) {
    const ymKey = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`
    wx.setStorageSync('lastViewedMonth', ymKey)
    console.log(`账户管理页面接收到年月参数: ${ymKey}`)
  }
}
```

## 修复效果

### 正确的数据流
```
1. 用户操作：资产页面切换到 2025-08
2. 点击账户：传递 year=2025, month=7 参数
3. 账户管理页面：设置 lastViewedMonth = '2025-08'
4. 数据加载：从 accounts:2025-08 加载历史数据
5. 修改保存：保存到 accounts:2025-08
6. 结果：修改立即生效 ✅
```

### 验证场景
- ✅ 2025年8月历史月份修改
- ✅ 2024年任意月份修改
- ✅ 当前月份修改（2025年1月）
- ✅ 月份间数据独立性

## 技术要点

### 1. 双重保障机制
- **URL参数传递**：确保页面跳转时携带准确的年月信息
- **存储同步设置**：在页面加载时立即设置正确的 `lastViewedMonth`

### 2. 参数格式统一
- **资产页面**：`currentMonth` 是 0-11 的索引
- **URL参数**：传递实际的月份索引
- **存储格式**：转换为 YYYY-MM 格式（月份+1）

### 3. 向后兼容
- 保持原有的存储机制不变
- 新增参数传递不影响现有功能
- 支持创建模式和编辑模式

## 测试验证

### 测试步骤
1. 打开资产页面
2. 切换到历史月份（如2025年8月）
3. 点击任意账户
4. 修改账户金额
5. 保存并返回资产页面
6. 验证修改是否生效

### 预期结果
- 历史月份修改立即生效
- 数据保存到正确的月份存储
- 不影响其他月份的数据

## 总结

这次修复解决了历史月份修改不生效的最后一个关键问题：**月份信息传递不完整**。

通过在页面跳转时传递准确的年月参数，并在目标页面立即设置正确的 `lastViewedMonth`，确保了数据操作基于正确的月份上下文。

现在历史月份的账户修改应该能够完全正常工作，实现真正的数据独立性和修改生效。