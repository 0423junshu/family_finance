# 资产页面交互优化记录

## 问题分析

### 1. 修改不生效问题
- **根本原因**：`loadData` 函数存在多层数据源查找逻辑，优先级复杂
- **具体表现**：修改账户金额后，数据可能从其他数据源重新加载，覆盖修改
- **数据源优先级**：资产快照 > 月份存储 > 历史记录 > 当前数据

### 2. 交互冗余问题
- **现状**：存在两种修改方式
  - 点击账户卡片 → 跳转到 account-manage 页面
  - 点击卡片上的"编辑"按钮 → 弹出编辑对话框
- **问题**：用户体验不一致，操作路径混乱

### 3. 数据清零问题
- **根本原因**：编译后可能触发数据初始化逻辑
- **具体表现**：每次编译后账户数据被重置为空数组或默认值
- **影响范围**：主要影响账户数据，投资数据相对稳定

## 解决方案

### 1. 简化交互逻辑
- **移除**：卡片编辑按钮和编辑对话框
- **保留**：点击账户卡片跳转到修改页面
- **优势**：统一操作体验，减少代码复杂度

### 2. 优化数据流
- **统一数据源**：优先使用当前月份数据，历史月份使用快照
- **简化逻辑**：减少数据源查找层级
- **确保持久化**：修改后立即保存到正确的存储位置

### 3. 修复初始化问题
- **添加数据校验**：在 `onLoad` 和 `onShow` 中检查数据完整性
- **防御性编程**：确保数据源存在时才进行操作
- **日志记录**：添加详细的数据加载和保存日志

## 实施计划

### Phase 1: 简化交互
1. 移除 WXML 中的编辑按钮
2. 删除相关的编辑对话框代码
3. 简化 CSS 样式

### Phase 2: 优化数据流
1. 重构 `loadData` 函数，简化数据源逻辑
2. 优化 `saveAmount` 函数，确保数据正确保存
3. 添加数据一致性检查

### Phase 3: 修复初始化
1. 优化页面生命周期函数
2. 添加数据恢复机制
3. 完善错误处理

## 技术细节

### 数据流优化
```javascript
// 简化后的数据加载逻辑
async loadData(year, month) {
  const ymKey = `${year}-${String(month + 1).padStart(2, '0')}`
  const currentYmKey = getCurrentYmKey()
  
  if (ymKey === currentYmKey) {
    // 当前月份：使用最新数据
    return this.loadCurrentMonthData()
  } else {
    // 历史月份：使用快照数据
    return this.loadHistoricalData(ymKey)
  }
}
```

### 数据持久化策略
- **当前月份**：同时保存到 `accounts` 和 `accounts:${ymKey}`
- **历史月份**：仅保存到 `accounts:${ymKey}`
- **快照机制**：定期创建资产快照，确保数据完整性

## 预期效果

1. **用户体验**：操作路径清晰，交互一致
2. **数据可靠性**：修改立即生效，不会丢失
3. **系统稳定性**：减少数据冲突，提高可维护性

## 风险评估

- **低风险**：移除编辑对话框不影响核心功能
- **中风险**：数据流优化需要充分测试
- **缓解措施**：保留原有数据备份，分步实施

## 测试用例

1. **基础功能测试**
   - 点击账户卡片能正常跳转
   - 修改账户信息能正确保存
   - 返回资产页面数据正确显示

2. **数据持久化测试**
   - 修改后重启小程序，数据保持
   - 编译后数据不被清零
   - 历史月份数据修改不影响当前月份

3. **边界情况测试**
   - 网络异常时的数据处理
   - 存储空间不足时的降级策略
   - 数据格式异常时的容错处理

---

*创建时间：2025-01-06*
*状态：设计完成，待实施*