# å®¶åº­åä½œåŠŸèƒ½é—®é¢˜ä¿®å¤è®°å½•

## é—®é¢˜ä¿®å¤æ—¥å¿—

### é—®é¢˜ #001: æ•°æ®åº“é›†åˆä¸å­˜åœ¨é”™è¯¯
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 12:30
**é”™è¯¯ä»£ç **: -502005
**é”™è¯¯ä¿¡æ¯**: `database collection not exists | errMsg: [ResourceNotFound] Db or Table not exist`

**é—®é¢˜åŸå› **:
å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘ç¯å¢ƒä¸­ï¼Œæ•°æ®åº“é›†åˆéœ€è¦å…ˆåˆ›å»ºæ‰èƒ½ä½¿ç”¨ã€‚å½“ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨å®¶åº­åä½œåŠŸèƒ½æ—¶ï¼Œç›¸å…³çš„æ•°æ®åº“é›†åˆï¼ˆfamilies, family_members, family_invitationsï¼‰å°šæœªåˆ›å»ºã€‚

**è§£å†³æ–¹æ¡ˆ**:
1. åˆ›å»ºäº† `cloudfunctions/initDatabase/index.js` äº‘å‡½æ•°
2. åœ¨ `services/family.js` ä¸­æ·»åŠ è‡ªåŠ¨åˆå§‹åŒ–æœºåˆ¶
3. å½“æ£€æµ‹åˆ°é›†åˆä¸å­˜åœ¨æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨åˆå§‹åŒ–å‡½æ•°

**ä¿®å¤ä»£ç **:
```javascript
// cloudfunctions/initDatabase/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    // åˆ›å»ºå¿…è¦çš„é›†åˆ
    await db.createCollection('families');
    await db.createCollection('family_members'); 
    await db.createCollection('family_invitations');
    
    return { success: true, message: 'æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ' };
  } catch (error) {
    return { success: false, message: error.message };
  }
};
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œç”¨æˆ·é¦–æ¬¡ä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“

---

### é—®é¢˜ #002: Toastæ–¹æ³•è°ƒç”¨é”™è¯¯
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 12:45
**é”™è¯¯ä¿¡æ¯**: `TypeError: toast.showToast is not a function`

**é—®é¢˜åŸå› **:
ä»£ç ä¸­ä½¿ç”¨äº†TDesignçš„toastç»„ä»¶æ–¹æ³•ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ç»„ä»¶æœªæ­£ç¡®åˆå§‹åŒ–æˆ–å¼•ç”¨é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:
å°†æ‰€æœ‰ `toast.showToast` è°ƒç”¨æ›¿æ¢ä¸ºå¾®ä¿¡åŸç”Ÿçš„ `wx.showToast`ï¼Œé¿å…ç»„ä»¶ä¾èµ–é—®é¢˜ã€‚

**ä¿®å¤ä»£ç **:
```javascript
// ä¿®å¤å‰
toast.showToast({
  title: message,
  type: type
});

// ä¿®å¤å
wx.showToast({
  title: message,
  icon: type === 'success' ? 'success' : 'error'
});
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œæ‰€æœ‰æç¤ºä¿¡æ¯æ­£å¸¸æ˜¾ç¤º

---

### é—®é¢˜ #003: æ•°æ®æ ¼å¼å¤„ç†é”™è¯¯
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 13:00
**é”™è¯¯ä¿¡æ¯**: `members.map is not a function`

**é—®é¢˜åŸå› **:
æœåŠ¡è¿”å›çš„æ•°æ®æ ¼å¼ä¸ä¸€è‡´ï¼Œæœ‰æ—¶è¿”å›å¯¹è±¡åŒ…å«membersæ•°ç»„ï¼Œæœ‰æ—¶ç›´æ¥è¿”å›æ•°ç»„ï¼Œå¯¼è‡´mapæ–¹æ³•è°ƒç”¨å¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆ**:
1. æ ‡å‡†åŒ–æ‰€æœ‰æœåŠ¡çš„è¿”å›æ ¼å¼ä¸º `{success, code, message, data}`
2. åœ¨é¡µé¢ä¸­æ­£ç¡®è§£ææ•°æ®ç»“æ„
3. æ·»åŠ æ•°æ®ç±»å‹æ£€æŸ¥å’Œé»˜è®¤å€¼å¤„ç†

**ä¿®å¤ä»£ç **:
```javascript
// services/family.js - æ ‡å‡†åŒ–è¿”å›æ ¼å¼
return { success: true, members };

// pages/family/family.js - å®‰å…¨çš„æ•°æ®å¤„ç†
const members = membersResult.success ? membersResult.members : [];
const safeMembers = Array.isArray(members) ? members : [];
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œæˆå‘˜åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º

---

### é—®é¢˜ #004: é»˜è®¤å¤´åƒèµ„æºåŠ è½½å¤±è´¥
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 13:15
**é”™è¯¯ä¿¡æ¯**: `Failed to load local image resource /images/default-avatar.png`

**é—®é¢˜åŸå› **:
1. PNGæ ¼å¼çš„é»˜è®¤å¤´åƒæ–‡ä»¶ä¸å­˜åœ¨
2. å°ç¨‹åºå¯¹æœ¬åœ°å›¾ç‰‡èµ„æºçš„è®¿é—®é™åˆ¶

**è§£å†³æ–¹æ¡ˆ**:
1. åˆ›å»ºSVGæ ¼å¼çš„é»˜è®¤å¤´åƒ `/images/default-avatar.svg`
2. æ›´æ–°æ‰€æœ‰å¼•ç”¨è·¯å¾„ä»PNGæ”¹ä¸ºSVG
3. åˆ›å»ºå¤´åƒå·¥å…·å‡½æ•°å¤„ç†åŠ è½½å¤±è´¥çš„æƒ…å†µ

**ä¿®å¤ä»£ç **:
```javascript
// images/default-avatar.svg
<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
  <circle cx="40" cy="40" r="40" fill="#E7E7E7"/>
  <circle cx="40" cy="32" r="12" fill="#FFFFFF"/>
  <path d="M20 65 C20 52, 28 45, 40 45 C52 45, 60 52, 60 65 Z" fill="#FFFFFF"/>
</svg>

// services/family.js - æ›´æ–°å¤´åƒè·¯å¾„
avatar: userInfo.avatarUrl || '/images/default-avatar.svg'
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œé»˜è®¤å¤´åƒæ­£å¸¸æ˜¾ç¤º

---

### é—®é¢˜ #005: TDesignå­—ä½“åŠ è½½å¤±è´¥
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 13:30
**é”™è¯¯ä¿¡æ¯**: `Failed to load font https://tdesign.gtimg.com/icon/0.3.2/fonts/t.woff`

**é—®é¢˜åŸå› **:
TDesignç»„ä»¶åº“ä¾èµ–çš„åœ¨çº¿å­—ä½“æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå¯èƒ½ç”±äºç½‘ç»œé—®é¢˜æˆ–CDNä¸å¯ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**:
åœ¨ `app.wxss` ä¸­æ·»åŠ å­—ä½“å›é€€æ–¹æ¡ˆï¼Œå½“åœ¨çº¿å­—ä½“åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ç³»ç»Ÿå­—ä½“ã€‚

**ä¿®å¤ä»£ç **:
```css
/* app.wxss - æ·»åŠ å­—ä½“å›é€€ */
@font-face {
  font-family: 'TDesign';
  src: url('https://tdesign.gtimg.com/icon/0.3.2/fonts/t.woff') format('woff');
  font-display: swap;
}

/* å­—ä½“å›é€€æ–¹æ¡ˆ */
.t-icon {
  font-family: 'TDesign', 'iconfont', sans-serif !important;
}

/* é€šç”¨å­—ä½“å›é€€ */
* {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œç•Œé¢å­—ä½“æ­£å¸¸æ˜¾ç¤º

---

### é—®é¢˜ #006: btoaå‡½æ•°å…¼å®¹æ€§é”™è¯¯ ğŸš¨
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 14:00
**é”™è¯¯ä¿¡æ¯**: `ReferenceError: btoa is not defined`
**ä¸¥é‡ç¨‹åº¦**: é«˜ - å¯¼è‡´æ‰€æœ‰é¡µé¢æ— æ³•ä½¿ç”¨

**é—®é¢˜åŸå› **:
å¾®ä¿¡å°ç¨‹åºç¯å¢ƒä¸æ”¯æŒæµè§ˆå™¨çš„`btoa`å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºbase64ç¼–ç ã€‚åœ¨`utils/defaultAvatar.js`ä¸­ä½¿ç”¨äº†`btoa`å‡½æ•°æ¥ç¼–ç SVGå¤´åƒï¼Œå¯¼è‡´æ•´ä¸ªåº”ç”¨æ— æ³•æ­£å¸¸è¿è¡Œã€‚

**å½±å“èŒƒå›´**:
- æ‰€æœ‰ä½¿ç”¨sync-statusç»„ä»¶çš„é¡µé¢
- æ‰€æœ‰éœ€è¦æ˜¾ç¤ºé»˜è®¤å¤´åƒçš„åŠŸèƒ½
- å®¶åº­åä½œåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**:
1. ç§»é™¤`btoa`å‡½æ•°çš„ä½¿ç”¨
2. ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºå…¼å®¹çš„ç¼–ç æ–¹å¼
3. é‡‡ç”¨`data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`æ ¼å¼
4. æ·»åŠ å¾®ä¿¡å°ç¨‹åºç¯å¢ƒæ£€æµ‹å’Œå¤‡ç”¨æ–¹æ¡ˆ

**ä¿®å¤ä»£ç **:
```javascript
// ä¿®å¤å‰ - ä¸å…¼å®¹
const DEFAULT_AVATAR_BASE64 = `data:image/svg+xml;base64,${btoa(DEFAULT_AVATAR_SVG)}`;

// ä¿®å¤å - å¾®ä¿¡å°ç¨‹åºå…¼å®¹
const DEFAULT_AVATAR_BASE64 = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(DEFAULT_AVATAR_SVG)}`;

// æ·»åŠ å…¼å®¹æ€§æ£€æµ‹
function base64Encode(str) {
  if (typeof wx !== 'undefined' && wx.arrayBufferToBase64) {
    const buffer = new ArrayBuffer(str.length);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < str.length; i++) {
      view[i] = str.charCodeAt(i);
    }
    return wx.arrayBufferToBase64(buffer);
  }
  return encodeURIComponent(str);
}
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œæ‰€æœ‰é¡µé¢æ¢å¤æ­£å¸¸ä½¿ç”¨

**ç»éªŒæ•™è®­**:
- å¾®ä¿¡å°ç¨‹åºç¯å¢ƒä¸æµè§ˆå™¨ç¯å¢ƒå­˜åœ¨APIå·®å¼‚
- éœ€è¦åœ¨å¼€å‘åˆæœŸè¿›è¡Œç¯å¢ƒå…¼å®¹æ€§æµ‹è¯•
- å…³é”®å·¥å…·å‡½æ•°åº”è¯¥ä¼˜å…ˆæµ‹è¯•

---

### é—®é¢˜ #007: å®¶åº­é¡µé¢ç©ºæŒ‡é’ˆé”™è¯¯
**å‘ç°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 14:30
**é”™è¯¯ä¿¡æ¯**: `TypeError: Cannot read property 'role' of null`
**ä¸¥é‡ç¨‹åº¦**: ä¸­ - å½±å“å®¶åº­ç®¡ç†åŠŸèƒ½

**é—®é¢˜åŸå› **:
å½“ç”¨æˆ·æœªåŠ å…¥å®¶åº­æ—¶ï¼Œ`familyInfo`ä¸ºnullï¼Œä½†ä»£ç ä¸­ç›´æ¥è®¿é—®`this.data.familyInfo.role`ç­‰å±æ€§ï¼Œå¯¼è‡´ç©ºæŒ‡é’ˆé”™è¯¯ã€‚

**å½±å“èŒƒå›´**:
- å®¶åº­ç®¡ç†é¡µé¢æ— æ³•æ­£å¸¸åŠ è½½
- æƒé™è®¾ç½®åŠŸèƒ½å¤±æ•ˆ
- å®¶åº­ç å¤åˆ¶å’Œåˆ†äº«åŠŸèƒ½æŠ¥é”™
- UIæ˜¾ç¤ºå¼‚å¸¸ï¼Œæ–‡å­—é”™ä½

**è§£å†³æ–¹æ¡ˆ**:
1. æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…ç›´æ¥è®¿é—®nullå¯¹è±¡çš„å±æ€§
2. æ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘ï¼Œè®¾ç½®é»˜è®¤çŠ¶æ€
3. ä¼˜åŒ–UIæ˜¾ç¤ºï¼Œä¸ºæœªåŠ å…¥å®¶åº­çŠ¶æ€æ·»åŠ ä¸“é—¨çš„ç•Œé¢
4. å®Œå–„æ•°æ®åŠ è½½é€»è¾‘ï¼Œæ­£ç¡®å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

**ä¿®å¤ä»£ç **:
```javascript
// ä¿®å¤å‰ - ç©ºæŒ‡é’ˆé”™è¯¯
setPermissions() {
  const { role } = this.data.familyInfo; // familyInfoå¯èƒ½ä¸ºnull
  this.setData({
    canInvite: role === 'owner' || role === 'admin'
  });
}

// ä¿®å¤å - å®‰å…¨è®¿é—®
setPermissions() {
  const familyInfo = this.data.familyInfo;
  const role = familyInfo ? familyInfo.role : null;
  this.setData({
    canInvite: role === 'owner' || role === 'admin'
  });
}
```

**UIæ”¹è¿›**:
```html
<!-- æ·»åŠ æ¡ä»¶æ¸²æŸ“ -->
<view wx:if="{{familyInfo}}" class="card family-info-card">
  <!-- å®¶åº­ä¿¡æ¯ -->
</view>

<view wx:if="{{!familyInfo}}" class="card no-family-card">
  <!-- æœªåŠ å…¥å®¶åº­æç¤º -->
</view>
```

**éªŒè¯ç»“æœ**: âœ… å·²ä¿®å¤ï¼Œå®¶åº­é¡µé¢æ­£å¸¸æ˜¾ç¤ºï¼ŒUIå¸ƒå±€æ­£ç¡®

---

## é¢„é˜²æªæ–½

### 1. é”™è¯¯å¤„ç†æ ‡å‡†åŒ–
- æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½åŒ…å«try-catché”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„é”™è¯¯æç¤ºæ ¼å¼å’Œç”¨æˆ·å‹å¥½ä¿¡æ¯
- ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•æœºåˆ¶

### 2. æ•°æ®æ ¼å¼éªŒè¯
- æœåŠ¡å±‚ç»Ÿä¸€è¿”å›æ ¼å¼è§„èŒƒ
- é¡µé¢å±‚æ•°æ®ç±»å‹æ£€æŸ¥å’Œé»˜è®¤å€¼å¤„ç†
- APIå“åº”æ•°æ®ç»“æ„éªŒè¯

### 3. èµ„æºåŠ è½½ä¼˜åŒ–
- æœ¬åœ°èµ„æºä¼˜å…ˆï¼Œåœ¨çº¿èµ„æºä½œä¸ºå¤‡é€‰
- å›¾ç‰‡å’Œå­—ä½“åŠ è½½å¤±è´¥çš„å›é€€æ–¹æ¡ˆ
- èµ„æºé¢„åŠ è½½å’Œç¼“å­˜ç­–ç•¥

### 4. ç»„ä»¶ä¾èµ–ç®¡ç†
- å‡å°‘å¯¹ç¬¬ä¸‰æ–¹ç»„ä»¶çš„å¼ºä¾èµ–
- åŸç”ŸAPIä¼˜å…ˆï¼Œç»„ä»¶APIä½œä¸ºå¢å¼º
- ç»„ä»¶ç‰ˆæœ¬é”å®šå’Œå…¼å®¹æ€§æµ‹è¯•

## æµ‹è¯•å»ºè®®

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•
- å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- é›†æˆæµ‹è¯•éªŒè¯æ•°æ®æµå®Œæ•´æ€§
- UIæµ‹è¯•ç¡®ä¿ç•Œé¢äº¤äº’æ­£å¸¸

### 2. é”™è¯¯åœºæ™¯æµ‹è¯•
- ç½‘ç»œæ–­å¼€æƒ…å†µä¸‹çš„åŠŸèƒ½è¡¨ç°
- æ•°æ®åº“å¼‚å¸¸æ—¶çš„é”™è¯¯æ¢å¤
- èµ„æºåŠ è½½å¤±è´¥çš„å›é€€æœºåˆ¶

### 3. æ€§èƒ½ç›‘æ§
- é¡µé¢åŠ è½½æ—¶é—´ç›‘æ§
- å†…å­˜ä½¿ç”¨æƒ…å†µè·Ÿè¸ª
- ç½‘ç»œè¯·æ±‚æ€§èƒ½åˆ†æ

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025å¹´9æœˆ7æ—¥ 14:00
**ç»´æŠ¤äººå‘˜**: CodeBuddy AI
**ä¸‹æ¬¡å®¡æŸ¥**: 2025å¹´9æœˆ14æ—¥