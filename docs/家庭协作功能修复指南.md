# 家庭协作功能修复指南

## 问题总结

### 已修复的问题
1. ✅ **toast.showToast 方法调用错误** - 已改为使用 `wx.showToast`
2. ✅ **数据库集合不存在错误** - 已添加自动初始化功能
3. ✅ **用户登录状态检查** - 已优化错误处理逻辑
4. ✅ **方法调用适配** - 已统一返回格式

### 新增功能
1. ✅ **自动数据库初始化** - 首次使用时自动创建必要的数据库集合
2. ✅ **友好错误处理** - 不再因为数据库问题导致页面崩溃
3. ✅ **云函数支持** - 添加了 `initDatabase` 云函数

## 使用步骤

### 1. 部署云函数
首先需要部署数据库初始化云函数：

```bash
# 在微信开发者工具中
1. 右键点击 cloudfunctions/initDatabase 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

### 2. 测试家庭协作功能
1. 打开小程序
2. 进入"我的"页面
3. 点击"家庭协作"卡片
4. 尝试创建家庭或加入家庭

### 3. 预期行为
- **首次使用**：系统会自动显示"正在初始化数据库..."提示
- **初始化成功**：可以正常创建和加入家庭
- **错误处理**：如果出现网络问题，会显示友好的错误提示

## 技术细节

### 数据库集合结构
系统会自动创建以下集合：
- `families` - 家庭信息
- `family_members` - 家庭成员
- `family_invites` - 家庭邀请
- `transactions` - 交易记录
- `categories` - 分类信息
- `accounts` - 账户信息

### 错误处理机制
- **数据库集合不存在 (errCode: -502005)** → 自动初始化
- **用户未登录** → 返回友好提示而不是崩溃
- **网络错误** → 显示重试提示

### 服务调用格式
所有家庭服务现在返回统一格式：
```javascript
{
  success: boolean,
  code?: string,
  message?: string,
  data?: object
}
```

## 故障排除

### 如果仍然出现数据库错误
1. 检查云开发环境是否正确配置
2. 确认 `initDatabase` 云函数已正确部署
3. 检查网络连接是否正常

### 如果初始化失败
1. 在微信开发者工具控制台查看详细错误信息
2. 确认云开发权限设置正确
3. 重新部署云函数

### 联系支持
如果问题仍然存在，请提供：
1. 错误截图
2. 控制台错误日志
3. 操作步骤描述

## 更新日志

### 2025-09-07
- 修复 toast 方法调用错误
- 添加数据库自动初始化功能
- 优化错误处理逻辑
- 统一服务返回格式
- 添加云函数支持