# 趋势图诊断报告

## 问题描述

用户反馈自定义统计功能中存在以下问题：
1. 趋势明细数据中日期列为空
2. 所有趋势数据（收入/支出/结余）均为0
3. 图表显示效果存在直线图标与横坐标轴重叠的问题

## 问题分析

### 可能原因
1. **数据源问题**: 后端报表服务在处理自定义周期时可能存在数据丢失
2. **月份数据缺失**: 自定义时间范围内的月份数据未完整生成
3. **图表布局问题**: 横坐标轴与图表元素位置计算不当导致重叠

### 技术细节
- 自定义统计依赖`services/report.js`中的`generateReport`函数
- 前端数据处理在`pages/reports/reports-simple.js`的`fillTrendData`方法
- 图表绘制使用Canvas API，涉及坐标计算和元素定位

## 优化方案

### 1. 数据处理优化
- 增加详细的调试日志，追踪数据处理的每个步骤
- 为自定义周期添加完整的月份填充逻辑
- 确保所有月份都有对应的数据点，避免图表断线
- **新增**: 本地交易数据验证，当后端数据为空时从本地计算月度统计

### 2. 图表布局调整
- 调整图表底部padding从60增加到80，为标签留出更多空间
- 简化月份标签格式，使用MM格式避免重叠
- 优化坐标轴和标签的位置关系
- **新增**: 横坐标添加短竖线标注，提升可读性

### 3. 资产数据补充
- 为0值月份补充当前资产总额，避免资产线断线
- 确保资产数据的连续性和完整性

### 4. 数据源诊断增强
- 检查后端返回数据的完整性
- 验证自定义日期参数的有效性
- 提供详细的错误原因分析和本地数据对比

## 实施步骤

1. **调试日志增强**: 在数据处理关键节点添加console.log
2. **图表布局调整**: 修改drawDualAxisChart方法的padding和标签设置
3. **数据填充完善**: 改进fillTrendData函数的月份生成逻辑
4. **横坐标优化**: 添加短竖线标注和月份标签显示
5. **数据源诊断**: 增加本地数据验证和错误原因分析
6. **测试验证**: 在不同时间范围下测试图表显示效果

## 最新更新 (2025/9/9)

### 横坐标显示优化
- 在X轴标签下方添加短竖线标注，提升月份标识的清晰度
- 调整标签位置，避免与图表元素重叠

### 数据诊断增强
- 增加后端数据空值检测和原因分析
- 添加本地交易记录验证机制
- 当后端数据缺失时，尝试从本地交易记录计算月度统计
- 提供详细的调试信息，便于问题定位

### 趋势明细数据修复 (2025/9/9 晚间)
- **自定义统计日期显示**: 为所有趋势数据添加`dateDisplay`字段，确保明细表格正确显示日期
- **按年统计月份排序**: 修复按年统计时横坐标月份显示顺序，按月份数值排序
- **资产总额图标布局**: 调整图例中"资产总额"位置从x:240改为x:220，避免显示不全

### 技术实现细节
1. **dateDisplay字段补充**: 在数据填充时为每个月份数据添加格式化的日期显示
2. **月份排序逻辑**: 按年统计时对trendData按month字段排序
3. **图例位置优化**: 微调资产总额图标位置，提升UI美观性

### 图例遮挡和横坐标修复 (2025/9/9 深夜)
- **图例间距优化**: 重新调整图例项间距，避免"资产总额"遮挡"结余"
  - 收入: x:50, 支出: x:110, 结余: x:170, 资产总额: x:230
- **按年统计数据结构修复**: 在后端报表服务中为按年统计数据添加`year`和`month`字段
  - 修复`services/report.js`中按年统计的趋势数据生成逻辑
  - 确保前端排序逻辑能正确识别月份信息
- **调试日志增强**: 为按年统计添加详细的排序前后对比日志

## 预期效果

1. **数据完整性**: 自定义周期显示完整的月份数据，无缺失
2. **图表清晰度**: 横坐标标签清晰可读，无重叠现象
3. **调试便利性**: 详细的日志信息便于问题定位和排查
4. **用户体验**: 趋势图显示准确、美观，符合用户预期

## 验证方法

1. 选择自定义时间范围（如2024年9月-2025年9月）
2. 查看控制台日志，确认数据处理流程
3. 检查趋势图是否显示完整月份
4. 验证横坐标标签是否清晰无重叠
5. 确认趋势明细数据的准确性