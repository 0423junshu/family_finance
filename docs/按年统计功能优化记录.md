# 按年统计功能优化记录

## 优化时间
2025年9月6日

## 优化需求
优化按年统计功能，确保分类统计准确无误。调整趋势图横坐标仅显示当前有效月份，自动过滤未来月份数据。例如统计2025年数据时，若当前未到10-12月，则趋势图及数据明细中不应显示这些未来月份。同时确保统计逻辑正确，各分类数据汇总精确。

## 问题分析

### 1. 趋势图显示未来月份问题
**问题描述**：按年统计时，趋势图固定显示12个月，包括未来月份，导致数据不准确。

**具体表现**：
- 统计2025年数据时，即使当前只到9月，趋势图仍显示10-12月
- 未来月份显示为0值，影响数据分析的准确性
- 用户可能误解为这些月份确实没有数据

### 2. 分类统计逻辑需要进一步优化
**问题描述**：虽然之前已修复分类数据不准确问题，但需要确保逻辑完全正确。

## 解决方案

### 1. 动态月份范围控制

#### 核心逻辑
```javascript
const now = new Date();
const currentYearNow = now.getFullYear();
const currentMonthNow = now.getMonth(); // 0-based

// 确定显示的月份范围：如果是当前年份，只显示到当前月份；否则显示全年12个月
const maxMonth = (currentYear === currentYearNow) ? (currentMonthNow + 1) : 12;
```

#### 应用场景
1. **当前年份统计**：只显示1月到当前月份
2. **历史年份统计**：显示完整的12个月
3. **未来年份统计**：理论上不应存在，但如果存在则显示12个月

### 2. 修改位置

#### services/report.js - 年度报表趋势数据生成
```javascript
// 修改前：固定显示12个月
for (let i = 0; i < 12; i++) {
  // ...生成趋势数据
}

// 修改后：动态确定月份范围
const maxMonth = (currentYear === currentYearNow) ? (currentMonthNow + 1) : 12;
for (let i = 0; i < maxMonth; i++) {
  // ...生成趋势数据
}
```

#### services/report.js - generateAssetTrendData 函数
```javascript
// 修改前：年度趋势固定12个月
} else if (dateRange === 'year') {
  for (let i = 0; i < 12; i++) {
    // ...
  }
}

// 修改后：年度趋势动态月份
} else if (dateRange === 'year') {
  const now = new Date();
  const currentYearNow = now.getFullYear();
  const currentMonthNow = now.getMonth();
  const maxMonth = (year === currentYearNow) ? (currentMonthNow + 1) : 12;
  
  for (let i = 0; i < maxMonth; i++) {
    // ...
  }
}
```

## 修改文件清单

### services/report.js
1. **年度报表趋势数据生成逻辑**
   - 位置：generateReport 函数中的年度统计部分
   - 修改：添加动态月份范围控制

2. **generateAssetTrendData 函数**
   - 位置：年度趋势数据生成部分
   - 修改：添加相同的动态月份范围控制

## 优化效果

### 1. 数据准确性提升
- **当前年份统计**：只显示已发生的月份数据
- **历史年份统计**：保持完整的12个月显示
- **避免误导**：不再显示未来月份的0值数据

### 2. 用户体验改善
- **直观性**：趋势图更加直观，只显示有意义的数据点
- **准确性**：用户能够准确理解当前年份的实际数据情况
- **一致性**：趋势图和数据明细表格保持一致

### 3. 逻辑完整性
- **边界处理**：正确处理年份边界情况
- **兼容性**：保持与现有功能的完全兼容
- **扩展性**：为未来可能的需求变更预留空间

## 测试验证

### 功能测试
1. **当前年份测试**
   - 统计2025年数据（当前9月）
   - 验证趋势图只显示1-9月
   - 验证数据明细表格只显示1-9月

2. **历史年份测试**
   - 统计2024年数据
   - 验证趋势图显示完整12个月
   - 验证数据准确性

3. **跨年测试**
   - 在年末（12月）测试当前年份统计
   - 在年初（1月）测试当前年份统计
   - 验证月份范围计算正确

### 边界测试
1. **月份边界**：测试月初、月末的统计结果
2. **年份边界**：测试跨年情况的处理
3. **数据为空**：测试没有数据的月份显示

## 性能影响
- **计算量减少**：当前年份统计时，减少了未来月份的无效计算
- **数据传输优化**：减少了不必要的数据传输
- **渲染性能**：趋势图渲染点数减少，性能略有提升

## 后续优化建议
1. **季度统计**：考虑添加季度统计功能，应用相同的动态范围逻辑
2. **周统计**：如需要周统计，也应考虑类似的优化
3. **预测功能**：未来可考虑添加基于历史数据的趋势预测

## 关联文档
- 报表页面优化记录.md
- 需求文档：资产与报表：历史月份资产快照与统计修复
- API文档：services/report.js 接口说明