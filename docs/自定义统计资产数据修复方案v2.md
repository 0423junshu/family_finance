# 自定义统计资产数据修复方案 v2.0

## 问题重新分析

### 用户反馈
- 按年统计的数据被错误修改（原本正确）
- 自定义统计的资产数据问题仍未解决
- 需要确保两种统计模式的数据获取逻辑保持一致

### 根本原因
1. **后端修改影响范围过大**：修改 `generateMonthlyAssetData` 影响了所有统计模式
2. **数据源不一致**：按年统计和自定义统计可能使用不同的数据处理逻辑
3. **前端数据覆盖**：前端可能错误覆盖了后端提供的正确数据

## 修复策略 v2.0

### 1. 恢复后端原始状态
- 回退 `generateMonthlyAssetData` 函数的修改
- 移除历史计算相关函数
- 确保按年统计恢复正常

### 2. 前端层面解决自定义统计问题
- 专门针对自定义统计模式优化数据处理
- 保持按年统计的数据处理逻辑不变
- 通过条件判断区分不同统计模式的处理方式

### 3. 统一数据获取逻辑
- 确保两种模式都调用相同的后端服务
- 在前端层面根据模式类型进行差异化处理
- 避免数据覆盖和不一致问题

## 实施方案

### 阶段1：后端恢复（已完成）
- ✅ 恢复 `generateMonthlyAssetData` 原始实现
- ✅ 移除历史计算函数
- ✅ 确保模块导出正确

### 阶段2：前端优化（进行中）
- 分析自定义统计的数据处理流程
- 识别资产数据异常的具体环节
- 实施针对性修复方案

### 阶段3：验证测试
- 确认按年统计数据正确
- 验证自定义统计资产数据准确性
- 对比两种模式的数据一致性

## 技术要点

### 数据流分析
1. **后端服务调用**：`reportService.generateReport(params)`
2. **数据处理**：`processReportData(reportData)`
3. **数据增强**：`enhanceCategoryStats(processedData)`
4. **唯一键添加**：`addUniqueKeys(enhancedData)`

### 关键修复点
- 在 `processReportData` 中区分统计模式
- 对自定义统计的资产数据进行特殊处理
- 保持按年统计的处理逻辑不变

## 预期结果
1. 按年统计恢复正常显示
2. 自定义统计显示准确的历史资产数据
3. 两种模式的数据获取逻辑保持一致
4. 不再出现数据覆盖问题